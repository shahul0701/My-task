<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow Pro - Company Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #1a2980;
            --secondary-color: #26d0ce;
            --accent-color: #00ff9d;
            --sidebar-width: 260px;
            --header-height: 70px;
            --transition-speed: 0.3s;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Dashboard Layout */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary-color) 0%, #0d1b5e 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all var(--transition-speed);
            z-index: 1000;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            transform: translateX(0);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sidebar-header .logo {
            font-size: 28px;
            color: var(--accent-color);
        }

        .company-info h2 {
            font-size: 18px;
            margin-bottom: 5px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .company-info p {
            font-size: 12px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .company-info i {
            color: var(--accent-color);
        }

        /* Navigation */
        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section h3 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 20px;
            margin-bottom: 15px;
            opacity: 0.7;
            font-weight: 500;
        }

        .nav-links {
            list-style: none;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all var(--transition-speed);
            border-left: 4px solid transparent;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--secondary-color);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-left-color: var(--accent-color);
        }

        .nav-link i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .nav-link span {
            font-size: 15px;
            font-weight: 500;
        }

        .badge {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: auto;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left var(--transition-speed);
            min-height: 100vh;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Header */
        .main-header {
            height: var(--header-height);
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all var(--transition-speed);
        }

        .menu-toggle:hover {
            background: rgba(26, 41, 128, 0.1);
        }

        .header-left h1 {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .breadcrumb {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .breadcrumb i {
            margin: 0 8px;
            font-size: 12px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        /* Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(26, 41, 128, 0.2);
        }

        .welcome-text h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .welcome-text p {
            opacity: 0.9;
            font-size: 16px;
        }

        /* Content Area */
        .content-area {
            padding: 0 30px 30px;
            min-height: calc(100vh - var(--header-height) - 30px);
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            transition: transform var(--transition-speed);
            cursor: pointer;
            border: 1px solid #e0e0e0;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .data-table th {
            text-align: left;
            padding: 15px;
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 2px solid #e9ecef;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #2639c3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 41, 128, 0.3);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            color: var(--primary-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            transition: color var(--transition-speed);
        }

        .close-modal:hover {
            color: #333;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Form Elements */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .input-group label.required::after {
            content: " *";
            color: #e74c3c;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all var(--transition-speed);
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 41, 128, 0.1);
        }

        /* Status Badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-active {
            background: #d5f4e6;
            color: #27ae60;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* Section Styling */
        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .section-header h2 {
            font-size: 22px;
            color: var(--primary-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all var(--transition-speed);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-speed);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn.edit {
            background: #3498db;
            color: white;
        }

        .action-btn.delete {
            background: #e74c3c;
            color: white;
        }

        .action-btn.view {
            background: #2ecc71;
            color: white;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 60px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h4 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }

        .empty-state p {
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            justify-content: center;
            padding: 30px;
        }

        .loading-spinner.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-header {
                padding: 0 15px;
            }
            
            .content-area {
                padding: 0 15px 15px;
            }
            
            .welcome-banner {
                margin: 15px;
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .header-right {
                display: none;
            }
        }

        /* Error Messages */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Success Messages */
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-building"></i>
                </div>
                <div class="company-info">
                    <h2 id="companyNameDisplay">Loading...</h2>
                    <p><i class="fas fa-user-shield"></i> <span id="roleDisplay">Company Owner</span></p>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav">
                <!-- Main Section -->
                <div class="nav-section">
                    <h3>Dashboard</h3>
                    <ul class="nav-links">
                        <li>
                            <button class="nav-link active" onclick="showSection('dashboard')">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Overview</span>
                            </button>
                        </li>
                        <li>
                            <button class="nav-link" onclick="showSection('analytics')">
                                <i class="fas fa-chart-line"></i>
                                <span>Analytics</span>
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Team Management -->
                <div class="nav-section">
                    <h3>Team Management</h3>
                    <ul class="nav-links">
                        <li>
                            <button class="nav-link" onclick="showSection('users')">
                                <i class="fas fa-users"></i>
                                <span>Users</span>
                                <span class="badge" id="usersCount">0</span>
                            </button>
                        </li>
                        <li>
                            <button class="nav-link" onclick="showSection('teams')">
                                <i class="fas fa-user-friends"></i>
                                <span>Teams</span>
                                <span class="badge" id="teamsCount">0</span>
                            </button>
                        </li>
                        <li>
                            <button class="nav-link" onclick="showSection('departments')">
                                <i class="fas fa-sitemap"></i>
                                <span>Departments</span>
                                <span class="badge" id="deptCount">0</span>
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Project Management -->
                <div class="nav-section">
                    <h3>Projects</h3>
                    <ul class="nav-links">
                        <li>
                            <button class="nav-link" onclick="showSection('projects')">
                                <i class="fas fa-project-diagram"></i>
                                <span>All Projects</span>
                                <span class="badge" id="projectsCount">0</span>
                            </button>
                        </li>
                        <li>
                            <button class="nav-link" onclick="showSection('tasks')">
                                <i class="fas fa-tasks"></i>
                                <span>Tasks</span>
                                <span class="badge" id="tasksCount">0</span>
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Settings -->
                <div class="nav-section">
                    <h3>Settings</h3>
                    <ul class="nav-links">
                        <li>
                            <button class="nav-link" onclick="showSection('settings')">
                                <i class="fas fa-cog"></i>
                                <span>Company Settings</span>
                            </button>
                        </li>
                        <li>
                            <button class="nav-link" onclick="showSection('billing')">
                                <i class="fas fa-credit-card"></i>
                                <span>Billing</span>
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Logout -->
                <div class="nav-section">
                    <ul class="nav-links">
                        <li>
                            <button class="nav-link" onclick="logout()" style="color: #e74c3c;">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 id="pageTitle">Company Dashboard</h1>
                        <div class="breadcrumb">
                            <span>Home</span>
                            <i class="fas fa-chevron-right"></i>
                            <span id="breadcrumbCurrent">Dashboard</span>
                        </div>
                    </div>
                </div>
                <div class="header-right">
                    <div id="currentUserInfo">
                        <!-- User info will be loaded here -->
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Loading Spinner -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                </div>

                <!-- Error Message -->
                <div class="error-message" id="errorMessage">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorText"></span>
                </div>

                <!-- Success Message -->
                <div class="success-message" id="successMessage">
                    <i class="fas fa-check-circle"></i>
                    <span id="successText"></span>
                </div>

                <!-- Dashboard Content (Default View) -->
                <div id="dashboardSection" class="section active">
                    <!-- Welcome Banner -->
                    <div class="welcome-banner">
                        <div class="welcome-text">
                            <h2>Welcome back, <span id="greetingName">Admin</span>!</h2>
                            <p>Manage your company teams, departments, and users from one place.</p>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="showSection('users')">
                                <i class="fas fa-user-plus"></i>
                                Add New User
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="dashboard-cards">
                        <div class="dashboard-card" onclick="showSection('users')">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3498db, #2980b9); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-users" style="font-size: 28px; color: white;"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 32px; margin-bottom: 5px;" id="totalUsersCount">0</h3>
                                    <p style="color: #666;">Total Users</p>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card" onclick="showSection('teams')">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #2ecc71, #27ae60); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user-friends" style="font-size: 28px; color: white;"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 32px; margin-bottom: 5px;" id="totalTeamsCount">0</h3>
                                    <p style="color: #666;">Total Teams</p>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card" onclick="showSection('departments')">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #9b59b6, #8e44ad); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-sitemap" style="font-size: 28px; color: white;"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 32px; margin-bottom: 5px;" id="totalDeptCount">0</h3>
                                    <p style="color: #666;">Departments</p>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card" onclick="showSection('projects')">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #e74c3c, #c0392b); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-project-diagram" style="font-size: 28px; color: white;"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 32px; margin-bottom: 5px;" id="totalProjectsCount">0</h3>
                                    <p style="color: #666;">Active Projects</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="section">
                        <div class="section-header">
                            <h2><i class="fas fa-history"></i> Recent Activity</h2>
                        </div>
                        <div id="recentActivity">
                            <!-- Activity will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Users Management Section -->
                <div id="usersSection" class="section" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-users"></i> Users Management</h2>
                        <button class="btn btn-primary" onclick="openAddUserModal()">
                            <i class="fas fa-user-plus"></i>
                            Add New User
                        </button>
                    </div>

                    <div class="tabs">
                        <button class="tab-btn active" onclick="showUserTab('all')">All Users</button>
                        <button class="tab-btn" onclick="showUserTab('active')">Active</button>
                        <button class="tab-btn" onclick="showUserTab('pending')">Pending</button>
                    </div>

                    <div id="allUsersTab" class="tab-content active">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Department</th>
                                    <th>Team</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <div id="activeUsersTab" class="tab-content">
                        <!-- Active users will be loaded here -->
                    </div>

                    <div id="pendingUsersTab" class="tab-content">
                        <!-- Pending users will be loaded here -->
                    </div>
                </div>

                <!-- Teams Management Section -->
                <div id="teamsSection" class="section" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-user-friends"></i> Teams Management</h2>
                        <button class="btn btn-primary" onclick="openAddTeamModal()">
                            <i class="fas fa-user-friends"></i>
                            Create New Team
                        </button>
                    </div>

                    <div id="teamsList">
                        <!-- Teams will be loaded here -->
                    </div>
                </div>

                <!-- Departments Management Section -->
                <div id="departmentsSection" class="section" style="display: none;">
                    <div class="section-header">
                        <h2><i class="fas fa-sitemap"></i> Departments Management</h2>
                        <button class="btn btn-primary" onclick="openAddDepartmentModal()">
                            <i class="fas fa-plus"></i>
                            Add Department
                        </button>
                    </div>

                    <div id="departmentsList">
                        <!-- Departments will be loaded here -->
                    </div>
                </div>

                <!-- Other sections will be added similarly -->
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Add User Modal -->
    <div class="modal-overlay" id="addUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add New User</h3>
                <button class="close-modal" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="input-group">
                        <label for="newFullName" class="required">Full Name</label>
                        <input type="text" id="newFullName" placeholder="Enter full name" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="newUserEmail" class="required">Email Address</label>
                        <input type="email" id="newUserEmail" placeholder="Enter email address" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="newUserRole" class="required">Role</label>
                        <select id="newUserRole" required>
                            <option value="">Select Role</option>
                            <option value="manager">Manager</option>
                            <option value="team_lead">Team Lead</option>
                            <option value="member">Team Member</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="newUserDepartment">Department</label>
                        <select id="newUserDepartment">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="newUserTeam">Team</label>
                        <select id="newUserTeam">
                            <option value="">Select Team</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveNewUser()">Create User</button>
            </div>
        </div>
    </div>

    <!-- Add Team Modal -->
    <div class="modal-overlay" id="addTeamModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-user-friends"></i> Create New Team</h3>
                <button class="close-modal" onclick="closeModal('addTeamModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addTeamForm">
                    <div class="input-group">
                        <label for="teamName" class="required">Team Name</label>
                        <input type="text" id="teamName" placeholder="Enter team name" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="teamDescription">Description</label>
                        <textarea id="teamDescription" placeholder="Enter team description" rows="3"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="teamDepartment">Department</label>
                        <select id="teamDepartment">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="teamLead">Team Lead</label>
                        <select id="teamLead">
                            <option value="">Select Team Lead</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addTeamModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveNewTeam()">Create Team</button>
            </div>
        </div>
    </div>

    <!-- Add Department Modal -->
    <div class="modal-overlay" id="addDepartmentModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-sitemap"></i> Add New Department</h3>
                <button class="close-modal" onclick="closeModal('addDepartmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addDepartmentForm">
                    <div class="input-group">
                        <label for="departmentName" class="required">Department Name</label>
                        <input type="text" id="departmentName" placeholder="Enter department name" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="departmentCode">Department Code</label>
                        <input type="text" id="departmentCode" placeholder="e.g., DEV, MKT, HR">
                    </div>
                    
                    <div class="input-group">
                        <label for="departmentHead">Department Head</label>
                        <select id="departmentHead">
                            <option value="">Select Department Head</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="departmentDescription">Description</label>
                        <textarea id="departmentDescription" placeholder="Enter department description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addDepartmentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveNewDepartment()">Create Department</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYhLNuJKj2ucwGimfddTfpTb32Y0c-bXg",
            authDomain: "mytask-96a79.firebaseapp.com",
            databaseURL: "https://mytask-96a79-default-rtdb.firebaseio.com",
            projectId: "mytask-96a79",
            storageBucket: "mytask-96a79.firebasestorage.app",
            messagingSenderId: "963509757773",
            appId: "1:963509757773:web:d9c81a108f5873702eb904",
            measurementId: "G-L9C1LTCZRN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global Variables
        let currentUser = null;
        let companyData = null;
        let companyUsers = [];
        let companyTeams = [];
        let companyDepartments = [];
        let companyProjects = [];

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if company user is logged in
            const sessionUser = sessionStorage.getItem("username");
            const userType = sessionStorage.getItem("userType");
            
            if (!sessionUser || userType !== "company") {
                // Redirect to company login if not logged in
                alert("Please login as company user");
                window.location.href = "company-login.html";
                return;
            }

            showLoading();
            
            try {
                // Load current user data
                await loadCurrentUser(sessionUser);
                
                // Check if user is company owner
                if (currentUser.role !== "company_admin" && currentUser.role !== "owner") {
                    alert("Access Denied. Only company owners can access this dashboard.");
                    window.location.href = "company-login.html";
                    return;
                }
                
                // Load all company data
                await loadCompanyData();
                
                // Update UI
                updateUI();
                
                // Setup event listeners
                setupEventListeners();
                
                hideLoading();
                
            } catch (error) {
                console.error("Error initializing dashboard:", error);
                showError("Failed to load dashboard data. Please refresh the page.");
                hideLoading();
            }
        });

        // Load current user data
        async function loadCurrentUser(username) {
            try {
                const querySnapshot = await db.collection("users")
                    .where("username", "==", username)
                    .where("userType", "==", "company")
                    .get();
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    currentUser = {
                        id: userDoc.id,
                        ...userDoc.data()
                    };
                    companyData = {
                        companyId: currentUser.companyId,
                        companyName: currentUser.companyName,
                        companyEmail: currentUser.companyEmail
                    };
                } else {
                    throw new Error("User not found");
                }
            } catch (error) {
                console.error("Error loading user:", error);
                throw error;
            }
        }

        // Load all company data
        async function loadCompanyData() {
            try {
                // Load company users
                const usersSnapshot = await db.collection("users")
                    .where("companyId", "==", currentUser.companyId)
                    .where("userType", "==", "company")
                    .get();
                
                companyUsers = [];
                usersSnapshot.forEach(doc => {
                    companyUsers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Load company teams
                const teamsSnapshot = await db.collection("teams")
                    .where("companyId", "==", currentUser.companyId)
                    .get();
                
                companyTeams = [];
                teamsSnapshot.forEach(doc => {
                    companyTeams.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Load company departments
                const deptSnapshot = await db.collection("departments")
                    .where("companyId", "==", currentUser.companyId)
                    .get();
                
                companyDepartments = [];
                deptSnapshot.forEach(doc => {
                    companyDepartments.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Load company projects
                const projectsSnapshot = await db.collection("projects")
                    .where("companyId", "==", currentUser.companyId)
                    .get();
                
                companyProjects = [];
                projectsSnapshot.forEach(doc => {
                    companyProjects.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
            } catch (error) {
                console.error("Error loading company data:", error);
                throw error;
            }
        }

        // Update UI with loaded data
        function updateUI() {
            // Update company info
            document.getElementById('companyNameDisplay').textContent = companyData.companyName || "Company";
            document.getElementById('roleDisplay').textContent = currentUser.role || "Owner";
            
            // Update greeting
            const greetingName = currentUser.contactPerson || currentUser.fullName || "Admin";
            document.getElementById('greetingName').textContent = greetingName.split(' ')[0];
            
            // Update counts
            updateCounts();
            
            // Populate tables
            populateUsersTable();
            populateTeamsList();
            populateDepartmentsList();
            populateRecentActivity();
            
            // Populate dropdowns in modals
            populateDepartmentDropdowns();
            populateTeamDropdowns();
            populateUserDropdowns();
        }

        // Update counts in sidebar and dashboard
        function updateCounts() {
            const totalUsers = companyUsers.length;
            const totalTeams = companyTeams.length;
            const totalDept = companyDepartments.length;
            const totalProjects = companyProjects.length;
            
            // Update sidebar badges
            document.getElementById('usersCount').textContent = totalUsers;
            document.getElementById('teamsCount').textContent = totalTeams;
            document.getElementById('deptCount').textContent = totalDept;
            document.getElementById('projectsCount').textContent = totalProjects;
            
            // Update dashboard cards
            document.getElementById('totalUsersCount').textContent = totalUsers;
            document.getElementById('totalTeamsCount').textContent = totalTeams;
            document.getElementById('totalDeptCount').textContent = totalDept;
            document.getElementById('totalProjectsCount').textContent = totalProjects;
        }

        // Populate users table
        function populateUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            
            if (companyUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-users-slash"></i>
                            <h4>No Users Found</h4>
                            <p>Add your first team member to get started</p>
                            <button class="btn btn-primary" onclick="openAddUserModal()">
                                <i class="fas fa-user-plus"></i>
                                Add User
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            companyUsers.forEach(user => {
                // Get department name
                const dept = companyDepartments.find(d => d.id === user.departmentId);
                const deptName = dept ? dept.name : 'Not assigned';
                
                // Get team name
                const team = companyTeams.find(t => t.id === user.teamId);
                const teamName = team ? team.name : 'Not assigned';
                
                // Status badge
                const statusClass = user.status === 'active' ? 'status-active' :
                                  user.status === 'pending' ? 'status-pending' : 'status-inactive';
                const statusText = user.status === 'active' ? 'Active' :
                                 user.status === 'pending' ? 'Pending' : 'Inactive';
                
                // User initials for avatar
                const initials = (user.fullName || 'UU')
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
                
                html += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="user-avatar">${initials}</div>
                                <div>
                                    <div style="font-weight: 500;">${user.fullName}</div>
                                    <div style="font-size: 12px; color: #666;">${user.role}</div>
                                </div>
                            </div>
                        </td>
                        <td>${user.email || user.companyEmail}</td>
                        <td>${user.role}</td>
                        <td>${deptName}</td>
                        <td>${teamName}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit" onclick="editUser('${user.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="action-btn delete" onclick="deleteUser('${user.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Populate teams list
        function populateTeamsList() {
            const container = document.getElementById('teamsList');
            
            if (companyTeams.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-friends"></i>
                        <h4>No Teams Created</h4>
                        <p>Create your first team to organize users</p>
                        <button class="btn btn-primary" onclick="openAddTeamModal()">
                            <i class="fas fa-user-friends"></i>
                            Create Team
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
            
            companyTeams.forEach(team => {
                // Count team members
                const memberCount = companyUsers.filter(u => u.teamId === team.id).length;
                
                // Get department name
                const dept = companyDepartments.find(d => d.id === team.departmentId);
                const deptName = dept ? dept.name : 'Not assigned';
                
                // Get team lead name
                const lead = companyUsers.find(u => u.id === team.teamLeadId);
                const leadName = lead ? lead.fullName : 'Not assigned';
                
                html += `
                    <div class="dashboard-card">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin-bottom: 5px;">${team.name}</h3>
                                <p style="color: #666; font-size: 14px;">${deptName}</p>
                            </div>
                            <span class="badge">${memberCount} members</span>
                        </div>
                        
                        <p style="color: #666; margin-bottom: 15px; font-size: 14px;">${team.description || 'No description'}</p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 12px; color: #999; margin-bottom: 2px;">Team Lead</div>
                                <div style="font-weight: 500;">${leadName}</div>
                            </div>
                        </div>
                        
                        <div class="action-buttons" style="justify-content: flex-end;">
                            <button class="action-btn edit" onclick="editTeam('${team.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete" onclick="deleteTeam('${team.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Populate departments list
        function populateDepartmentsList() {
            const container = document.getElementById('departmentsList');
            
            if (companyDepartments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-sitemap"></i>
                        <h4>No Departments Created</h4>
                        <p>Create departments to organize your company structure</p>
                        <button class="btn btn-primary" onclick="openAddDepartmentModal()">
                            <i class="fas fa-plus"></i>
                            Add Department
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
            
            companyDepartments.forEach(dept => {
                // Count department members
                const memberCount = companyUsers.filter(u => u.departmentId === dept.id).length;
                
                // Count teams in department
                const teamCount = companyTeams.filter(t => t.departmentId === dept.id).length;
                
                // Get department head name
                const head = companyUsers.find(u => u.id === dept.departmentHeadId);
                const headName = head ? head.fullName : 'Not assigned';
                
                html += `
                    <div class="dashboard-card">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin-bottom: 5px;">${dept.name}</h3>
                                ${dept.code ? `<p style="color: #666; font-size: 14px;">Code: ${dept.code}</p>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #999;">Members</div>
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">${memberCount}</div>
                            </div>
                        </div>
                        
                        <p style="color: #666; margin-bottom: 15px; font-size: 14px;">${dept.description || 'No description'}</p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 12px; color: #999; margin-bottom: 2px;">Department Head</div>
                                <div style="font-weight: 500;">${headName}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #999;">Teams</div>
                                <div style="font-size: 18px; font-weight: bold;">${teamCount}</div>
                            </div>
                        </div>
                        
                        <div class="action-buttons" style="justify-content: flex-end;">
                            <button class="action-btn edit" onclick="editDepartment('${dept.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete" onclick="deleteDepartment('${dept.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Populate recent activity
        function populateRecentActivity() {
            const container = document.getElementById('recentActivity');
            
            // Sample activities - in real app, fetch from activity log
            const activities = [
                {
                    type: 'user_added',
                    message: 'New user John Doe added to Development team',
                    time: '2 hours ago',
                    icon: 'fa-user-plus'
                },
                {
                    type: 'team_created',
                    message: 'New team "Frontend Developers" created',
                    time: '4 hours ago',
                    icon: 'fa-user-friends'
                },
                {
                    type: 'department_created',
                    message: 'New department "Engineering" created',
                    time: '1 day ago',
                    icon: 'fa-sitemap'
                }
            ];
            
            let html = '';
            activities.forEach(activity => {
                html += `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid #eee;">
                        <div style="width: 40px; height: 40px; background: #f8f9fa; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas ${activity.icon}" style="color: var(--primary-color);"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${activity.message}</div>
                            <div style="font-size: 12px; color: #999;">${activity.time}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Populate dropdowns in modals
        function populateDepartmentDropdowns() {
            const deptSelects = [
                'newUserDepartment',
                'teamDepartment',
                'departmentHead'
            ];
            
            deptSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Clear existing options except first
                    while (select.options.length > 1) select.remove(1);
                    
                    // Add department options
                    companyDepartments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        function populateTeamDropdowns() {
            const teamSelects = [
                'newUserTeam',
                'teamLead'
            ];
            
            teamSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Clear existing options except first
                    while (select.options.length > 1) select.remove(1);
                    
                    // Add team options
                    companyTeams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        select.appendChild(option);
                    });
                    
                    // For team lead, also add users
                    if (selectId === 'teamLead') {
                        companyUsers.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.fullName} (${user.role})`;
                            select.appendChild(option);
                        });
                    }
                }
            });
        }

        function populateUserDropdowns() {
            const userSelects = [
                'departmentHead'
            ];
            
            userSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Don't clear options if already populated by departments
                    if (selectId === 'departmentHead' && select.options.length > 1) return;
                    
                    // Add user options
                    companyUsers.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.fullName} (${user.role})`;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Show/Hide sections
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-area > .section');
            sections.forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active');
                
                // Add active class to corresponding nav link
                const navLink = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
                if (navLink) navLink.classList.add('active');
                
                // Update page title and breadcrumb
                updatePageTitle(sectionId);
            }
        }

        function updatePageTitle(sectionId) {
            const titles = {
                'dashboard': 'Dashboard',
                'users': 'Users Management',
                'teams': 'Teams Management',
                'departments': 'Departments Management',
                'projects': 'Projects',
                'analytics': 'Analytics',
                'settings': 'Settings',
                'billing': 'Billing'
            };
            
            const title = titles[sectionId] || 'Dashboard';
            document.getElementById('pageTitle').textContent = title;
            document.getElementById('breadcrumbCurrent').textContent = title;
        }

        // User tab switching
        function showUserTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show corresponding tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId + 'UsersTab').classList.add('active');
        }

        // Modal functions
        function openAddUserModal() {
            document.getElementById('addUserModal').classList.add('active');
        }

        function openAddTeamModal() {
            document.getElementById('addTeamModal').classList.add('active');
        }

        function openAddDepartmentModal() {
            document.getElementById('addDepartmentModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Save new user
        async function saveNewUser() {
            try {
                const fullName = document.getElementById('newFullName').value.trim();
                const email = document.getElementById('newUserEmail').value.trim();
                const role = document.getElementById('newUserRole').value;
                const departmentId = document.getElementById('newUserDepartment').value;
                const teamId = document.getElementById('newUserTeam').value;
                
                // Validation
                if (!fullName || !email || !role) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                if (!validateEmail(email)) {
                    showError('Please enter a valid email address');
                    return;
                }
                
                // Check if email already exists
                const emailExists = companyUsers.some(u => u.email === email);
                if (emailExists) {
                    showError('Email already registered in this company');
                    return;
                }
                
                showLoading();
                
                // Generate username from email
                const username = email.split('@')[0].toLowerCase();
                
                // Generate initial password
                const tempPassword = generatePassword(8);
                
                // Get department and team names
                const deptName = departmentId ? 
                    companyDepartments.find(d => d.id === departmentId)?.name : '';
                const teamName = teamId ? 
                    companyTeams.find(t => t.id === teamId)?.name : '';
                
                // Create user data
                const userData = {
                    username: username,
                    password: tempPassword,
                    fullName: fullName,
                    email: email,
                    role: role,
                    departmentId: departmentId || '',
                    department: deptName,
                    teamId: teamId || '',
                    team: teamName,
                    userType: 'company',
                    companyId: currentUser.companyId,
                    companyName: companyData.companyName,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Save to Firestore
                await db.collection("users").add(userData);
                
                // Refresh data
                await loadCompanyData();
                updateUI();
                
                closeModal('addUserModal');
                showSuccess(`User added successfully! Temporary password: ${tempPassword}`);
                
                // Clear form
                document.getElementById('addUserForm').reset();
                
                hideLoading();
                
            } catch (error) {
                console.error("Error saving user:", error);
                showError('Failed to add user. Please try again.');
                hideLoading();
            }
        }

        // Save new team
        async function saveNewTeam() {
            try {
                const name = document.getElementById('teamName').value.trim();
                const description = document.getElementById('teamDescription').value.trim();
                const departmentId = document.getElementById('teamDepartment').value;
                const teamLeadId = document.getElementById('teamLead').value;
                
                if (!name) {
                    showError('Please enter a team name');
                    return;
                }
                
                showLoading();
                
                // Get department name
                const deptName = departmentId ? 
                    companyDepartments.find(d => d.id === departmentId)?.name : '';
                
                // Create team data
                const teamData = {
                    name: name,
                    description: description,
                    departmentId: departmentId || '',
                    department: deptName,
                    teamLeadId: teamLeadId || '',
                    companyId: currentUser.companyId,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                await db.collection("teams").add(teamData);
                
                // Refresh data
                await loadCompanyData();
                updateUI();
                
                closeModal('addTeamModal');
                showSuccess('Team created successfully!');
                
                // Clear form
                document.getElementById('addTeamForm').reset();
                
                hideLoading();
                
            } catch (error) {
                console.error("Error saving team:", error);
                showError('Failed to create team. Please try again.');
                hideLoading();
            }
        }

        // Save new department
        async function saveNewDepartment() {
            try {
                const name = document.getElementById('departmentName').value.trim();
                const code = document.getElementById('departmentCode').value.trim();
                const headId = document.getElementById('departmentHead').value;
                const description = document.getElementById('departmentDescription').value.trim();
                
                if (!name) {
                    showError('Please enter a department name');
                    return;
                }
                
                showLoading();
                
                // Create department data
                const deptData = {
                    name: name,
                    code: code,
                    departmentHeadId: headId || '',
                    description: description,
                    companyId: currentUser.companyId,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                await db.collection("departments").add(deptData);
                
                // Refresh data
                await loadCompanyData();
                updateUI();
                
                closeModal('addDepartmentModal');
                showSuccess('Department created successfully!');
                
                // Clear form
                document.getElementById('addDepartmentForm').reset();
                
                hideLoading();
                
            } catch (error) {
                console.error("Error saving department:", error);
                showError('Failed to create department. Please try again.');
                hideLoading();
            }
        }

        // Edit functions (to be implemented)
        function editUser(userId) {
            const user = companyUsers.find(u => u.id === userId);
            if (user) {
                openAddUserModal();
                // Pre-fill form
                document.getElementById('newFullName').value = user.fullName;
                document.getElementById('newUserEmail').value = user.email;
                document.getElementById('newUserRole').value = user.role;
                document.getElementById('newUserDepartment').value = user.departmentId;
                document.getElementById('newUserTeam').value = user.teamId;
                
                // Change modal title
                document.querySelector('#addUserModal h3').innerHTML = '<i class="fas fa-edit"></i> Edit User';
                document.querySelector('#addUserModal .btn-primary').textContent = 'Update User';
                document.querySelector('#addUserModal .btn-primary').onclick = () => updateUser(userId);
            }
        }

        async function updateUser(userId) {
            // Implementation for updating user
            alert('Update functionality to be implemented');
        }

        function editTeam(teamId) {
            const team = companyTeams.find(t => t.id === teamId);
            if (team) {
                openAddTeamModal();
                // Pre-fill form
                document.getElementById('teamName').value = team.name;
                document.getElementById('teamDescription').value = team.description || '';
                document.getElementById('teamDepartment').value = team.departmentId;
                document.getElementById('teamLead').value = team.teamLeadId;
                
                // Change modal title
                document.querySelector('#addTeamModal h3').innerHTML = '<i class="fas fa-edit"></i> Edit Team';
                document.querySelector('#addTeamModal .btn-primary').textContent = 'Update Team';
                document.querySelector('#addTeamModal .btn-primary').onclick = () => updateTeam(teamId);
            }
        }

        async function updateTeam(teamId) {
            // Implementation for updating team
            alert('Update functionality to be implemented');
        }

        function editDepartment(deptId) {
            const dept = companyDepartments.find(d => d.id === deptId);
            if (dept) {
                openAddDepartmentModal();
                // Pre-fill form
                document.getElementById('departmentName').value = dept.name;
                document.getElementById('departmentCode').value = dept.code || '';
                document.getElementById('departmentHead').value = dept.departmentHeadId;
                document.getElementById('departmentDescription').value = dept.description || '';
                
                // Change modal title
                document.querySelector('#addDepartmentModal h3').innerHTML = '<i class="fas fa-edit"></i> Edit Department';
                document.querySelector('#addDepartmentModal .btn-primary').textContent = 'Update Department';
                document.querySelector('#addDepartmentModal .btn-primary').onclick = () => updateDepartment(deptId);
            }
        }

        async function updateDepartment(deptId) {
            // Implementation for updating department
            alert('Update functionality to be implemented');
        }

        // Delete functions
        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try {
                    showLoading();
                    await db.collection("users").doc(userId).delete();
                    await loadCompanyData();
                    updateUI();
                    showSuccess('User deleted successfully');
                    hideLoading();
                } catch (error) {
                    console.error("Error deleting user:", error);
                    showError('Failed to delete user');
                    hideLoading();
                }
            }
        }

        async function deleteTeam(teamId) {
            if (confirm('Are you sure you want to delete this team? This action cannot be undone.')) {
                try {
                    showLoading();
                    await db.collection("teams").doc(teamId).delete();
                    await loadCompanyData();
                    updateUI();
                    showSuccess('Team deleted successfully');
                    hideLoading();
                } catch (error) {
                    console.error("Error deleting team:", error);
                    showError('Failed to delete team');
                    hideLoading();
                }
            }
        }

        async function deleteDepartment(deptId) {
            if (confirm('Are you sure you want to delete this department? This action cannot be undone.')) {
                try {
                    showLoading();
                    await db.collection("departments").doc(deptId).delete();
                    await loadCompanyData();
                    updateUI();
                    showSuccess('Department deleted successfully');
                    hideLoading();
                } catch (error) {
                    console.error("Error deleting department:", error);
                    showError('Failed to delete department');
                    hideLoading();
                }
            }
        }

        // Helper functions
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function generatePassword(length) {
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let password = "";
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return password;
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }

        function showLoading() {
            document.getElementById('loadingSpinner').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.remove('active');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorDiv.classList.add('show');
            
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            
            successText.textContent = message;
            successDiv.classList.add('show');
            
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 5000);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.clear();
                window.location.href = 'company-login.html';
            }
        }

        function setupEventListeners() {
            // Close modals on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }
    </script>
</body>
</html>
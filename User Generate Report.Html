<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Generate Report</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- jsPDF, AutoTable, Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #e0f7fa, #ffffff);
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h1 {
      color: #16648d;
    }
    button {
      margin: 10px 10px 10px 0;
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #2a9d8f;
      color: white;
    }
    button:hover {
      background-color: #21867a;
    }
    .filters {
      margin-bottom: 20px;
    }
    .filters label {
      margin-right: 10px;
    }
    .hidden {
      display: none;
    }
    #loading {
      margin-top: 20px;
      font-style: italic;
    }
  </style>
</head>
<body>

<h1>User Task Report</h1>

<div class="filters">
  <label>
    Date Filter:
    <select id="dateFilter">
      <option value="all">All</option>
      <option value="thisMonth">This Month</option>
      <option value="lastMonth">Previous Month</option>
      <option value="custom">Custom Range</option>
    </select>
  </label>

  <span id="customDateInputs" class="hidden">
    <label>From: <input type="date" id="fromDate" /></label>
    <label>To: <input type="date" id="toDate" /></label>
  </span>
</div>

<button onclick="window.location.href='UserDashboard.html'">Home</button>
<button id="downloadCsvBtn" disabled>Download CSV</button>
<button id="downloadPdfBtn" disabled>Download PDF</button>

<div id="loading">Loading tasks for user...</div>

<script>
  const firebaseConfig = {
  apiKey: "AIzaSyDYhLNuJKj2ucwGimfddTfpTb32Y0c-bXg",
  authDomain: "mytask-96a79.firebaseapp.com",
  databaseURL: "https://mytask-96a79-default-rtdb.firebaseio.com",
  projectId: "mytask-96a79",
  storageBucket: "mytask-96a79.firebasestorage.app",
  messagingSenderId: "963509757773",
  appId: "1:963509757773:web:d9c81a108f5873702eb904",
  measurementId: "G-L9C1LTCZRN"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const username = sessionStorage.getItem("username") || "";
  const headers = [
    "SINO", "Company Name", "TYPE OF WORK", "ACCOUNT TYPE", "Accounts / Cards",
    "Task", "Status", "Owner", "Due date", "Assigned By",
    "Time Started", "Time End", "Total Pause Hours", "Total Work Hours", "Remarks"
  ];
  let allTasks = [];

  async function loadTasks() {
    if (!username) {
      document.getElementById('loading').textContent = 'User not logged in.';
      return;
    }

    try {
      const snapshot = await db.collection('tasks').where("Owner", "==", username).get();
      allTasks = [];

      snapshot.forEach(doc => {
        const data = { id: doc.id, ...doc.data() };
        if (data["Due date"]?.seconds) {
          data["Due date"] = new Date(data["Due date"].seconds * 1000);
        } else if (typeof data["Due date"] === 'string') {
          data["Due date"] = new Date(data["Due date"]);
        }
        allTasks.push(data);
      });

      document.getElementById('loading').textContent = `Loaded ${allTasks.length} tasks for ${username}.`;
      document.getElementById('downloadCsvBtn').disabled = false;
      document.getElementById('downloadPdfBtn').disabled = false;
    } catch (err) {
      console.error(err);
      document.getElementById('loading').textContent = 'Error loading tasks.';
    }
  }

  function formatDate(date) {
    return date instanceof Date && !isNaN(date) ? date.toISOString().split("T")[0] : "";
  }

  function isWithinRange(date, start, end) {
    return date instanceof Date && !isNaN(date) && date >= start && date <= end;
  }

  function applyFilters() {
    const filter = document.getElementById('dateFilter').value;
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    const now = new Date();
    let filtered = [...allTasks];

    if (filter === 'thisMonth') {
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      filtered = filtered.filter(task => isWithinRange(task["Due date"], start, end));
    } else if (filter === 'lastMonth') {
      const start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const end = new Date(now.getFullYear(), now.getMonth(), 0);
      filtered = filtered.filter(task => isWithinRange(task["Due date"], start, end));
    } else if (filter === 'custom' && fromDate && toDate) {
      const start = new Date(fromDate);
      const end = new Date(toDate);
      filtered = filtered.filter(task => isWithinRange(task["Due date"], start, end));
    }

    return filtered;
  }

  function escapeCSV(value) {
    if (!value) return "";
    const val = String(value);
    return /[",\n]/.test(val) ? `"${val.replace(/"/g, '""')}"` : val;
  }

  function downloadCSV(tasks) {
    if (tasks.length === 0) return alert("No tasks to export.");
    const csvRows = [headers.join(",")];
    tasks.forEach((task, i) => {
      const row = [
        i + 1,
        task["Existing Company Name"] || "",
        task["TYPE OF WORK"] || "",
        task["ACCOUNT TYPE"] || "",
        task["Accounts / Cards"] || "",
        task["Task"] || "",
        task["Status"] || "",
        task["Owner"] || "",
        formatDate(task["Due date"]),
        task["Assigned By"] || "",
        task["TimeStarted"] || task["Time Start"] || "",
        task["TimeEnd"] || task["Time End"] || "",
        task["TotalPauseHours"] || task["TOTAL OUT OF HOURS"] || "",
        task["TotalWorkHours"] || task["Total Work Hours"] || "",
        task["Remarks"] || task["Remarks (New)"] || ""
      ].map(escapeCSV);
      csvRows.push(row.join(","));
    });
    const blob = new Blob([csvRows.join("\n")], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "user_tasks_report.csv";
    a.click();
  }

  async function downloadPDF(tasks) {
    if (tasks.length === 0) return alert("No tasks to export.");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "landscape" });
    const pageWidth = doc.internal.pageSize.getWidth();
    const centerX = pageWidth / 2;

    // Page 1: Cover
    doc.setFontSize(30);
  doc.text("Task Report", centerX, 60, { align: "center" });
    doc.setFontSize(18);
doc.text(`Generated for: ${username}`, centerX, 85, { align: "center" });

    doc.addPage();

    // Page 2: Summary
    const total = tasks.length;
    const completed = tasks.filter(t => t.Status?.toLowerCase() === "complete").length;
    const pending = total - completed;
    const totalWorkHours = tasks.reduce((sum, task) => {
      const h = parseFloat(task["TotalWorkHours"] || task["Total Work Hours"]);
      return sum + (isNaN(h) ? 0 : h);
    }, 0);

    const summary = [
      ["Total Tasks", total],
      ["Completed Tasks", completed],
      ["Pending Tasks", pending],
      ["Total Work Hours", totalWorkHours.toFixed(2)]
    ];

    doc.setFontSize(20);
    doc.text("Summary Report", centerX, 20, { align: "center" });
    doc.autoTable({
      startY: 30,
      head: [["Metric", "Value"]],
      body: summary,
      styles: { fontSize: 14 },
      headStyles: { fillColor: [22, 160, 133] },
      margin: { left: 60, right: 60 }
    });
    doc.addPage();

    // Page 3: Charts
    const container = document.createElement("div");
    container.style.position = "fixed";
    container.style.left = "-10000px";
    document.body.appendChild(container);

    const createChartCanvas = () => {
      const canvas = document.createElement("canvas");
      canvas.width = 400;
      canvas.height = 250;
      canvas.style.cursor = "pointer";
      canvas.addEventListener("click", () => window.location.href = "index.html");
      container.appendChild(canvas);
      return canvas;
    };

    const c1 = createChartCanvas(), c2 = createChartCanvas(), c3 = createChartCanvas(), c4 = createChartCanvas();

    const chart1 = new Chart(c1, {
      type: "bar",
      data: {
        labels: ["Completed", "Pending"],
        datasets: [{ data: [completed, pending], backgroundColor: ["#2a9d8f", "#e76f51"] }]
      },
      options: { responsive: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    const workTypes = {}, assignedBys = {}, hoursByDate = {};
    tasks.forEach(t => {
      workTypes[t["TYPE OF WORK"] || "Unknown"] = (workTypes[t["TYPE OF WORK"] || "Unknown"] || 0) + 1;
      assignedBys[t["Assigned By"] || "Unknown"] = (assignedBys[t["Assigned By"] || "Unknown"] || 0) + 1;
      const date = formatDate(t["Due date"]);
      const h = parseFloat(t["TotalWorkHours"] || t["Total Work Hours"]) || 0;
      hoursByDate[date] = (hoursByDate[date] || 0) + h;
    });

    new Chart(c2, {
      type: "pie",
      data: {
        labels: Object.keys(workTypes),
        datasets: [{ data: Object.values(workTypes), backgroundColor: ["#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51"] }]
      },
      options: { responsive: false, plugins: { legend: { position: "right" } } }
    });

    new Chart(c3, {
      type: "line",
      data: {
        labels: Object.keys(hoursByDate).sort(),
        datasets: [{ data: Object.values(hoursByDate), label: "Work Hours", borderColor: "#2a9d8f", backgroundColor: "#2a9d8f33", fill: true }]
      },
      options: { responsive: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });

    new Chart(c4, {
      type: "bar",
      data: {
        labels: Object.keys(assignedBys),
        datasets: [{ data: Object.values(assignedBys), label: "Assigned By", backgroundColor: "#e76f51" }]
      },
      options: { responsive: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    await new Promise(r => setTimeout(r, 1000)); // Wait for rendering

    [c1, c2, c3, c4].forEach((canvas, i) => {
      const x = 20 + (i % 2) * 110;
      const y = 40 + Math.floor(i / 2) * 80;
      const img = canvas.toDataURL("image/png");
      doc.addImage(img, "PNG", x, y, 90, 60);
    });

    document.body.removeChild(container);
    doc.addPage();

    const body = tasks.map((task, i) => [
      i + 1,
      task["Existing Company Name"] || "",
      task["TYPE OF WORK"] || "",
      task["ACCOUNT TYPE"] || "",
      task["Accounts / Cards"] || "",
      task["Task"] || "",
      task["Status"] || "",
      task["Owner"] || "",
      formatDate(task["Due date"]),
      task["Assigned By"] || "",
      task["Time Start"] || task["TimeStarted"] || "",
      task["Time End"] || task["TimeEnd"] || "",
      task["TOTAL OUT OF HOURS"] || task["TotalPauseHours"] || "",
      task["Total Work Hours"] || task["TotalWorkHours"] || "",
      task["Remarks (New)"] || task["Remarks"] || ""
    ]);

    doc.autoTable({
      head: [headers],
      body: body,
      styles: { fontSize: 7 },
      headStyles: { fillColor: [22, 160, 133] },
      startY: 20,
      margin: { left: 10, right: 10 },
      pageBreak: 'auto'
    });

    doc.save("user_tasks_report.pdf");
  }

  document.getElementById("downloadCsvBtn").addEventListener("click", () => {
    const filtered = applyFilters();
    downloadCSV(filtered);
  });

  document.getElementById("downloadPdfBtn").addEventListener("click", () => {
    const filtered = applyFilters();
    downloadPDF(filtered);
  });

  document.getElementById("dateFilter").addEventListener("change", (e) => {
    document.getElementById("customDateInputs").classList.toggle("hidden", e.target.value !== "custom");
  });

  window.onload = loadTasks;
</script>
</body>
</html>

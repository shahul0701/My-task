<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - Complete Data View</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF for PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #2c3e50;
    }

    /* Topbar */
    .topbar {
      height: 70px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 100;
    }

    .topbar .left {
      display: flex;
      align-items: center;
      gap: 25px;
    }

    .topbar .left a {
      color: #2c3e50;
      font-weight: 600;
      text-decoration: none;
      font-size: 16px;
      padding: 10px 20px;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      transition: all 0.3s ease;
    }

    .topbar .left a:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    #dateTime {
      font-weight: 600;
      font-size: 16px;
      color: #2c3e50;
    }

    .profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .profile img {
      border-radius: 50%;
      width: 45px;
      height: 45px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .profile-name {
      font-weight: 600;
      color: #2c3e50;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      width: 250px;
      height: calc(100vh - 70px);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      padding: 20px 0;
      z-index: 99;
      overflow-y: auto;
    }

    .sidebar-toggle {
      position: fixed;
      top: 80px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 101;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      margin-bottom: 5px;
    }

    .sidebar a {
      display: block;
      padding: 15px 25px;
      color: #2c3e50;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: rgba(102, 126, 234, 0.1);
      border-left-color: #667eea;
      color: #667eea;
    }

    /* Main Content */
    .main-content {
      margin: 90px 30px 30px 280px;
      padding: 30px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      min-height: calc(100vh - 120px);
      transition: margin-left 0.3s ease;
    }

    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: #2c3e50;
    }

    .page-subtitle {
      color: #7f8c8d;
      margin-top: 5px;
    }

    .export-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .export-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .export-excel {
      background: linear-gradient(135deg, #217346, #27ae60);
      color: white;
    }

    .export-pdf {
      background: linear-gradient(135deg, #c0392b, #e74c3c);
      color: white;
    }

    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    /* Quick Stats */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      border-left: 5px solid #667eea;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #7f8c8d;
      font-weight: 600;
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .chart-container {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      height: 350px;
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 15px;
      text-align: center;
    }

    .chart-wrapper {
      flex: 1;
      position: relative;
    }

    /* Filter Section */
    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #2c3e50;
    }

    .filter-select, .filter-input {
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .filter-select:focus, .filter-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .filter-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: white;
      border-radius: 15px 15px 0 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      margin-bottom: 0;
      overflow-x: auto;
    }

    .tab {
      padding: 15px 25px;
      background: none;
      border: none;
      font-weight: 600;
      color: #7f8c8d;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      white-space: nowrap;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
      background: white;
      padding: 0;
      border-radius: 0 0 15px 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .tab-content.active {
      display: block;
    }

    /* Table Styles */
    .table-container {
      overflow-x: auto;
      border-radius: 0 0 15px 15px;
      max-height: 600px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      min-width: 1000px;
    }

    table th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-weight: 600;
      padding: 15px 12px;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    table td {
      padding: 12px;
      border-bottom: 1px solid #f1f3f4;
    }

    table tbody tr:hover {
      background: #f8f9ff;
    }

    .status-present {
      background: #d4edda;
      color: #155724;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-absent {
      background: #f8d7da;
      color: #721c24;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-leave {
      background: #fff3cd;
      color: #856404;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-holiday {
      background: #cce7ff;
      color: #004085;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-approved {
      background: #d4edda;
      color: #155724;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-rejected {
      background: #f8d7da;
      color: #721c24;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .highlight-good {
      background: #d4edda;
      font-weight: 600;
    }

    .highlight-bad {
      background: #f8d7da;
      font-weight: 600;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 0.875rem;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-edit {
      background: #3498db;
      color: white;
    }

    .btn-delete {
      background: #e74c3c;
      color: white;
    }

    .btn-approve {
      background: #27ae60;
      color: white;
    }

    .btn-reject {
      background: #e67e22;
      color: white;
    }

    .btn-sm:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 90px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      max-width: 300px;
      transform: translateX(150%);
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success { background: #27ae60; }
    .toast.error { background: #e74c3c; }
    .toast.warning { background: #f39c12; }
    .toast.info { background: #3498db; }

    /* Loading States */
    .loading {
      color: #6c757d;
      font-style: italic;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    /* Debug Info */
    .debug-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-family: monospace;
      font-size: 12px;
      border-left: 4px solid #dc3545;
    }

    /* Modal Styles */
    .modal-content {
      border-radius: 15px;
      border: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 15px 15px 0 0;
      border-bottom: none;
    }

    .modal-footer {
      border-top: 1px solid #e9ecef;
      border-radius: 0 0 15px 15px;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .sidebar-toggle {
        display: block;
      }

      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.visible {
        transform: translateX(0);
      }

      .main-content {
        margin: 90px 15px 15px 15px;
        padding: 20px;
      }

      .filter-grid {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: column;
      }

      .tab {
        border-bottom: none;
        border-left: 3px solid transparent;
        text-align: left;
      }

      .tab.active {
        border-left-color: #667eea;
        border-bottom: none;
      }

      .quick-stats {
        grid-template-columns: 1fr 1fr;
      }

      .export-buttons {
        justify-content: center;
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .quick-stats {
        grid-template-columns: 1fr;
      }

      .topbar {
        padding: 0 15px;
      }

      .topbar .left {
        gap: 10px;
      }

      .topbar .left a {
        font-size: 14px;
        padding: 8px 12px;
      }

      .export-buttons {
        flex-direction: column;
      }

      .export-btn {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="left">
      <a href="#" id="homeButton">üè† Home</a>
    </div>
    <div id="dateTime">Loading...</div>
    <div class="profile">
      <img src="https://i.pravatar.cc/45" alt="User" />
      <span class="profile-name" id="profileName">Admin</span>
    </div>
  </div>

  <!-- Sidebar Toggle -->
  <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <ul>
      <li><a href="Leave.html">üìã Leave</a></li>
      <li><a href="Holiday.html">üéÑ Holiday</a></li>
      <li><a href="Attendance.html">‚è±Ô∏è Attendance Tracker</a></li>
      <li><a href="Hours.html">üïí Hours</a></li>
      <li><a href="Reports.html">üìä Reports</a></li>
      <li><a href="AllData.html" class="active">üîç Detailed View</a></li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="main-content" id="mainContent">
    <!-- Debug Info -->
    <div class="debug-info" id="debugInfo">
      Initializing admin dashboard...
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Admin Dashboard</h1>
        <p class="page-subtitle">Complete overview of all employee data and analytics</p>
      </div>
      <div class="export-buttons">
        <button class="export-btn export-excel" onclick="exportAllDataToExcel()">
          <span>üìä Export All Data to Excel</span>
        </button>
        <button class="export-btn export-pdf" onclick="exportDashboardToPDF()">
          <span>üìÑ Export Dashboard to PDF</span>
        </button>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="stat-card">
        <div class="stat-icon">üë•</div>
        <div class="stat-number" id="totalEmployees">0</div>
        <div class="stat-label">Total Employees</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-number" id="presentToday">0</div>
        <div class="stat-label">Present Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚ùå</div>
        <div class="stat-number" id="absentToday">0</div>
        <div class="stat-label">Absent Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-number" id="attendanceRate">0%</div>
        <div class="stat-label">Overall Attendance Rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚è±Ô∏è</div>
        <div class="stat-number" id="avgHours">0h</div>
        <div class="stat-label">Avg Daily Hours</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-number" id="overtimeHours">0h</div>
        <div class="stat-label">Total Overtime</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìã</div>
        <div class="stat-number" id="pendingLeaves">0</div>
        <div class="stat-label">Pending Leaves</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-number" id="approvedLeaves">0</div>
        <div class="stat-label">Approved Leaves</div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <div class="chart-container">
        <div class="chart-title">Attendance Distribution</div>
        <div class="chart-wrapper">
          <canvas id="attendanceChart"></canvas>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-title">Monthly Attendance Trend</div>
        <div class="chart-wrapper">
          <canvas id="monthlyTrendChart"></canvas>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-title">Employee Performance</div>
        <div class="chart-wrapper">
          <canvas id="performanceChart"></canvas>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-title">Working Hours Distribution</div>
        <div class="chart-wrapper">
          <canvas id="hoursDistributionChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-grid">
        <div class="filter-group">
          <label class="filter-label">Date Range</label>
          <select class="filter-select" id="dateRangeFilter">
            <option value="current_month">Current Month</option>
            <option value="last_month">Last Month</option>
            <option value="current_quarter">Current Quarter</option>
            <option value="last_quarter">Last Quarter</option>
            <option value="current_year">Current Year</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="filter-group" id="customDateRange" style="display: none;">
          <label class="filter-label">Custom Date Range</label>
          <div style="display: flex; gap: 10px;">
            <input type="date" class="filter-input" id="startDate" style="flex: 1;">
            <input type="date" class="filter-input" id="endDate" style="flex: 1;">
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">Department</label>
          <select class="filter-select" id="departmentFilter">
            <option value="all">All Departments</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Employee</label>
          <select class="filter-select" id="employeeFilter">
            <option value="all">All Employees</option>
          </select>
        </div>
        <div class="filter-group">
          <button class="filter-btn" onclick="loadDashboardData()">
            <span>üìà Update Dashboard</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('detailedView')">Detailed Attendance</button>
        <button class="tab" onclick="switchTab('employeeSummary')">Employee Summary</button>
        <button class="tab" onclick="switchTab('leaveManagement')">Leave Management</button>
        <button class="tab" onclick="switchTab('analytics')">Advanced Analytics</button>
        <button class="tab" onclick="switchTab('reports')">Custom Reports</button>
      </div>

      <!-- Detailed View Tab -->
      <div class="tab-content active" id="detailedView">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Employee</th>
                <th>Date</th>
                <th>Check In</th>
                <th>Check Out</th>
                <th>Working Hours</th>
                <th>Break Time</th>
                <th>Net Hours</th>
                <th>Status</th>
                <th>Remarks</th>
                <th>Overtime</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="detailedTableBody">
              <tr>
                <td colspan="11" class="no-data">
                  <div>Loading detailed data...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Employee Summary Tab -->
      <div class="tab-content" id="employeeSummary">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Employee</th>
                <th>Department</th>
                <th>Present Days</th>
                <th>Absent Days</th>
                <th>Leave Days</th>
                <th>Total Hours</th>
                <th>Avg Hours/Day</th>
                <th>Attendance %</th>
                <th>Overtime Hours</th>
                <th>Performance</th>
              </tr>
            </thead>
            <tbody id="summaryTableBody">
              <tr>
                <td colspan="10" class="no-data">
                  <div>Loading employee summary...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Leave Management Tab -->
      <div class="tab-content" id="leaveManagement">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Employee</th>
                <th>Leave Type</th>
                <th>From Date</th>
                <th>To Date</th>
                <th>Duration</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Applied On</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="leaveTableBody">
              <tr>
                <td colspan="9" class="no-data">
                  <div>Loading leave data...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Analytics Tab -->
      <div class="tab-content" id="analytics">
        <div style="padding: 20px;">
          <div class="charts-grid">
            <div class="chart-container">
              <div class="chart-title">Department-wise Attendance</div>
              <div class="chart-wrapper">
                <canvas id="departmentChart"></canvas>
              </div>
            </div>
            <div class="chart-container">
              <div class="chart-title">Late Arrivals Trend</div>
              <div class="chart-wrapper">
                <canvas id="lateArrivalsChart"></canvas>
              </div>
            </div>
            <div class="chart-container">
              <div class="chart-title">Overtime Analysis</div>
              <div class="chart-wrapper">
                <canvas id="overtimeChart"></canvas>
              </div>
            </div>
            <div class="chart-container">
              <div class="chart-title">Leave Distribution</div>
              <div class="chart-wrapper">
                <canvas id="leaveChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Tab -->
      <div class="tab-content" id="reports">
        <div style="padding: 20px;">
          <div class="filter-section" style="margin-bottom: 20px;">
            <div class="filter-grid">
              <div class="filter-group">
                <label class="filter-label">Report Type</label>
                <select class="filter-select" id="reportType">
                  <option value="attendance_summary">Attendance Summary</option>
                  <option value="performance_report">Performance Report</option>
                  <option value="overtime_report">Overtime Report</option>
                  <option value="leave_report">Leave Report</option>
                  <option value="custom_report">Custom Report</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">Format</label>
                <select class="filter-select" id="reportFormat">
                  <option value="table">Table View</option>
                  <option value="chart">Chart View</option>
                  <option value="summary">Summary View</option>
                </select>
              </div>
              <div class="filter-group">
                <button class="filter-btn" onclick="generateCustomReport()">
                  <span>üìã Generate Report</span>
                </button>
              </div>
            </div>
          </div>
          <div id="customReportContainer">
            <div class="no-data">
              <div>Select report type and click generate to view custom reports</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Edit Attendance Modal -->
  <div class="modal fade" id="editAttendanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Attendance Record</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editAttendanceForm">
            <input type="hidden" id="editAttendanceId">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Employee</label>
                <input type="text" class="form-control" id="editEmployeeName" disabled>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="editAttendanceDate" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Check In Time</label>
                <input type="time" class="form-control" id="editCheckIn">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Check Out Time</label>
                <input type="time" class="form-control" id="editCheckOut">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="editAttendanceStatus" required>
                  <option value="present">Present</option>
                  <option value="absent">Absent</option>
                  <option value="leave">Leave</option>
                  <option value="holiday">Holiday</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Remarks</label>
                <input type="text" class="form-control" id="editAttendanceRemarks">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveAttendanceChanges()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Leave Modal -->
  <div class="modal fade" id="editLeaveModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Leave Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editLeaveForm">
            <input type="hidden" id="editLeaveId">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Employee</label>
                <input type="text" class="form-control" id="editLeaveEmployee" disabled>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Leave Type</label>
                <select class="form-select" id="editLeaveType" required>
                  <option value="sick">Sick Leave</option>
                  <option value="casual">Casual Leave</option>
                  <option value="earned">Earned Leave</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">From Date</label>
                <input type="date" class="form-control" id="editLeaveFrom" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">To Date</label>
                <input type="date" class="form-control" id="editLeaveTo" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Reason</label>
              <textarea class="form-control" id="editLeaveReason" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" id="editLeaveStatus" required>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveLeaveChanges()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDYhLNuJKj2ucwGimfddTfpTb32Y0c-bXg",
      authDomain: "mytask-96a79.firebaseapp.com",
      databaseURL: "https://mytask-96a79-default-rtdb.firebaseio.com",
      projectId: "mytask-96a79",
      storageBucket: "mytask-96a79.firebasestorage.app",
      messagingSenderId: "963509757773",
      appId: "1:963509757773:web:d9c81a108f5873702eb904",
      measurementId: "G-L9C1LTCZRN"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let currentUser = null;
    let userData = null;
    let allUsers = [];
    let allAttendanceData = [];
    let allLeaveData = [];
    let dashboardData = null;
    let charts = {};

    // Update debug info
    function updateDebugInfo(message) {
      const debugInfo = document.getElementById('debugInfo');
      const timestamp = new Date().toLocaleTimeString();
      debugInfo.innerHTML = `<strong>Debug (${timestamp}):</strong> ${message}`;
      console.log('DEBUG:', message);
    }

    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast';
      toast.classList.add(type, 'show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Update date time
    function updateDateTime() {
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };
      document.getElementById('dateTime').textContent = now.toLocaleDateString('en-US', options);
    }

    // Home button click handler
    function handleHomeClick() {
      window.location.href = 'Home.html';
    }

    // Switch tabs
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName).classList.add('active');
      
      // Add active class to clicked tab
      event.target.classList.add('active');
      
      // Load specific data for the tab
      if (tabName === 'leaveManagement') {
        loadLeaveData();
      }
    }

    // Get date range based on filter selection
    function getDateRange() {
      const period = document.getElementById('dateRangeFilter').value;
      const today = new Date();
      let startDate, endDate;

      switch (period) {
        case 'current_month':
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          break;
        case 'last_month':
          startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          endDate = new Date(today.getFullYear(), today.getMonth(), 0);
          break;
        case 'current_quarter':
          const quarter = Math.floor(today.getMonth() / 3);
          startDate = new Date(today.getFullYear(), quarter * 3, 1);
          endDate = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
          break;
        case 'last_quarter':
          const lastQuarter = Math.floor(today.getMonth() / 3) - 1;
          startDate = new Date(today.getFullYear(), lastQuarter * 3, 1);
          endDate = new Date(today.getFullYear(), (lastQuarter + 1) * 3, 0);
          break;
        case 'current_year':
          startDate = new Date(today.getFullYear(), 0, 1);
          endDate = new Date(today.getFullYear(), 11, 31);
          break;
        case 'custom':
          startDate = new Date(document.getElementById('startDate').value);
          endDate = new Date(document.getElementById('endDate').value);
          break;
        default:
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      }

      return {
        start: startDate.toISOString().split('T')[0],
        end: endDate.toISOString().split('T')[0]
      };
    }

    // Initialize the application
    async function initializeApp() {
      updateDebugInfo('Starting admin dashboard initialization...');
      updateDateTime();
      setInterval(updateDateTime, 1000);

      // Get user from session storage
      const username = sessionStorage.getItem("username");
      if (!username) {
        updateDebugInfo('No user found in session storage');
        showToast('Please login first', 'error');
        setTimeout(() => window.location.href = 'index.html', 2000);
        return;
      }

      document.getElementById('profileName').textContent = username;

      // Set up home button click handler
      document.getElementById('homeButton').addEventListener('click', handleHomeClick);

      // Set up date range filter change handler
      document.getElementById('dateRangeFilter').addEventListener('change', function() {
        const customRange = document.getElementById('customDateRange');
        customRange.style.display = this.value === 'custom' ? 'block' : 'none';
      });

      // Set default dates for custom range
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
      document.getElementById('endDate').value = today.toISOString().split('T')[0];

      // Find user in Firestore
      try {
        updateDebugInfo('Searching for admin user in Firestore...');
        const userQuery = await db.collection("users")
          .where("username", "==", username)
          .get();

        if (userQuery.empty) {
          updateDebugInfo('User not found in Firestore');
          showToast('User not found in system', 'error');
          return;
        }

        userData = userQuery.docs[0].data();
        currentUser = userQuery.docs[0].id;

        // Check if user is admin
        if (userData.role !== 'Admin' && userData.role !== 'admin') {
          updateDebugInfo('Access denied - Admin privileges required');
          showToast('Access denied. Admin privileges required.', 'error');
          setTimeout(() => window.location.href = 'UserDashboard.html', 2000);
          return;
        }

        updateDebugInfo(`Admin user loaded: ${userData.username}`);

        // Load all data
        await loadAllData();
        
        // Initialize charts
        initializeCharts();

        updateDebugInfo('Admin dashboard initialized successfully');

      } catch (error) {
        updateDebugInfo('Error: ' + error.message);
        console.error("Error initializing admin dashboard:", error);
        showToast('Error loading admin dashboard: ' + error.message, 'error');
      }
    }

    // Load all data
    async function loadAllData() {
      try {
        updateDebugInfo('Loading all users and attendance data...');
        
        // Load all users
        const usersQuery = await db.collection("users").get();
        allUsers = [];
        usersQuery.forEach(doc => {
          allUsers.push({ id: doc.id, ...doc.data() });
        });

        // Load all attendance data
        const attendanceQuery = await db.collection("attendance").get();
        allAttendanceData = [];
        attendanceQuery.forEach(doc => {
          allAttendanceData.push({ id: doc.id, ...doc.data() });
        });

        // Load all leave data
        const leaveQuery = await db.collection("leaves").get();
        allLeaveData = [];
        leaveQuery.forEach(doc => {
          allLeaveData.push({ id: doc.id, ...doc.data() });
        });

        updateDebugInfo(`Loaded ${allUsers.length} users, ${allAttendanceData.length} attendance records, and ${allLeaveData.length} leave records`);

        // Populate filters
        populateFilters();
        
        // Load initial dashboard data
        await loadDashboardData();

      } catch (error) {
        updateDebugInfo('Error loading all data: ' + error.message);
        console.error("Error loading all data:", error);
        showToast('Error loading data: ' + error.message, 'error');
      }
    }

    // Populate filters
    function populateFilters() {
      // Employee filter
      const employeeFilter = document.getElementById('employeeFilter');
      employeeFilter.innerHTML = '<option value="all">All Employees</option>';
      
      allUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = `${user.username} (${user.empId || 'N/A'})`;
        employeeFilter.appendChild(option);
      });

      // Department filter (extract unique departments)
      const departments = [...new Set(allUsers.map(user => user.department || 'General'))];
      const departmentFilter = document.getElementById('departmentFilter');
      departmentFilter.innerHTML = '<option value="all">All Departments</option>';
      
      departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        departmentFilter.appendChild(option);
      });
    }

    // Load dashboard data
    async function loadDashboardData() {
      try {
        updateDebugInfo('Loading dashboard data...');
        showToast('Updating dashboard...', 'info');

        const dateRange = getDateRange();
        const employeeFilter = document.getElementById('employeeFilter').value;
        const departmentFilter = document.getElementById('departmentFilter').value;

        // Filter data based on selections
        let filteredData = allAttendanceData.filter(record => {
          const recordDate = new Date(record.date);
          const startDate = new Date(dateRange.start);
          const endDate = new Date(dateRange.end);
          
          if (recordDate < startDate || recordDate > endDate) {
            return false;
          }

          if (employeeFilter !== 'all' && record.userId !== employeeFilter) {
            return false;
          }

          if (departmentFilter !== 'all') {
            const user = allUsers.find(u => u.id === record.userId);
            if (!user || user.department !== departmentFilter) {
              return false;
            }
          }

          return true;
        });

        // Process dashboard data
        dashboardData = processDashboardData(filteredData, dateRange);
        
        // Update statistics
        updateStatistics(dashboardData);
        
        // Update tables
        updateTables(dashboardData);
        
        // Update charts
        updateCharts(dashboardData);

        showToast('Dashboard updated successfully!', 'success');

      } catch (error) {
        updateDebugInfo('Error loading dashboard data: ' + error.message);
        console.error("Error loading dashboard data:", error);
        showToast('Error updating dashboard: ' + error.message, 'error');
      }
    }

    // Process dashboard data
    function processDashboardData(rawData, dateRange) {
      const processedData = {
        summary: {},
        detailed: rawData,
        analytics: {},
        dateRange: dateRange
      };

      // Group data by user
      const userData = {};
      
      allUsers.forEach(user => {
        userData[user.id] = {
          user: user,
          records: [],
          presentDays: 0,
          absentDays: 0,
          leaveDays: 0,
          totalHours: 0,
          overtimeHours: 0,
          workingDays: 0,
          lateArrivals: 0
        };
      });

      // Process each attendance record
      rawData.forEach(record => {
        if (!userData[record.userId]) {
          return;
        }

        userData[record.userId].records.push(record);

        // Count status and calculate hours
        if (record.loginTime) {
          userData[record.userId].presentDays++;
          userData[record.userId].workingDays++;
          
          // Check for late arrival (after 9:30 AM)
          const loginTime = parseTimeString(record.loginTime, record.date);
          if (loginTime) {
            const nineThirty = new Date(record.date + 'T09:30:00');
            if (loginTime > nineThirty) {
              userData[record.userId].lateArrivals++;
            }
          }

          // Calculate hours
          if (record.loginTime && record.logoutTime) {
            const loginTime = parseTimeString(record.loginTime, record.date);
            const logoutTime = parseTimeString(record.logoutTime, record.date);
            
            if (loginTime && logoutTime) {
              const totalMs = logoutTime - loginTime;
              let breakMs = 0;

              // Calculate break time
              if (record.breaks && Array.isArray(record.breaks)) {
                record.breaks.forEach(breakRecord => {
                  if (breakRecord.breakOut && breakRecord.breakIn) {
                    const breakOut = parseTimeString(breakRecord.breakOut, record.date);
                    const breakIn = parseTimeString(breakRecord.breakIn, record.date);
                    if (breakOut && breakIn) {
                      breakMs += (breakIn - breakOut);
                    }
                  }
                });
              }

              const netHours = (totalMs - breakMs) / (1000 * 60 * 60);
              userData[record.userId].totalHours += netHours;

              // Calculate overtime (more than 8 hours)
              if (netHours > 8) {
                userData[record.userId].overtimeHours += (netHours - 8);
              }
            }
          }
        } else if (record.status === 'leave') {
          userData[record.userId].leaveDays++;
        } else if (record.status === 'holiday') {
          // Holidays don't count as absent
        } else {
          userData[record.userId].absentDays++;
          userData[record.userId].workingDays++;
        }
      });

      processedData.summary = userData;
      
      // Calculate analytics
      calculateAnalytics(processedData);
      
      return processedData;
    }

    // Calculate analytics
    function calculateAnalytics(data) {
      const analytics = {
        departmentStats: {},
        monthlyTrends: {},
        performanceMetrics: {},
        hoursDistribution: {},
        attendanceTrends: {},
        leaveStats: {}
      };

      // Department-wise statistics
      allUsers.forEach(user => {
        const dept = user.department || 'General';
        if (!analytics.departmentStats[dept]) {
          analytics.departmentStats[dept] = {
            totalEmployees: 0,
            presentDays: 0,
            totalHours: 0,
            overtimeHours: 0,
            attendanceRate: 0
          };
        }
        
        analytics.departmentStats[dept].totalEmployees++;
        
        const userData = data.summary[user.id];
        if (userData) {
          analytics.departmentStats[dept].presentDays += userData.presentDays;
          analytics.departmentStats[dept].totalHours += userData.totalHours;
          analytics.departmentStats[dept].overtimeHours += userData.overtimeHours;
          
          // Calculate department attendance rate
          const totalDays = userData.presentDays + userData.absentDays;
          if (totalDays > 0) {
            analytics.departmentStats[dept].attendanceRate += (userData.presentDays / totalDays) * 100;
          }
        }
      });

      // Calculate average attendance rate per department
      Object.keys(analytics.departmentStats).forEach(dept => {
        const deptStats = analytics.departmentStats[dept];
        if (deptStats.totalEmployees > 0) {
          deptStats.attendanceRate = Math.round(deptStats.attendanceRate / deptStats.totalEmployees);
        }
      });

      // Monthly trends
      const monthlyData = {};
      data.detailed.forEach(record => {
        const month = record.date.substring(0, 7); // YYYY-MM format
        if (!monthlyData[month]) {
          monthlyData[month] = { present: 0, total: 0 };
        }
        
        monthlyData[month].total++;
        if (record.loginTime) {
          monthlyData[month].present++;
        }
      });

      analytics.monthlyTrends = monthlyData;

      // Performance metrics
      analytics.performanceMetrics = {};
      Object.values(data.summary).forEach(userData => {
        if (userData.workingDays > 0) {
          const attendanceRate = Math.round((userData.presentDays / userData.workingDays) * 100);
          const punctualityRate = userData.presentDays > 0 ? 
            Math.round(((userData.presentDays - userData.lateArrivals) / userData.presentDays) * 100) : 0;
          
          // Simple performance score (attendance 70%, punctuality 30%)
          const performanceScore = Math.round((attendanceRate * 0.7) + (punctualityRate * 0.3));
          analytics.performanceMetrics[userData.user.id] = performanceScore;
        }
      });

      // Hours distribution
      analytics.hoursDistribution = { '<6h': 0, '6-8h': 0, '8-10h': 0, '>10h': 0 };
      Object.values(data.summary).forEach(userData => {
        const avgHours = userData.presentDays > 0 ? userData.totalHours / userData.presentDays : 0;
        
        if (avgHours < 6) {
          analytics.hoursDistribution['<6h']++;
        } else if (avgHours <= 8) {
          analytics.hoursDistribution['6-8h']++;
        } else if (avgHours <= 10) {
          analytics.hoursDistribution['8-10h']++;
        } else {
          analytics.hoursDistribution['>10h']++;
        }
      });

      // Late arrivals trend (by week)
      analytics.lateArrivalsTrend = {};
      data.detailed.forEach(record => {
        if (record.loginTime) {
          const loginTime = parseTimeString(record.loginTime, record.date);
          if (loginTime) {
            const nineThirty = new Date(record.date + 'T09:30:00');
            if (loginTime > nineThirty) {
              const week = getWeekNumber(new Date(record.date));
              if (!analytics.lateArrivalsTrend[week]) {
                analytics.lateArrivalsTrend[week] = 0;
              }
              analytics.lateArrivalsTrend[week]++;
            }
          }
        }
      });

      // Leave statistics
      analytics.leaveStats = {
        pending: allLeaveData.filter(leave => leave.status === 'pending').length,
        approved: allLeaveData.filter(leave => leave.status === 'approved').length,
        rejected: allLeaveData.filter(leave => leave.status === 'rejected').length,
        byType: {
          sick: allLeaveData.filter(leave => leave.type === 'sick').length,
          casual: allLeaveData.filter(leave => leave.type === 'casual').length,
          earned: allLeaveData.filter(leave => leave.type === 'earned').length
        }
      };

      data.analytics = analytics;
    }

    // Helper function to get week number
    function getWeekNumber(date) {
      const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
      const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
      return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    }

    // Update statistics
    function updateStatistics(data) {
      const today = new Date().toISOString().split('T')[0];
      
      // Today's attendance
      const todayAttendance = data.detailed.filter(record => record.date === today);
      const presentToday = todayAttendance.filter(record => record.loginTime).length;
      
      // Overall statistics
      let totalPresent = 0;
      let totalHours = 0;
      let totalOvertime = 0;
      let userCount = 0;

      Object.values(data.summary).forEach(userData => {
        if (userData.records.length > 0) {
          totalPresent += userData.presentDays;
          totalHours += userData.totalHours;
          totalOvertime += userData.overtimeHours;
          userCount++;
        }
      });

      const totalEmployees = allUsers.length;
      const absentToday = totalEmployees - presentToday;
      const avgHours = totalPresent > 0 ? (totalHours / totalPresent).toFixed(1) : 0;
      const attendanceRate = totalEmployees > 0 ? Math.round((presentToday / totalEmployees) * 100) : 0;

      // Leave statistics
      const leaveStats = data.analytics.leaveStats || {
        pending: 0,
        approved: 0,
        rejected: 0
      };

      // Update DOM
      document.getElementById('totalEmployees').textContent = totalEmployees;
      document.getElementById('presentToday').textContent = presentToday;
      document.getElementById('absentToday').textContent = absentToday;
      document.getElementById('attendanceRate').textContent = attendanceRate + '%';
      document.getElementById('avgHours').textContent = avgHours + 'h';
      document.getElementById('overtimeHours').textContent = totalOvertime.toFixed(1) + 'h';
      document.getElementById('pendingLeaves').textContent = leaveStats.pending;
      document.getElementById('approvedLeaves').textContent = leaveStats.approved;
    }

    // Update tables
    function updateTables(data) {
      updateDetailedTable(data);
      updateSummaryTable(data);
    }

    // Update detailed table
    function updateDetailedTable(data) {
      const tbody = document.getElementById('detailedTableBody');
      tbody.innerHTML = '';

      if (data.detailed.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="11" class="no-data">
              <div>No data available for the selected period</div>
            </td>
          </tr>
        `;
        return;
      }

      // Sort by date descending
      data.detailed.sort((a, b) => new Date(b.date) - new Date(a.date));

      data.detailed.forEach(record => {
        const user = allUsers.find(u => u.id === record.userId);
        const userName = user ? `${user.username} (${user.empId || 'N/A'})` : 'Unknown';

        // Calculate hours
        let workingHours = '-';
        let netHours = '-';
        let breakTime = '-';
        let overtime = '-';
        let status = 'present';

        if (record.loginTime && record.logoutTime) {
          try {
            const loginTime = parseTimeString(record.loginTime, record.date);
            const logoutTime = parseTimeString(record.logoutTime, record.date);
            
            if (loginTime && logoutTime) {
              const totalMs = logoutTime - loginTime;
              const totalHours = totalMs / (1000 * 60 * 60);
              
              let breakMs = 0;
              if (record.breaks && Array.isArray(record.breaks)) {
                record.breaks.forEach(breakRecord => {
                  if (breakRecord.breakOut && breakRecord.breakIn) {
                    const breakOut = parseTimeString(breakRecord.breakOut, record.date);
                    const breakIn = parseTimeString(breakRecord.breakIn, record.date);
                    if (breakOut && breakIn) {
                      breakMs += (breakIn - breakOut);
                    }
                  }
                });
              }
              
              const breakHours = breakMs / (1000 * 60 * 60);
              const netHoursValue = totalHours - breakHours;
              
              workingHours = totalHours.toFixed(2) + 'h';
              breakTime = breakHours > 0 ? breakHours.toFixed(2) + 'h' : '-';
              netHours = netHoursValue.toFixed(2) + 'h';
              
              // Calculate overtime
              if (netHoursValue > 8) {
                overtime = (netHoursValue - 8).toFixed(2) + 'h';
              }
            }
          } catch (error) {
            console.error('Error calculating hours:', error);
          }
        } else if (record.loginTime && !record.logoutTime) {
          status = 'working';
        } else {
          status = record.status || 'absent';
        }

        // Create status badge
        let statusBadge = '';
        switch (status) {
          case 'present':
          case 'working':
            statusBadge = `<span class="status-present">Present</span>`;
            break;
          case 'absent':
            statusBadge = `<span class="status-absent">Absent</span>`;
            break;
          case 'leave':
            statusBadge = `<span class="status-leave">On Leave</span>`;
            break;
          case 'holiday':
            statusBadge = `<span class="status-holiday">Holiday</span>`;
            break;
        }

        const dateObj = new Date(record.date);
        const formattedDate = dateObj.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric' 
        });

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${userName}</td>
          <td>${formattedDate}</td>
          <td>${record.loginTime || '-'}</td>
          <td>${record.logoutTime || '-'}</td>
          <td>${workingHours}</td>
          <td>${breakTime}</td>
          <td>${netHours}</td>
          <td>${statusBadge}</td>
          <td>${record.remarks || '-'}</td>
          <td>${overtime || '-'}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-sm btn-edit" onclick="editAttendance('${record.id}')" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-sm btn-delete" onclick="deleteAttendance('${record.id}')" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Update summary table
    function updateSummaryTable(data) {
      const tbody = document.getElementById('summaryTableBody');
      tbody.innerHTML = '';

      const summaryData = Object.values(data.summary).filter(userData => userData.records.length > 0);

      if (summaryData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="no-data">
              <div>No summary data available for the selected period</div>
            </td>
          </tr>
        `;
        return;
      }

      summaryData.forEach(userData => {
        const totalDays = userData.presentDays + userData.absentDays + userData.leaveDays;
        const attendanceRate = userData.workingDays > 0 ? Math.round((userData.presentDays / userData.workingDays) * 100) : 0;
        const avgHours = userData.presentDays > 0 ? (userData.totalHours / userData.presentDays).toFixed(2) : 0;
        
        // Performance rating based on attendance and punctuality
        let performance = 'Good';
        let performanceClass = 'highlight-good';
        
        if (attendanceRate < 70) {
          performance = 'Poor';
          performanceClass = 'highlight-bad';
        } else if (attendanceRate < 85) {
          performance = 'Average';
          performanceClass = '';
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${userData.user.username} (${userData.user.empId || 'N/A'})</td>
          <td>${userData.user.department || 'General'}</td>
          <td class="highlight-good">${userData.presentDays}</td>
          <td class="highlight-bad">${userData.absentDays}</td>
          <td>${userData.leaveDays}</td>
          <td>${userData.totalHours.toFixed(2)}h</td>
          <td>${avgHours}h</td>
          <td>${attendanceRate}%</td>
          <td>${userData.overtimeHours.toFixed(2)}h</td>
          <td class="${performanceClass}">${performance}</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Load leave data
    async function loadLeaveData() {
      try {
        updateDebugInfo('Loading leave data...');
        
        const tbody = document.getElementById('leaveTableBody');
        tbody.innerHTML = '';

        if (allLeaveData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" class="no-data">
                <div>No leave records found</div>
              </td>
            </tr>
          `;
          return;
        }

        // Sort by applied date descending
        allLeaveData.sort((a, b) => new Date(b.appliedDate) - new Date(a.appliedDate));

        allLeaveData.forEach(leave => {
          const user = allUsers.find(u => u.id === leave.userId);
          const userName = user ? `${user.username} (${user.empId || 'N/A'})` : 'Unknown';

          // Format dates
          const fromDate = new Date(leave.fromDate).toLocaleDateString('en-US');
          const toDate = new Date(leave.toDate).toLocaleDateString('en-US');
          const appliedDate = new Date(leave.appliedDate).toLocaleDateString('en-US');

          // Calculate duration
          const from = new Date(leave.fromDate);
          const to = new Date(leave.toDate);
          const duration = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;

          // Get status badge
          let statusBadge = '';
          if (leave.status === 'pending') {
            statusBadge = '<span class="status-pending">Pending</span>';
          } else if (leave.status === 'approved') {
            statusBadge = '<span class="status-approved">Approved</span>';
          } else {
            statusBadge = '<span class="status-rejected">Rejected</span>';
          }

          // Get leave type display
          let typeDisplay = '';
          if (leave.type === 'sick') {
            typeDisplay = 'Sick Leave';
          } else if (leave.type === 'casual') {
            typeDisplay = 'Casual Leave';
          } else {
            typeDisplay = 'Earned Leave';
          }

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${userName}</td>
            <td>${typeDisplay}</td>
            <td>${fromDate}</td>
            <td>${toDate}</td>
            <td>${duration} Days</td>
            <td>${leave.reason || '-'}</td>
            <td>${statusBadge}</td>
            <td>${appliedDate}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-sm btn-edit" onclick="editLeave('${leave.id}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-sm btn-delete" onclick="deleteLeave('${leave.id}')" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
                ${leave.status === 'pending' ? `
                <button class="btn-sm btn-approve" onclick="approveLeave('${leave.id}')" title="Approve">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn-sm btn-reject" onclick="rejectLeave('${leave.id}')" title="Reject">
                  <i class="fas fa-times"></i>
                </button>
                ` : ''}
              </div>
            </td>
          `;
          
          tbody.appendChild(row);
        });

        updateDebugInfo('Leave data loaded successfully');

      } catch (error) {
        updateDebugInfo('Error loading leave data: ' + error.message);
        console.error("Error loading leave data:", error);
        const tbody = document.getElementById('leaveTableBody');
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-danger">Error loading leave data</td></tr>';
      }
    }

    // Edit attendance record
    async function editAttendance(attendanceId) {
      try {
        const attendance = allAttendanceData.find(a => a.id === attendanceId);
        if (!attendance) {
          showToast('Attendance record not found', 'error');
          return;
        }

        const user = allUsers.find(u => u.id === attendance.userId);
        
        // Populate modal
        document.getElementById('editAttendanceId').value = attendanceId;
        document.getElementById('editEmployeeName').value = user ? `${user.username} (${user.empId || 'N/A'})` : 'Unknown';
        document.getElementById('editAttendanceDate').value = attendance.date;
        document.getElementById('editCheckIn').value = attendance.loginTime || '';
        document.getElementById('editCheckOut').value = attendance.logoutTime || '';
        document.getElementById('editAttendanceStatus').value = attendance.status || 'present';
        document.getElementById('editAttendanceRemarks').value = attendance.remarks || '';

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editAttendanceModal'));
        modal.show();

      } catch (error) {
        console.error("Error editing attendance:", error);
        showToast('Error loading attendance data', 'error');
      }
    }

    // Save attendance changes
    async function saveAttendanceChanges() {
      try {
        const attendanceId = document.getElementById('editAttendanceId').value;
        const date = document.getElementById('editAttendanceDate').value;
        const checkIn = document.getElementById('editCheckIn').value;
        const checkOut = document.getElementById('editCheckOut').value;
        const status = document.getElementById('editAttendanceStatus').value;
        const remarks = document.getElementById('editAttendanceRemarks').value;

        // Update in Firestore
        await db.collection("attendance").doc(attendanceId).update({
          date: date,
          loginTime: checkIn || null,
          logoutTime: checkOut || null,
          status: status,
          remarks: remarks,
          lastUpdated: new Date().toISOString(),
          updatedBy: userData.username
        });

        // Update local data
        const index = allAttendanceData.findIndex(a => a.id === attendanceId);
        if (index !== -1) {
          allAttendanceData[index] = {
            ...allAttendanceData[index],
            date: date,
            loginTime: checkIn || null,
            logoutTime: checkOut || null,
            status: status,
            remarks: remarks
          };
        }

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editAttendanceModal'));
        modal.hide();

        // Reload data
        await loadDashboardData();
        showToast('Attendance record updated successfully!', 'success');

      } catch (error) {
        console.error("Error saving attendance changes:", error);
        showToast('Error updating attendance record', 'error');
      }
    }

    // Delete attendance record
    async function deleteAttendance(attendanceId) {
      if (!confirm('Are you sure you want to delete this attendance record?')) {
        return;
      }

      try {
        await db.collection("attendance").doc(attendanceId).delete();
        
        // Remove from local data
        allAttendanceData = allAttendanceData.filter(a => a.id !== attendanceId);
        
        // Reload data
        await loadDashboardData();
        showToast('Attendance record deleted successfully!', 'success');

      } catch (error) {
        console.error("Error deleting attendance:", error);
        showToast('Error deleting attendance record', 'error');
      }
    }

    // Edit leave record
    async function editLeave(leaveId) {
      try {
        const leave = allLeaveData.find(l => l.id === leaveId);
        if (!leave) {
          showToast('Leave record not found', 'error');
          return;
        }

        const user = allUsers.find(u => u.id === leave.userId);
        
        // Populate modal
        document.getElementById('editLeaveId').value = leaveId;
        document.getElementById('editLeaveEmployee').value = user ? `${user.username} (${user.empId || 'N/A'})` : 'Unknown';
        document.getElementById('editLeaveType').value = leave.type;
        document.getElementById('editLeaveFrom').value = leave.fromDate;
        document.getElementById('editLeaveTo').value = leave.toDate;
        document.getElementById('editLeaveReason').value = leave.reason || '';
        document.getElementById('editLeaveStatus').value = leave.status;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editLeaveModal'));
        modal.show();

      } catch (error) {
        console.error("Error editing leave:", error);
        showToast('Error loading leave data', 'error');
      }
    }

    // Save leave changes
    async function saveLeaveChanges() {
      try {
        const leaveId = document.getElementById('editLeaveId').value;
        const type = document.getElementById('editLeaveType').value;
        const fromDate = document.getElementById('editLeaveFrom').value;
        const toDate = document.getElementById('editLeaveTo').value;
        const reason = document.getElementById('editLeaveReason').value;
        const status = document.getElementById('editLeaveStatus').value;

        // Calculate duration
        const from = new Date(fromDate);
        const to = new Date(toDate);
        const duration = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;

        // Update in Firestore
        await db.collection("leaves").doc(leaveId).update({
          type: type,
          fromDate: fromDate,
          toDate: toDate,
          duration: duration,
          reason: reason,
          status: status,
          lastUpdated: new Date().toISOString(),
          updatedBy: userData.username
        });

        // Update local data
        const index = allLeaveData.findIndex(l => l.id === leaveId);
        if (index !== -1) {
          allLeaveData[index] = {
            ...allLeaveData[index],
            type: type,
            fromDate: fromDate,
            toDate: toDate,
            duration: duration,
            reason: reason,
            status: status
          };
        }

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editLeaveModal'));
        modal.hide();

        // Reload data
        await loadLeaveData();
        await loadDashboardData();
        showToast('Leave request updated successfully!', 'success');

      } catch (error) {
        console.error("Error saving leave changes:", error);
        showToast('Error updating leave request', 'error');
      }
    }

    // Delete leave record
    async function deleteLeave(leaveId) {
      if (!confirm('Are you sure you want to delete this leave request?')) {
        return;
      }

      try {
        await db.collection("leaves").doc(leaveId).delete();
        
        // Remove from local data
        allLeaveData = allLeaveData.filter(l => l.id !== leaveId);
        
        // Reload data
        await loadLeaveData();
        await loadDashboardData();
        showToast('Leave request deleted successfully!', 'success');

      } catch (error) {
        console.error("Error deleting leave:", error);
        showToast('Error deleting leave request', 'error');
      }
    }

    // Approve leave
    async function approveLeave(leaveId) {
      try {
        await db.collection("leaves").doc(leaveId).update({
          status: 'approved',
          approvedDate: new Date().toISOString(),
          approvedBy: userData.username
        });

        // Update local data
        const index = allLeaveData.findIndex(l => l.id === leaveId);
        if (index !== -1) {
          allLeaveData[index].status = 'approved';
          allLeaveData[index].approvedDate = new Date().toISOString();
          allLeaveData[index].approvedBy = userData.username;
        }

        // Reload data
        await loadLeaveData();
        await loadDashboardData();
        showToast('Leave request approved successfully!', 'success');

      } catch (error) {
        console.error("Error approving leave:", error);
        showToast('Error approving leave request', 'error');
      }
    }

    // Reject leave
    async function rejectLeave(leaveId) {
      const reason = prompt('Please enter reason for rejection:');
      if (reason === null) return;
      
      if (!reason.trim()) {
        showToast('Please provide a rejection reason', 'error');
        return;
      }

      try {
        await db.collection("leaves").doc(leaveId).update({
          status: 'rejected',
          rejectedDate: new Date().toISOString(),
          rejectedBy: userData.username,
          rejectionReason: reason
        });

        // Update local data
        const index = allLeaveData.findIndex(l => l.id === leaveId);
        if (index !== -1) {
          allLeaveData[index].status = 'rejected';
          allLeaveData[index].rejectedDate = new Date().toISOString();
          allLeaveData[index].rejectedBy = userData.username;
          allLeaveData[index].rejectionReason = reason;
        }

        // Reload data
        await loadLeaveData();
        await loadDashboardData();
        showToast('Leave request rejected successfully!', 'success');

      } catch (error) {
        console.error("Error rejecting leave:", error);
        showToast('Error rejecting leave request', 'error');
      }
    }

    // Initialize charts
    function initializeCharts() {
      // Attendance Distribution Chart
      const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
      charts.attendance = new Chart(attendanceCtx, {
        type: 'doughnut',
        data: {
          labels: ['Present', 'Absent', 'Leave', 'Holiday'],
          datasets: [{
            data: [0, 0, 0, 0],
            backgroundColor: ['#27ae60', '#e74c3c', '#f39c12', '#3498db'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Monthly Trend Chart
      const monthlyCtx = document.getElementById('monthlyTrendChart').getContext('2d');
      charts.monthlyTrend = new Chart(monthlyCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Attendance Rate',
            data: [],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: 0,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });

      // Performance Chart
      const performanceCtx = document.getElementById('performanceChart').getContext('2d');
      charts.performance = new Chart(performanceCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Performance Score',
            data: [],
            backgroundColor: '#667eea'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: 0,
              max: 100
            }
          }
        }
      });

      // Hours Distribution Chart
      const hoursCtx = document.getElementById('hoursDistributionChart').getContext('2d');
      charts.hoursDistribution = new Chart(hoursCtx, {
        type: 'bar',
        data: {
          labels: ['<6h', '6-8h', '8-10h', '>10h'],
          datasets: [{
            label: 'Employees',
            data: [0, 0, 0, 0],
            backgroundColor: '#27ae60'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });

      // Analytics charts
      const departmentCtx = document.getElementById('departmentChart').getContext('2d');
      charts.department = new Chart(departmentCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Attendance Rate',
            data: [],
            backgroundColor: '#3498db'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: 0,
              max: 100
            }
          }
        }
      });

      const lateCtx = document.getElementById('lateArrivalsChart').getContext('2d');
      charts.lateArrivals = new Chart(lateCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Late Arrivals',
            data: [],
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });

      const overtimeCtx = document.getElementById('overtimeChart').getContext('2d');
      charts.overtime = new Chart(overtimeCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Overtime Hours',
            data: [],
            backgroundColor: '#f39c12'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });

      const leaveCtx = document.getElementById('leaveChart').getContext('2d');
      charts.leave = new Chart(leaveCtx, {
        type: 'doughnut',
        data: {
          labels: ['Sick Leave', 'Casual Leave', 'Earned Leave'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#9b59b6', '#3498db', '#e74c3c']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // Update charts with real data
    function updateCharts(data) {
      if (!dashboardData || !dashboardData.analytics) return;

      const analytics = dashboardData.analytics;

      // Update attendance distribution
      let present = 0, absent = 0, leave = 0, holiday = 0;
      
      data.detailed.forEach(record => {
        if (record.loginTime) {
          present++;
        } else if (record.status === 'leave') {
          leave++;
        } else if (record.status === 'holiday') {
          holiday++;
        } else {
          absent++;
        }
      });

      if (charts.attendance) {
        charts.attendance.data.datasets[0].data = [present, absent, leave, holiday];
        charts.attendance.update();
      }

      // Update monthly trend chart
      if (charts.monthlyTrend && analytics.monthlyTrends) {
        const months = Object.keys(analytics.monthlyTrends).sort();
        const attendanceRates = months.map(month => {
          const data = analytics.monthlyTrends[month];
          return data.total > 0 ? Math.round((data.present / data.total) * 100) : 0;
        });
        
        // Format month labels
        const monthLabels = months.map(month => {
          const [year, monthNum] = month.split('-');
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
        });
        
        charts.monthlyTrend.data.labels = monthLabels;
        charts.monthlyTrend.data.datasets[0].data = attendanceRates;
        charts.monthlyTrend.update();
      }

      // Update performance chart
      if (charts.performance && analytics.performanceMetrics) {
        const performanceData = Object.values(analytics.performanceMetrics);
        const userNames = Object.keys(analytics.performanceMetrics).map(userId => {
          const user = allUsers.find(u => u.id === userId);
          return user ? user.username : 'Unknown';
        });
        
        // Show top 10 performers
        const combined = userNames.map((name, index) => ({ name, score: performanceData[index] }));
        combined.sort((a, b) => b.score - a.score);
        const topPerformers = combined.slice(0, 10);
        
        charts.performance.data.labels = topPerformers.map(item => item.name);
        charts.performance.data.datasets[0].data = topPerformers.map(item => item.score);
        charts.performance.update();
      }

      // Update hours distribution chart
      if (charts.hoursDistribution && analytics.hoursDistribution) {
        charts.hoursDistribution.data.datasets[0].data = [
          analytics.hoursDistribution['<6h'],
          analytics.hoursDistribution['6-8h'],
          analytics.hoursDistribution['8-10h'],
          analytics.hoursDistribution['>10h']
        ];
        charts.hoursDistribution.update();
      }

      // Update department chart
      if (charts.department && analytics.departmentStats) {
        const departments = Object.keys(analytics.departmentStats);
        const attendanceRates = departments.map(dept => analytics.departmentStats[dept].attendanceRate);
        
        charts.department.data.labels = departments;
        charts.department.data.datasets[0].data = attendanceRates;
        charts.department.update();
      }

      // Update late arrivals chart
      if (charts.lateArrivals && analytics.lateArrivalsTrend) {
        const weeks = Object.keys(analytics.lateArrivalsTrend).sort();
        const lateCounts = weeks.map(week => analytics.lateArrivalsTrend[week]);
        
        charts.lateArrivals.data.labels = weeks.map(week => `Week ${week}`);
        charts.lateArrivals.data.datasets[0].data = lateCounts;
        charts.lateArrivals.update();
      }

      // Update overtime chart
      if (charts.overtime && analytics.departmentStats) {
        const departments = Object.keys(analytics.departmentStats);
        const overtimeHours = departments.map(dept => analytics.departmentStats[dept].overtimeHours);
        
        charts.overtime.data.labels = departments;
        charts.overtime.data.datasets[0].data = overtimeHours;
        charts.overtime.update();
      }

      // Update leave chart
      if (charts.leave && analytics.leaveStats) {
        charts.leave.data.datasets[0].data = [
          analytics.leaveStats.byType.sick,
          analytics.leaveStats.byType.casual,
          analytics.leaveStats.byType.earned
        ];
        charts.leave.update();
      }
    }

    // Generate custom report
    function generateCustomReport() {
      const reportType = document.getElementById('reportType').value;
      const reportFormat = document.getElementById('reportFormat').value;
      
      showToast(`Generating ${reportType} report...`, 'info');
      
      // This would generate different types of reports based on selection
      // For now, we'll just show a message
      const container = document.getElementById('customReportContainer');
      container.innerHTML = `
        <div class="no-data">
          <div>Custom report generation for "${reportType}" in ${reportFormat} format would be implemented here</div>
          <div style="margin-top: 10px; font-size: 14px;">
            This feature would generate specialized reports based on the selected criteria.
          </div>
        </div>
      `;
    }

    // Export all data to Excel
    function exportAllDataToExcel() {
      if (!dashboardData) {
        showToast('Please load data first', 'warning');
        return;
      }

      try {
        const dataToExport = [];
        
        // Add summary data
        Object.values(dashboardData.summary).forEach(userData => {
          const attendanceRate = userData.workingDays > 0 ? 
            Math.round((userData.presentDays / userData.workingDays) * 100) : 0;
          const avgHours = userData.presentDays > 0 ? 
            (userData.totalHours / userData.presentDays).toFixed(2) : 0;

          dataToExport.push({
            'Employee Name': userData.user.username,
            'Employee ID': userData.user.empId || 'N/A',
            'Department': userData.user.department || 'General',
            'Present Days': userData.presentDays,
            'Absent Days': userData.absentDays,
            'Leave Days': userData.leaveDays,
            'Total Hours': userData.totalHours.toFixed(2),
            'Average Hours/Day': avgHours,
            'Attendance Rate': attendanceRate + '%',
            'Overtime Hours': userData.overtimeHours.toFixed(2),
            'Late Arrivals': userData.lateArrivals
          });
        });

        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Employee Summary');
        
        const fileName = `admin_dashboard_export_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showToast('Excel file downloaded successfully!', 'success');
      } catch (error) {
        console.error('Error exporting to Excel:', error);
        showToast('Error exporting to Excel', 'error');
      }
    }

    // Export dashboard to PDF
    function exportDashboardToPDF() {
      if (!dashboardData) {
        showToast('Please load data first', 'warning');
        return;
      }

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(20);
        doc.setTextColor(40, 40, 40);
        doc.text('Admin Dashboard Report', 105, 15, { align: 'center' });
        
        // Add date range
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        const dateRange = `From ${dashboardData.dateRange.start} to ${dashboardData.dateRange.end}`;
        doc.text(dateRange, 105, 25, { align: 'center' });
        
        // Add summary table
        doc.autoTable({
          startY: 35,
          head: [['Employee', 'Present', 'Absent', 'Leave', 'Total Hours', 'Attendance %']],
          body: preparePDFSummaryData(dashboardData),
          theme: 'grid',
          headStyles: {
            fillColor: [102, 126, 234],
            textColor: 255
          },
          styles: {
            fontSize: 10
          }
        });
        
        const fileName = `admin_dashboard_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
        
        showToast('PDF report downloaded successfully!', 'success');
      } catch (error) {
        console.error('Error exporting to PDF:', error);
        showToast('Error exporting to PDF', 'error');
      }
    }

    // Prepare data for PDF export
    function preparePDFSummaryData(data) {
      const pdfData = [];
      
      Object.values(data.summary).forEach(userData => {
        const attendanceRate = userData.workingDays > 0 ? 
          Math.round((userData.presentDays / userData.workingDays) * 100) : 0;

        pdfData.push([
          userData.user.username,
          userData.presentDays.toString(),
          userData.absentDays.toString(),
          userData.leaveDays.toString(),
          userData.totalHours.toFixed(2),
          attendanceRate + '%'
        ]);
      });

      return pdfData;
    }

    // Helper function to parse time strings
    function parseTimeString(timeStr, baseDate) {
      if (!timeStr) return null;
      
      try {
        let timePart = timeStr;
        let period = '';
        
        if (timeStr.includes(' ')) {
          [timePart, period] = timeStr.split(' ');
        }
        
        const [hours, minutes] = timePart.split(':').map(Number);
        
        const date = new Date(baseDate);
        let hours24 = hours;
        
        if (period === 'PM' && hours24 !== 12) {
          hours24 += 12;
        } else if (period === 'AM' && hours24 === 12) {
          hours24 = 0;
        }
        
        date.setHours(hours24, minutes, 0, 0);
        return date;
      } catch (error) {
        console.error("Error parsing time string:", timeStr, error);
        return null;
      }
    }

    // Sidebar functionality for mobile
    document.getElementById('sidebarToggle').addEventListener('click', function() {
      document.getElementById('sidebar').classList.toggle('visible');
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.getElementById('sidebarToggle');
      
      if (window.innerWidth <= 768 && 
          sidebar.classList.contains('visible') && 
          !sidebar.contains(e.target) && 
          !toggle.contains(e.target)) {
        sidebar.classList.remove('visible');
      }
    });

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
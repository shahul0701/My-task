<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Manager Dashboard</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      color: #2c3e50;
      overflow-x: hidden;
    }
    .topbar {
      position: fixed; top: 0; left: 0; right: 0;
      height: 60px; background: #007BFF;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; z-index: 1001;
    }
    #dateTime { font-weight: bold; font-size: 16px; color: #fafafa; display: flex; align-items: center; }

    #sidebarToggle {
      font-size: 24px;
      color: #fafafa;
      background: none;
      border: none;
      cursor: pointer;
      margin-right: 10px;
      display: block;
    }

    .profile {
      position: relative; cursor: pointer; display: flex; align-items: center;
      width: 40px; height: 40px;
      background: #0056b3; border-radius: 50%;
      color: white; font-weight: bold; font-size: 20px;
      justify-content: center; text-transform: uppercase;
    }

    #profileDropdown {
      display: none; position: absolute; top: 50px; right: 0;
      background: white; border: 1px solid #ccc; border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 140px; z-index: 1002;
    }
    #profileDropdown a, #profileDropdown button {
      display: block; width: 100%;
      padding: 10px 15px; text-align: left;
      border: none; background: none; color: #333; font-size: 14px; cursor: pointer;
    }
    #profileDropdown button { color: #e74c3c; }
    a:hover, button:hover { background: #f0f0f0; }

    .sidebar {
      position: fixed; top: 60px; left: 0;
      width: 220px; height: calc(100% - 60px);
      background: #2c3e50; color: white;
      padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }
    .sidebar.visible { transform: translateX(0); }
    .sidebar ul { list-style: none; padding: 0; margin: 0; }
    .sidebar .menu-item { margin-bottom: 12px; }
    .sidebar .menu-item a {
      color: #ecf0f1; text-decoration: none; font-weight: 600;
      padding: 10px; display: block; border-radius: 6px;
      transition: background 0.3s ease;
    }
    .sidebar .menu-item a:hover { background: #34495e; }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      max-width: 300px;
      transform: translateX(150%);
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: #27ae60;
    }

    .toast.error {
      background: #e74c3c;
    }

    .toast.warning {
      background: #f39c12;
    }

    .toast.info {
      background: #3498db;
    }

    .main-content {
      margin-top: 60px; padding: 30px;
      transition: margin-left 0.3s ease; margin-left: 0;
    }
    .main-content.shifted { margin-left: 220px; }

    .todo-panel {
      background: white; border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      padding: 20px; max-width: 400px; margin-left: auto;
    }
    .todo-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
    }
    .todo-header button {
      background: #007BFF; color: white; border: none;
      padding: 6px 12px; border-radius: 6px; cursor: pointer;
    }
    .add-task {
      display: flex; gap: 8px; margin-bottom: 12px;
    }
    .add-task input {
      flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px;
    }
    .add-task button {
      background: #007BFF; color: white; border: none;
      padding: 8px 16px; border-radius: 6px; cursor: pointer;
    }
    .todo-list {
      list-style: none; padding: 0; max-height: 300px; overflow-y: auto;
    }
    .todo-list li {
      display: flex; align-items: center; margin-bottom: 8px;
    }
    .todo-list li.completed label {
      text-decoration: line-through; color: #999;
    }
    .todo-list label {
      margin-left: 8px; flex: 1; cursor: pointer;
    }
    .delete-btn {
      margin-left: 8px; background: #e74c3c;
      color: white; border: none; padding: 4px 8px;
      border-radius: 4px; cursor: pointer;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
      }
      .main-content.shifted {
        margin-left: 0;
      }
      .todo-panel {
        max-width: 100%;
        margin-left: 0;
      }
      .toast {
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <button id="sidebarToggle" aria-label="Toggle menu">&#9776;</button>
    <div id="dateTime">Loading date/time...</div>
    <div class="profile" id="profileDiv" tabindex="0" aria-haspopup="true" aria-expanded="false" title="User menu">
      <div id="profileInitial" aria-label="User initial" role="img"></div>
      <div id="profileDropdown" role="menu" aria-label="Profile options">
        <a href="Change Password.html" role="menuitem">Settings</a>
        <button id="logoutBtn" role="menuitem">Logout</button>
      </div>
    </div>
  </div>

  <nav class="sidebar" id="sidebar" aria-label="Main navigation">
    <ul>
      <li class="menu-item"><a href="Home.html">üè† Dashboard</a></li>
      <li class="menu-item"><a href="Users.html">üë• Users</a></li>
      <li class="menu-item"><a href="tasks.html">üìã All Tasks</a></li>
      <li class="menu-item"><a href="Chart.html">üìä Charts</a></li>
      <li class="menu-item"><a href="AssignTask.html">üéØ Assign Task</a></li>
      <li class="menu-item"><a href="Genrate Report.html">üìà Report</a></li>
      
      <!-- Attendance Menu Item (Always visible now) -->
      <li class="menu-item">
        <a href="#" id="attendanceLink">‚è±Ô∏è Attendance</a>
      </li>
    </ul>
  </nav>

  <main class="main-content" id="mainContent">
    <h1>Welcome, <span id="userGreeting"></span>!</h1>
    <div class="todo-panel">
      <div class="todo-header">
        <button id="prevDayBtn">&lt; Prev</button>
        <div id="todoDateLabel">--</div>
        <button id="nextDayBtn">Next &gt;</button>
      </div>

      <div class="add-task">
        <input type="text" id="newTaskInput" placeholder="Add new task..." />
        <button id="addTaskBtn">Add</button>
      </div>

      <ul class="todo-list" id="todoList"></ul>
    </div>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDYhLNuJKj2ucwGimfddTfpTb32Y0c-bXg",
      authDomain: "mytask-96a79.firebaseapp.com",
      databaseURL: "https://mytask-96a79-default-rtdb.firebaseio.com",
      projectId: "mytask-96a79",
      storageBucket: "mytask-96a79.firebasestorage.app",
      messagingSenderId: "963509757773",
      appId: "1:963509757773:web:d9c81a108f5873702eb904",
      measurementId: "G-L9C1LTCZRN"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const username = sessionStorage.getItem("username") || "Guest";
    document.getElementById("userGreeting").textContent = username;
    document.getElementById("profileInitial").textContent = username[0]?.toUpperCase() || "?";

    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast';
      toast.classList.add(type, 'show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Profile dropdown functionality
    const profileDiv = document.getElementById("profileDiv");
    const dropdown = document.getElementById("profileDropdown");
    profileDiv.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = dropdown.style.display === "block";
      dropdown.style.display = isOpen ? "none" : "block";
      profileDiv.setAttribute('aria-expanded', !isOpen);
    });
    document.addEventListener("click", () => {
      dropdown.style.display = "none";
      profileDiv.setAttribute('aria-expanded', 'false');
    });
    document.getElementById("logoutBtn").addEventListener("click", () => {
      sessionStorage.clear();
      window.location.href = "index.html";
    });

    // Clock functionality
    function updateClock() {
      document.getElementById("dateTime").textContent = new Date().toLocaleString();
    }
    updateClock();
    setInterval(updateClock, 1000);

    // Todo list functionality
    const todoListEl = document.getElementById("todoList");
    const todoDateLabel = document.getElementById("todoDateLabel");
    const prevBtn = document.getElementById("prevDayBtn");
    const nextBtn = document.getElementById("nextDayBtn");
    const input = document.getElementById("newTaskInput");
    const addBtn = document.getElementById("addTaskBtn");

    let currentDate = new Date();
    let currentTasks = [];

    function fmt(date) {
      return date.toISOString().split("T")[0];
    }
    function rdt(date) {
      return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    async function loadTasks() {
      const key = fmt(currentDate);
      todoDateLabel.textContent = rdt(currentDate);
      todoListEl.innerHTML = "<li>Loading...</li>";
      try {
        const snap = await db.collection("userTasks").doc(username).get();
        const data = snap.exists ? snap.data() : {};
        currentTasks = (data.tasks && data.tasks[key]) || [];
        renderTasks();
      } catch {
        todoListEl.innerHTML = "<li>Error loading tasks.</li>";
      }
    }

    function renderTasks() {
      if (currentTasks.length === 0) {
        todoListEl.innerHTML = "<li>No tasks for this date.</li>";
        return;
      }
      todoListEl.innerHTML = "";
      currentTasks.forEach((task, i) => {
        const li = document.createElement("li");
        if (task.completed) li.classList.add("completed");

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = task.completed;
        const id = `task-${i}-${task.text.replace(/\s+/g, '-')}`;
        cb.id = id;

        cb.addEventListener("change", () => {
          task.completed = cb.checked;
          li.classList.toggle("completed", cb.checked);
          saveTasks();
        });

        const lbl = document.createElement("label");
        lbl.textContent = task.text;
        lbl.htmlFor = id;

        const del = document.createElement("button");
        del.textContent = "Delete";
        del.className = "delete-btn";
        del.onclick = () => {
          if (confirm("Delete this task?")) {
            currentTasks.splice(i, 1);
            saveTasks();
          }
        };

        li.append(cb, lbl, del);
        todoListEl.appendChild(li);
      });
    }

    async function saveTasks() {
      const key = fmt(currentDate);
      const payload = { tasks: { [key]: currentTasks } };
      await db.collection("userTasks").doc(username).set(payload, { merge: true });
      renderTasks();
    }

    prevBtn.onclick = () => { currentDate.setDate(currentDate.getDate() - 1); loadTasks(); };
    nextBtn.onclick = () => { currentDate.setDate(currentDate.getDate() + 1); loadTasks(); };
    addBtn.onclick = () => {
      const txt = input.value.trim();
      if (!txt) return;
      currentTasks.push({ text: txt, completed: false });
      input.value = "";
      saveTasks();
    };
    input.addEventListener("keypress", e => { if (e.key === "Enter") addBtn.click(); });

    loadTasks();

    // Sidebar toggle functionality
    const sidebarToggle = document.getElementById("sidebarToggle");
    const sidebar = document.getElementById("sidebar");
    const mainContent = document.getElementById("mainContent");

    sidebarToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      const isVisible = sidebar.classList.contains("visible");
      sidebar.classList.toggle("visible");
      mainContent.classList.toggle("shifted");
    });

    document.addEventListener("click", (e) => {
      if (
        sidebar.classList.contains("visible") &&
        !sidebar.contains(e.target) &&
        e.target !== sidebarToggle
      ) {
        sidebar.classList.remove("visible");
        mainContent.classList.remove("shifted");
      }
    });

    // Attendance link click handler
    document.getElementById('attendanceLink').addEventListener('click', async function(e) {
      e.preventDefault();
      
      try {
        const currentUser = sessionStorage.getItem("username");
        if (!currentUser) {
          showToast('Please log in to access attendance', 'error');
          return;
        }

        // Check if attendance is enabled for this user
        const userDoc = await db.collection("users").doc(currentUser).get();
        
        if (userDoc.exists) {
          const userData = userDoc.data();
          const attendanceEnabled = userData.attendanceEnabled || false;
          
          if (attendanceEnabled) {
            // Redirect to attendance page
            window.location.href = "Attendance.html";
          } else {
            showToast('Attendance feature is not enabled for your account. Please contact administrator.', 'warning');
          }
        } else {
          showToast('User not found in system', 'error');
        }
      } catch (error) {
        console.error("Error checking attendance setting:", error);
        showToast('Something went wrong. Please try again.', 'error');
      }
    });

    // Real-time listener for user setting changes (optional - for future enhancements)
    const currentUser = sessionStorage.getItem("username");
    if (currentUser) {
      db.collection("users").doc(currentUser).onSnapshot((doc) => {
        if (doc.exists) {
          // You can add real-time updates here if needed
          console.log("User settings updated");
        }
      });
    }
  </script>
</body>
</html>
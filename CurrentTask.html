<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Tasks</title>
  <style>
    body { 
      font-family: 'Segoe UI', sans-serif; 
      margin: 0; 
      background: #ecf0f1; 
      padding: 20px; 
    }
    .header { 
      background: white; 
      padding: 20px; 
      border-radius: 10px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
      margin-bottom: 20px;
    }
    .close-btn { 
      background: #e74c3c; 
      color: white; 
      border: none; 
      padding: 8px 14px; 
      font-weight: bold; 
      border-radius: 3px; 
      cursor: pointer; 
      float: right; 
    }
    h2 { 
      margin-top: 0; 
      color: #2c3e50; 
    }
    .user-info {
      background: #3498db;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .task-table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); 
      border-radius: 10px; 
      overflow: hidden; 
      background: white;
    }
    .task-table th, .task-table td { 
      padding: 12px; 
      text-align: left; 
      border-bottom: 1px solid #ecf0f1;
    }
    .task-table th { 
      background: #34495e; 
      color: white; 
      font-weight: 600;
    }
    .task-table tr { 
      transition: background-color 0.3s; 
    }
    .task-table tr:hover { 
      background: #f8f9fa; 
    }
    td.status { 
      font-weight: bold; 
      color: white; 
      border-radius: 20px; 
      padding: 6px 12px; 
      text-align: center;
      font-size: 12px;
    }
    .status.not-started { background: #95a5a6; }
    .status.in-progress { background: #3498db; }
    .status.pending { background: #f1c40f; color: black; }
    .status.complete { background: #27ae60; }
    
    .combo-box { 
      display: none; 
      animation: fadeIn 0.4s ease-in-out; 
      background: #f8f9fa;
    }
    .combo-box button { 
      margin: 5px; 
      padding: 8px 16px; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      transition: transform 0.3s ease; 
      color: white; 
      font-weight: bold; 
      font-size: 12px;
    }
    .combo-box button:hover { 
      transform: scale(1.05); 
    }
    .btn-start { background: #2980b9; }
    .btn-pending { background: #e67e22; }
    .btn-continue { background: #8e44ad; }
    .btn-complete { background: #27ae60; }
    .btn-logoff { background: #e74c3c; }
    .btn-login { background: #2ecc71; }
    
    .highlight { 
      border: 2px solid #fff; 
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.6); 
    }
    
    @keyframes fadeIn { 
      from { opacity:0; transform: scale(0.95); } 
      to { opacity:1; transform: scale(1); } 
    }
    
    /* Kanban View Styles */
    .view-toggle { 
      margin: 15px 0; 
      text-align: center; 
    }
    .view-toggle button { 
      padding: 10px 20px; 
      margin: 0 5px; 
      background: #3498db; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-weight: 600;
      transition: all 0.3s;
    }
    .view-toggle button.active { 
      background: #2c3e50; 
      transform: translateY(-2px);
    }
    .kanban-container { 
      display: none; 
      margin-top: 20px; 
    }
    .kanban-columns { 
      display: flex; 
      gap: 15px; 
      overflow-x: auto; 
      padding-bottom: 20px; 
    }
    .kanban-column { 
      flex: 1; 
      min-width: 300px; 
      background: #f8f9fa; 
      border-radius: 8px; 
      padding: 15px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
    }
    .kanban-column h3 { 
      margin-top: 0; 
      padding-bottom: 10px; 
      border-bottom: 2px solid #ddd; 
      color: #2c3e50;
    }
    .kanban-card { 
      background: white; 
      margin: 10px 0; 
      padding: 15px; 
      border-radius: 6px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      cursor: grab; 
      border-left: 4px solid #3498db;
    }
    .kanban-card:active { 
      cursor: grabbing; 
    }
    .kanban-card h4 { 
      margin: 0 0 8px 0; 
      color: #2c3e50;
    }
    .kanban-card p { 
      margin: 5px 0; 
      color: #7f8c8d;
      font-size: 14px;
    }
    .kanban-card .status { 
      display: inline-block; 
      padding: 3px 8px; 
      border-radius: 12px; 
      font-size: 11px; 
      color: white; 
      font-weight: bold;
    }
    
    /* Loading and Error States */
    .loading { 
      text-align: center; 
      padding: 40px; 
      color: #7f8c8d; 
    }
    .error { 
      text-align: center; 
      padding: 40px; 
      color: #e74c3c; 
      background: white;
      border-radius: 10px;
      margin: 20px 0;
    }
    .no-tasks { 
      text-align: center; 
      padding: 40px; 
      color: #7f8c8d; 
      background: white;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    /* Stats Cards */
    .stats-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stat-card {
      flex: 1;
      min-width: 150px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #2c3e50;
    }
    .stat-label {
      font-size: 14px;
      color: #7f8c8d;
      margin-top: 5px;
    }
  </style>
</head>
<body>

  <div class="header">
    <button class="close-btn" onclick="window.history.back()">‚Üê Back</button>
    <h2>üìã My Tasks</h2>
    <div class="user-info" id="userInfo">
      Loading user information...
    </div>
    
    <div class="stats-container" id="statsContainer">
      <div class="stat-card">
        <div class="stat-number" id="totalTasks">0</div>
        <div class="stat-label">Total Tasks</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="inProgressTasks">0</div>
        <div class="stat-label">In Progress</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pendingTasks">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="completedTasks">0</div>
        <div class="stat-label">Completed</div>
      </div>
    </div>
  </div>
  
  <div class="view-toggle">
    <button id="tableViewBtn" class="active" onclick="toggleView('table')">üìä Table View</button>
    <button id="kanbanViewBtn" onclick="toggleView('kanban')">üéØ Kanban View</button>
  </div>

  <!-- Table View -->
  <table class="task-table" id="taskTableView">
    <thead>
      <tr>
        <th>#</th>
        <th>Company</th>
        <th>Task</th>
        <th>Due Date</th>
        <th>Status</th>
        <th>Work Hours</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="task-body">
      <tr>
        <td colspan="7" class="loading">Loading your tasks...</td>
      </tr>
    </tbody>
  </table>

  <!-- Kanban View -->
  <div class="kanban-container" id="kanbanView">
    <div class="kanban-columns">
      <div class="kanban-column" data-status="not-started">
        <h3>‚è≥ Not Started</h3>
        <div class="kanban-cards" id="kanban-not-started">
          <div class="loading">Loading...</div>
        </div>
      </div>
      <div class="kanban-column" data-status="in-progress">
        <h3>üöÄ In Progress</h3>
        <div class="kanban-cards" id="kanban-in-progress">
          <div class="loading">Loading...</div>
        </div>
      </div>
      <div class="kanban-column" data-status="pending">
        <h3>‚è∏Ô∏è Pending</h3>
        <div class="kanban-cards" id="kanban-pending">
          <div class="loading">Loading...</div>
        </div>
      </div>
      <div class="kanban-column" data-status="complete">
        <h3>‚úÖ Completed</h3>
        <div class="kanban-cards" id="kanban-complete">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <script>
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDYhLNuJKj2ucwGimfddTfpTb32Y0c-bXg",
    authDomain: "mytask-96a79.firebaseapp.com",
    databaseURL: "https://mytask-96a79-default-rtdb.firebaseio.com",
    projectId: "mytask-96a79",
    storageBucket: "mytask-96a79.firebasestorage.app",
    messagingSenderId: "963509757773",
    appId: "1:963509757773:web:d9c81a108f5873702eb904",
    measurementId: "G-L9C1LTCZRN"
  };
  
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Global variables
  let currentTasks = [];
  let allUserTasks = [];
  const taskBody = document.getElementById("task-body");
  const userInfo = document.getElementById("userInfo");
  
  const statusLabels = {
    "not-started": {label:"Not Started", class:"not-started", icon:"‚è≥"},
    "in-progress": {label:"In Progress", class:"in-progress", icon:"üöÄ"},
    "pending": {label:"Pending", class:"pending", icon:"‚è∏Ô∏è"},
    "complete": {label:"Complete", class:"complete", icon:"‚úÖ"}
  };

  // Utility functions
  const now = () => firebase.firestore.Timestamp.now();

  function formatMs(ms) {
    if (!ms || ms === 0) return "00:00:00";
    const s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
  }

  function calcTimeDetails(sessions = []) {
    let totalWorkMs = 0;
    
    if (Array.isArray(sessions)) {
      sessions.forEach(sess => {
        const startMs = sess.start?.toDate ? sess.start.toDate().getTime() : null;
        const endMs = sess.end?.toDate ? sess.end.toDate().getTime() : now().toDate().getTime();
        
        if (startMs) {
          const workTime = endMs - startMs;
          totalWorkMs += workTime;
        }
      });
    }
    
    return { totalWorkMs };
  }

  function getActionButtons(statusKey, task) {
    const isLogoff = task.isLogoff || false;
    const hasActiveSession = task.workSessions?.some(s => !s.end) || false;

    if (statusKey === "complete") {
      return `<button class="btn-complete" disabled>Completed</button>`;
    }
    
    if (isLogoff) {
      return `
        <button class="btn-login" onclick="handleAction('login', '${task.id}')">Login</button>
        <button class="btn-continue" onclick="handleAction('continue', '${task.id}')">Resume</button>
      `;
    } else if (statusKey === "in-progress") {
      return `
        <button class="btn-pending" onclick="handleAction('pause', '${task.id}')">Pause</button>
        <button class="btn-logoff" onclick="handleAction('logoff', '${task.id}')">Logoff</button>
        <button class="btn-complete" onclick="handleAction('complete', '${task.id}')">Complete</button>
      `;
    } else if (statusKey === "pending") {
      return `<button class="btn-continue" onclick="handleAction('continue', '${task.id}')">Resume</button>`;
    } else if (statusKey === "not-started") {
      return `<button class="btn-start" onclick="handleAction('start', '${task.id}')">Start</button>`;
    }
    
    return `<em>No actions</em>`;
  }

  // Main functions
  async function loadUserTasks() {
    const username = sessionStorage.getItem("username") || localStorage.getItem("username");
    
    console.log("üîç Loading tasks for user:", username);
    
    if (!username) {
      showError("Please login to view your tasks");
      userInfo.innerHTML = "‚ùå Not logged in";
      return;
    }

    userInfo.innerHTML = `üëã Welcome, <strong>${username}</strong>`;
    
    try {
      // Load ALL tasks for this user (including completed)
      const snap = await db.collection("tasks")
        .where("Owner", "==", username)
        .get();

      console.log("üìä Found", snap.size, "total tasks");
      
      const arr = [];
      snap.forEach(doc => {
        const d = doc.data();
        arr.push({ id: doc.id, ...d });
      });

      allUserTasks = arr;
      currentTasks = arr.filter(task => task.Status !== "Complete");
      
      if (arr.length === 0) {
        showNoTasks();
      } else {
        updateStats(arr);
        renderTasks(arr);
      }
      
    } catch (err) {
      console.error("‚ùå Error loading tasks:", err);
      showError(`Failed to load tasks: ${err.message}`);
    }
  }

  function updateStats(tasks) {
    const total = tasks.length;
    const inProgress = tasks.filter(t => t.Status === "In Progress").length;
    const pending = tasks.filter(t => t.Status === "Pending").length;
    const complete = tasks.filter(t => t.Status === "Complete").length;
    const notStarted = tasks.filter(t => t.Status === "Not Started").length;

    document.getElementById('totalTasks').textContent = total;
    document.getElementById('inProgressTasks').textContent = inProgress;
    document.getElementById('pendingTasks').textContent = pending;
    document.getElementById('completedTasks').textContent = complete;
  }

  function renderTasks(tasks) {
    renderTableView(tasks);
    renderKanbanView(tasks);
  }

  function renderTableView(tasks) {
    if (tasks.length === 0) {
      taskBody.innerHTML = `<tr><td colspan="7" class="no-tasks">No tasks found</td></tr>`;
      return;
    }

    taskBody.innerHTML = "";
    tasks.forEach((task, idx) => {
      const sk = (task.Status || "not-started").toLowerCase().replace(/\s+/g, "-");
      const { totalWorkMs } = calcTimeDetails(task.workSessions || []);
      const statusInfo = statusLabels[sk] || statusLabels["not-started"];

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${task["Existing Company Name"] || "N/A"}</td>
        <td>${task["TYPE OF WORK"] || "No description"}</td>
        <td>${task["Due date"] || "No due date"}</td>
        <td class="status ${statusInfo.class}">
          ${statusInfo.icon} ${statusInfo.label}
        </td>
        <td>${formatMs(totalWorkMs)}</td>
        <td>${getActionButtons(sk, task)}</td>
      `;
      taskBody.appendChild(tr);
    });
  }

  function renderKanbanView(tasks) {
    const columns = ['not-started', 'in-progress', 'pending', 'complete'];
    
    columns.forEach(status => {
      const columnElement = document.getElementById(`kanban-${status}`);
      const statusTasks = tasks.filter(task => {
        const taskStatus = (task.Status || "not-started").toLowerCase().replace(/\s+/g, "-");
        return taskStatus === status;
      });
      
      if (statusTasks.length === 0) {
        columnElement.innerHTML = `<div class="no-tasks" style="padding: 20px; text-align: center; color: #95a5a6;">No tasks</div>`;
        return;
      }
      
      columnElement.innerHTML = "";
      statusTasks.forEach((task, idx) => {
        const sk = (task.Status || "not-started").toLowerCase().replace(/\s+/g, "-");
        const { totalWorkMs } = calcTimeDetails(task.workSessions || []);
        const statusInfo = statusLabels[sk] || statusLabels["not-started"];
        
        const card = document.createElement('div');
        card.className = 'kanban-card';
        card.innerHTML = `
          <h4>${task["TYPE OF WORK"] || "No Title"}</h4>
          <p><strong>Company:</strong> ${task["Existing Company Name"] || "N/A"}</p>
          <p><strong>Due:</strong> ${task["Due date"] || "No due date"}</p>
          <p><strong>Worked:</strong> ${formatMs(totalWorkMs)}</p>
          <span class="status ${statusInfo.class}">${statusInfo.icon} ${statusInfo.label}</span>
          <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 5px;">
            ${getActionButtons(sk, task)}
          </div>
        `;
        columnElement.appendChild(card);
      });
    });
  }

  async function handleAction(action, taskId) {
    const taskRef = db.collection("tasks").doc(taskId);
    const taskDoc = await taskRef.get();
    
    if (!taskDoc.exists) {
      alert("Task not found!");
      return;
    }

    const task = taskDoc.data();
    const sessions = Array.isArray(task.workSessions) ? [...task.workSessions] : [];
    const logoffSessions = Array.isArray(task.logoffSessions) ? [...task.logoffSessions] : [];
    const nowTs = now();

    try {
      switch (action) {
        case 'start':
          if (sessions.some(s => !s.end)) {
            alert("Task is already running!");
            return;
          }
          sessions.push({ start: nowTs, end: null });
          await taskRef.update({ 
            Status: "In Progress", 
            workSessions: sessions,
            isLogoff: false
          });
          alert("Task started! üöÄ");
          break;

        case 'pause':
          const runningIndex = sessions.findIndex(s => !s.end);
          if (runningIndex < 0) {
            alert("No active session to pause!");
            return;
          }
          sessions[runningIndex].end = nowTs;
          await taskRef.update({ 
            Status: "Pending", 
            workSessions: sessions,
            isLogoff: false
          });
          alert("Task paused! ‚è∏Ô∏è");
          break;

        case 'continue':
          if (sessions.some(s => !s.end)) {
            alert("Task is already running!");
            return;
          }
          sessions.push({ start: nowTs, end: null });
          await taskRef.update({ 
            Status: "In Progress", 
            workSessions: sessions,
            isLogoff: false
          });
          alert("Task resumed! ‚ñ∂Ô∏è");
          break;

        case 'logoff':
          const activeIndex = sessions.findIndex(s => !s.end);
          if (activeIndex < 0) {
            alert("No active session to logoff from!");
            return;
          }
          sessions[activeIndex].end = nowTs;
          logoffSessions.push({ start: nowTs, end: null });
          await taskRef.update({ 
            Status: "Pending", 
            workSessions: sessions,
            logoffSessions: logoffSessions,
            isLogoff: true
          });
          alert("Logged off! üîí");
          break;

        case 'login':
          const logoffIndex = logoffSessions.findIndex(s => !s.end);
          if (logoffIndex < 0) {
            alert("Not currently logged off!");
            return;
          }
          logoffSessions[logoffIndex].end = nowTs;
          sessions.push({ start: nowTs, end: null });
          await taskRef.update({ 
            Status: "In Progress", 
            workSessions: sessions,
            logoffSessions: logoffSessions,
            isLogoff: false
          });
          alert("Logged in! üîì");
          break;

        case 'complete':
          const activeSessionIndex = sessions.findIndex(s => !s.end);
          if (activeSessionIndex > -1) {
            sessions[activeSessionIndex].end = nowTs;
          }

          const activeLogoffIndex = logoffSessions.findIndex(s => !s.end);
          if (activeLogoffIndex > -1) {
            logoffSessions[activeLogoffIndex].end = nowTs;
          }

          const { totalWorkMs } = calcTimeDetails(sessions);
          const startTime = sessions[0]?.start || nowTs;
          const endTime = sessions.at(-1)?.end || nowTs;

          const userRemarks = prompt("Enter completion remarks:", task.Remarks || "");
          if (userRemarks === null) return;

          await taskRef.update({
            Status: "Complete",
            taskStart: startTime,
            taskEnd: endTime,
            workSessions: sessions,
            logoffSessions: logoffSessions,
            TimeStarted: startTime.toDate().toLocaleString(),
            TimeEnd: endTime.toDate().toLocaleString(),
            TotalWorkHours: formatMs(totalWorkMs),
            Remarks: userRemarks || "-",
            isLogoff: false
          });

          alert("Task completed! üéâ");
          break;
      }

      // Reload tasks after action
      loadUserTasks();

    } catch (error) {
      console.error("Action failed:", error);
      alert("Action failed! Please try again.");
    }
  }

  function toggleView(viewType) {
    if (viewType === 'table') {
      document.getElementById('taskTableView').style.display = 'table';
      document.getElementById('kanbanView').style.display = 'none';
      document.getElementById('tableViewBtn').classList.add('active');
      document.getElementById('kanbanViewBtn').classList.remove('active');
    } else {
      document.getElementById('taskTableView').style.display = 'none';
      document.getElementById('kanbanView').style.display = 'block';
      document.getElementById('tableViewBtn').classList.remove('active');
      document.getElementById('kanbanViewBtn').classList.add('active');
    }
  }

  function showError(message) {
    taskBody.innerHTML = `<tr><td colspan="7" class="error">${message}</td></tr>`;
  }

  function showNoTasks() {
    taskBody.innerHTML = `
      <tr>
        <td colspan="7" class="no-tasks">
          <h3>No Tasks Found</h3>
          <p>You don't have any tasks assigned to you yet.</p>
          <p><small>Contact your administrator to get assigned tasks.</small></p>
        </td>
      </tr>`;
    
    // Clear kanban view
    ['not-started', 'in-progress', 'pending', 'complete'].forEach(status => {
      document.getElementById(`kanban-${status}`).innerHTML = 
        '<div class="no-tasks" style="padding: 20px; text-align: center; color: #95a5a6;">No tasks</div>';
    });
  }

  // Initialize the application
  window.onload = function() {
    console.log("üöÄ Initializing task manager...");
    loadUserTasks();
    
    // Auto-refresh every 30 seconds
    setInterval(loadUserTasks, 30000);
  };
  </script>
</body>
</html>
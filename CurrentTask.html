<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Tasks</title>
  <style>
    body { 
      font-family: 'Segoe UI', sans-serif; 
      margin: 0; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px; 
      min-height: 100vh;
    }
    .header { 
      background: rgba(255, 255, 255, 0.95); 
      padding: 25px; 
      border-radius: 15px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
      margin-bottom: 25px;
      backdrop-filter: blur(10px);
    }
    .close-btn { 
      background: linear-gradient(135deg, #ff6b6b, #ee5a52); 
      color: white; 
      border: none; 
      padding: 10px 20px; 
      font-weight: bold; 
      border-radius: 8px; 
      cursor: pointer; 
      float: right; 
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      transition: all 0.3s ease;
    }
    .close-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }
    h2 { 
      margin-top: 0; 
      color: #2c3e50; 
      font-size: 28px;
      background: linear-gradient(135deg, #2c3e50, #3498db);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .user-info {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      font-size: 16px;
    }
    .task-table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); 
      border-radius: 15px; 
      overflow: hidden; 
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }
    .task-table th, .task-table td { 
      padding: 15px; 
      text-align: left; 
      border-bottom: 1px solid rgba(236, 240, 241, 0.5);
    }
    .task-table th { 
      background: linear-gradient(135deg, #34495e, #2c3e50); 
      color: white; 
      font-weight: 600;
      font-size: 14px;
    }
    .task-table tr { 
      transition: all 0.3s ease; 
    }
    .task-table tr:hover { 
      background: rgba(52, 152, 219, 0.05);
      transform: translateX(5px);
    }
    td.status { 
      font-weight: bold; 
      color: white; 
      border-radius: 25px; 
      padding: 8px 16px; 
      text-align: center;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .status.not-started { 
      background: linear-gradient(135deg, #95a5a6, #7f8c8d); 
    }
    .status.in-progress { 
      background: linear-gradient(135deg, #3498db, #2980b9); 
    }
    .status.pending { 
      background: linear-gradient(135deg, #f1c40f, #f39c12);
      color: white; 
    }
    
    /* Modern Button Styles */
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 11px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      color: white;
      min-width: 70px;
    }
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .btn-start { 
      background: linear-gradient(135deg, #2980b9, #3498db);
    }
    .btn-pause { 
      background: linear-gradient(135deg, #e67e22, #d35400);
    }
    .btn-continue { 
      background: linear-gradient(135deg, #8e44ad, #9b59b6);
    }
    .btn-logoff { 
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }
    .btn-login { 
      background: linear-gradient(135deg, #27ae60, #2ecc71);
    }
    .btn-complete { 
      background: linear-gradient(135deg, #27ae60, #2ecc71);
    }
    .action-btn:disabled {
      background: linear-gradient(135deg, #bdc3c7, #95a5a6);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    @keyframes fadeIn { 
      from { opacity:0; transform: translateY(10px); } 
      to { opacity:1; transform: translateY(0); } 
    }
    
    /* Kanban View Styles */
    .view-toggle { 
      margin: 20px 0; 
      text-align: center; 
    }
    .view-toggle button { 
      padding: 12px 25px; 
      margin: 0 8px; 
      background: rgba(255, 255, 255, 0.9);
      color: #2c3e50; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    .view-toggle button.active { 
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
    }
    .view-toggle button:hover:not(.active) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .kanban-container { 
      display: none; 
      margin-top: 25px; 
    }
    .kanban-columns { 
      display: flex; 
      gap: 20px; 
      overflow-x: auto; 
      padding-bottom: 25px; 
    }
    .kanban-column { 
      flex: 1; 
      min-width: 320px; 
      background: rgba(255, 255, 255, 0.9); 
      border-radius: 15px; 
      padding: 20px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    .kanban-column:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    .kanban-column h3 { 
      margin-top: 0; 
      padding-bottom: 15px; 
      border-bottom: 2px solid rgba(52, 152, 219, 0.3); 
      color: #2c3e50;
      font-size: 18px;
    }
    .kanban-card { 
      background: white; 
      margin: 12px 0; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
      cursor: grab; 
      border-left: 4px solid #3498db;
      transition: all 0.3s ease;
      animation: fadeIn 0.5s ease;
    }
    .kanban-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    .kanban-card:active { 
      cursor: grabbing; 
      transform: scale(0.98);
    }
    .kanban-card h4 { 
      margin: 0 0 10px 0; 
      color: #2c3e50;
      font-size: 16px;
    }
    .kanban-card p { 
      margin: 6px 0; 
      color: #7f8c8d;
      font-size: 13px;
    }
    .kanban-card .status { 
      display: inline-block; 
      padding: 4px 12px; 
      border-radius: 15px; 
      font-size: 11px; 
      color: white; 
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    /* Drag and Drop Styles */
    .drag-over {
      background: rgba(52, 152, 219, 0.1) !important;
      border: 2px dashed #3498db !important;
    }
    .dragging {
      opacity: 0.6;
      transform: rotate(5deg);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    /* Loading and Error States */
    .loading { 
      text-align: center; 
      padding: 40px; 
      color: #7f8c8d; 
      font-size: 16px;
    }
    .error { 
      text-align: center; 
      padding: 40px; 
      color: #e74c3c; 
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      margin: 20px 0;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .no-tasks { 
      text-align: center; 
      padding: 40px; 
      color: #7f8c8d; 
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      margin: 20px 0;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    
    /* Stats Cards */
    .stats-container {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .stat-card {
      flex: 1;
      min-width: 160px;
      background: rgba(255, 255, 255, 0.9);
      padding: 25px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      background: linear-gradient(135deg, #2c3e50, #3498db);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .stat-label {
      font-size: 14px;
      color: #7f8c8d;
      margin-top: 8px;
      font-weight: 600;
    }
  </style>
</head>
<body>

  <div class="header">
    <button class="close-btn" onclick="window.history.back()">‚Üê Back</button>
    <h2>üìã My Tasks Dashboard</h2>
    <div class="user-info" id="userInfo">
      Loading user information...
    </div>
    
    <div class="stats-container" id="statsContainer">
      <div class="stat-card">
        <div class="stat-number" id="totalTasks">0</div>
        <div class="stat-label">Total Tasks</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="inProgressTasks">0</div>
        <div class="stat-label">In Progress</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pendingTasks">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="notStartedTasks">0</div>
        <div class="stat-label">Not Started</div>
      </div>
    </div>
  </div>
  
  <div class="view-toggle">
    <button id="tableViewBtn" class="active" onclick="toggleView('table')">üìä Table View</button>
    <button id="kanbanViewBtn" onclick="toggleView('kanban')">üéØ Kanban View</button>
  </div>

  <!-- Table View -->
  <table class="task-table" id="taskTableView">
    <thead>
      <tr>
        <th>#</th>
        <th>Company</th>
        <th>Task</th>
        <th>Due Date</th>
        <th>Status</th>
        <th>Work Hours</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="task-body">
      <tr>
        <td colspan="7" class="loading">Loading your tasks...</td>
      </tr>
    </tbody>
  </table>

  <!-- Kanban View -->
  <div class="kanban-container" id="kanbanView">
    <div class="kanban-columns">
      <div class="kanban-column" data-status="not-started">
        <h3>‚è≥ Not Started</h3>
        <div class="kanban-cards" id="kanban-not-started">
          <div class="loading">Loading...</div>
        </div>
      </div>
      <div class="kanban-column" data-status="in-progress">
        <h3>üöÄ In Progress</h3>
        <div class="kanban-cards" id="kanban-in-progress">
          <div class="loading">Loading...</div>
        </div>
      </div>
      <div class="kanban-column" data-status="pending">
        <h3>‚è∏Ô∏è Pending</h3>
        <div class="kanban-cards" id="kanban-pending">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <script>
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDYhLNuJKj2ucwGimfddTfpTb32Y0c-bXg",
    authDomain: "mytask-96a79.firebaseapp.com",
    databaseURL: "https://mytask-96a79-default-rtdb.firebaseio.com",
    projectId: "mytask-96a79",
    storageBucket: "mytask-96a79.firebasestorage.app",
    messagingSenderId: "963509757773",
    appId: "1:963509757773:web:d9c81a108f5873702eb904",
    measurementId: "G-L9C1LTCZRN"
  };
  
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Global variables
  let currentTasks = [];
  let allUserTasks = [];
  const taskBody = document.getElementById("task-body");
  const userInfo = document.getElementById("userInfo");
  
  const statusLabels = {
    "not-started": {label:"Not Started", class:"not-started", icon:"‚è≥"},
    "in-progress": {label:"In Progress", class:"in-progress", icon:"üöÄ"},
    "pending": {label:"Pending", class:"pending", icon:"‚è∏Ô∏è"}
  };

  // Utility functions
  const now = () => firebase.firestore.Timestamp.now();

  function formatMs(ms) {
    if (!ms || ms === 0) return "00:00:00";
    const s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
  }

  function calcTimeDetails(sessions = []) {
    let totalWorkMs = 0;
    
    if (Array.isArray(sessions)) {
      sessions.forEach(sess => {
        const startMs = sess.start?.toDate ? sess.start.toDate().getTime() : null;
        const endMs = sess.end?.toDate ? sess.end.toDate().getTime() : now().toDate().getTime();
        
        if (startMs) {
          const workTime = endMs - startMs;
          totalWorkMs += workTime;
        }
      });
    }
    
    return { totalWorkMs };
  }

  function getActionButtons(statusKey, task) {
    const isLogoff = task.isLogoff || false;
    const hasActiveSession = task.workSessions?.some(s => !s.end) || false;

    if (statusKey === "complete") {
      return `<button class="action-btn btn-complete" disabled>Completed</button>`;
    }
    
    if (isLogoff) {
      return `
        <button class="action-btn btn-login" onclick="handleAction('login', '${task.id}')">Login</button>
        <button class="action-btn btn-continue" onclick="handleAction('continue', '${task.id}')">Resume</button>
      `;
    } else if (statusKey === "in-progress") {
      return `
        <button class="action-btn btn-pause" onclick="handleAction('pause', '${task.id}')">Pause</button>
        <button class="action-btn btn-logoff" onclick="handleAction('logoff', '${task.id}')">Logoff</button>
        <button class="action-btn btn-complete" onclick="handleAction('complete', '${task.id}')">Complete</button>
      `;
    } else if (statusKey === "pending") {
      return `<button class="action-btn btn-continue" onclick="handleAction('continue', '${task.id}')">Resume</button>`;
    } else if (statusKey === "not-started") {
      return `<button class="action-btn btn-start" onclick="handleAction('start', '${task.id}')">Start</button>`;
    }
    
    return `<em>No actions</em>`;
  }

  // Main functions
  async function loadUserTasks() {
    const username = sessionStorage.getItem("username") || localStorage.getItem("username");
    
    console.log("üîç Loading tasks for user:", username);
    
    if (!username) {
      showError("Please login to view your tasks");
      userInfo.innerHTML = "‚ùå Not logged in";
      return;
    }

    userInfo.innerHTML = `üëã Welcome, <strong>${username}</strong>`;
    
    try {
      // Load only active tasks (not completed)
      const snap = await db.collection("tasks")
        .where("Owner", "==", username)
        .where("Status", "in", ["Not Started", "In Progress", "Pending"])
        .get();

      console.log("üìä Found", snap.size, "active tasks");
      
      const arr = [];
      snap.forEach(doc => {
        const d = doc.data();
        arr.push({ id: doc.id, ...d });
      });

      allUserTasks = arr;
      currentTasks = arr;
      
      if (arr.length === 0) {
        showNoTasks();
      } else {
        updateStats(arr);
        renderTasks(arr);
      }
      
    } catch (err) {
      console.error("‚ùå Error loading tasks:", err);
      showError(`Failed to load tasks: ${err.message}`);
    }
  }

  function updateStats(tasks) {
    const total = tasks.length;
    const inProgress = tasks.filter(t => t.Status === "In Progress").length;
    const pending = tasks.filter(t => t.Status === "Pending").length;
    const notStarted = tasks.filter(t => t.Status === "Not Started").length;

    document.getElementById('totalTasks').textContent = total;
    document.getElementById('inProgressTasks').textContent = inProgress;
    document.getElementById('pendingTasks').textContent = pending;
    document.getElementById('notStartedTasks').textContent = notStarted;
  }

  function renderTasks(tasks) {
    renderTableView(tasks);
    renderKanbanView(tasks);
  }

  function renderTableView(tasks) {
    if (tasks.length === 0) {
      taskBody.innerHTML = `<tr><td colspan="7" class="no-tasks">No active tasks found</td></tr>`;
      return;
    }

    taskBody.innerHTML = "";
    tasks.forEach((task, idx) => {
      const sk = (task.Status || "not-started").toLowerCase().replace(/\s+/g, "-");
      const { totalWorkMs } = calcTimeDetails(task.workSessions || []);
      const statusInfo = statusLabels[sk] || statusLabels["not-started"];

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${task["Existing Company Name"] || "N/A"}</td>
        <td>${task["TYPE OF WORK"] || "No description"}</td>
        <td>${task["Due date"] || "No due date"}</td>
        <td class="status ${statusInfo.class}">
          ${statusInfo.icon} ${statusInfo.label}
        </td>
        <td>${formatMs(totalWorkMs)}</td>
        <td>
          <div class="action-buttons">
            ${getActionButtons(sk, task)}
          </div>
        </td>
      `;
      taskBody.appendChild(tr);
    });
  }

  function renderKanbanView(tasks) {
    const columns = ['not-started', 'in-progress', 'pending'];
    
    columns.forEach(status => {
      const columnElement = document.getElementById(`kanban-${status}`);
      const statusTasks = tasks.filter(task => {
        const taskStatus = (task.Status || "not-started").toLowerCase().replace(/\s+/g, "-");
        return taskStatus === status;
      });
      
      if (statusTasks.length === 0) {
        columnElement.innerHTML = `<div class="no-tasks" style="padding: 20px; text-align: center; color: #95a5a6;">No tasks</div>`;
        return;
      }
      
      columnElement.innerHTML = "";
      statusTasks.forEach((task, idx) => {
        const sk = (task.Status || "not-started").toLowerCase().replace(/\s+/g, "-");
        const { totalWorkMs } = calcTimeDetails(task.workSessions || []);
        const statusInfo = statusLabels[sk] || statusLabels["not-started"];
        
        const card = document.createElement('div');
        card.className = 'kanban-card';
        card.draggable = true;
        card.dataset.taskId = task.id;
        card.dataset.currentStatus = sk;
        
        card.innerHTML = `
          <h4>${task["TYPE OF WORK"] || "No Title"}</h4>
          <p><strong>Company:</strong> ${task["Existing Company Name"] || "N/A"}</p>
          <p><strong>Due:</strong> ${task["Due date"] || "No due date"}</p>
          <p><strong>Worked:</strong> ${formatMs(totalWorkMs)}</p>
          <span class="status ${statusInfo.class}">${statusInfo.icon} ${statusInfo.label}</span>
          <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
            ${getActionButtons(sk, task)}
          </div>
        `;
        
        // Add drag events
        setupDragAndDrop(card);
        columnElement.appendChild(card);
      });
    });
  }

  function setupDragAndDrop(card) {
    card.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', card.dataset.taskId);
      setTimeout(() => card.classList.add('dragging'), 0);
    });
    
    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      document.querySelectorAll('.kanban-column').forEach(col => {
        col.classList.remove('drag-over');
      });
    });
  }

  // Setup drag and drop for columns
  function setupColumnDragAndDrop() {
    document.querySelectorAll('.kanban-column').forEach(column => {
      column.addEventListener('dragover', (e) => {
        e.preventDefault();
        column.classList.add('drag-over');
      });
      
      column.addEventListener('dragleave', () => {
        column.classList.remove('drag-over');
      });
      
      column.addEventListener('drop', async (e) => {
        e.preventDefault();
        column.classList.remove('drag-over');
        
        const taskId = e.dataTransfer.getData('text/plain');
        const newStatus = column.dataset.status;
        
        await updateTaskStatus(taskId, newStatus);
      });
    });
  }

  async function updateTaskStatus(taskId, newStatus) {
    try {
      const statusMap = {
        'not-started': 'Not Started',
        'in-progress': 'In Progress',
        'pending': 'Pending'
      };

      const taskRef = db.collection("tasks").doc(taskId);
      const doc = await taskRef.get();
      
      if (!doc.exists) {
        alert("Task not found!");
        return;
      }

      const data = doc.data();
      const newStatusText = statusMap[newStatus];
      
      await taskRef.update({
        Status: newStatusText
      });

      console.log(`‚úÖ Task ${taskId} status updated to ${newStatusText}`);
      loadUserTasks(); // Refresh the view
      
    } catch (error) {
      console.error("‚ùå Error updating task status:", error);
      alert("Failed to update task status");
    }
  }

  async function handleAction(action, taskId) {
    const taskRef = db.collection("tasks").doc(taskId);
    const taskDoc = await taskRef.get();
    
    if (!taskDoc.exists) {
      alert("Task not found!");
      return;
    }

    const task = taskDoc.data();
    const sessions = Array.isArray(task.workSessions) ? [...task.workSessions] : [];
    const logoffSessions = Array.isArray(task.logoffSessions) ? [...task.logoffSessions] : [];
    const nowTs = now();

    try {
      switch (action) {
        case 'start':
          if (sessions.some(s => !s.end)) {
            alert("Task is already running!");
            return;
          }
          sessions.push({ start: nowTs, end: null });
          await taskRef.update({ 
            Status: "In Progress", 
            workSessions: sessions,
            isLogoff: false
          });
          alert("Task started! üöÄ");
          break;

        case 'pause':
          const runningIndex = sessions.findIndex(s => !s.end);
          if (runningIndex < 0) {
            alert("No active session to pause!");
            return;
          }
          sessions[runningIndex].end = nowTs;
          await taskRef.update({ 
            Status: "Pending", 
            workSessions: sessions,
            isLogoff: false
          });
          alert("Task paused! ‚è∏Ô∏è");
          break;

        case 'continue':
          if (sessions.some(s => !s.end)) {
            alert("Task is already running!");
            return;
          }
          sessions.push({ start: nowTs, end: null });
          await taskRef.update({ 
            Status: "In Progress", 
            workSessions: sessions,
            isLogoff: false
          });
          alert("Task resumed! ‚ñ∂Ô∏è");
          break;

        case 'logoff':
          const activeIndex = sessions.findIndex(s => !s.end);
          if (activeIndex < 0) {
            alert("No active session to logoff from!");
            return;
          }
          sessions[activeIndex].end = nowTs;
          logoffSessions.push({ start: nowTs, end: null });
          await taskRef.update({ 
            Status: "Pending", 
            workSessions: sessions,
            logoffSessions: logoffSessions,
            isLogoff: true
          });
          alert("Logged off! üîí");
          break;

        case 'login':
          const logoffIndex = logoffSessions.findIndex(s => !s.end);
          if (logoffIndex < 0) {
            alert("Not currently logged off!");
            return;
          }
          logoffSessions[logoffIndex].end = nowTs;
          sessions.push({ start: nowTs, end: null });
          await taskRef.update({ 
            Status: "In Progress", 
            workSessions: sessions,
            logoffSessions: logoffSessions,
            isLogoff: false
          });
          alert("Logged in! üîì");
          break;

        case 'complete':
          const activeSessionIndex = sessions.findIndex(s => !s.end);
          if (activeSessionIndex > -1) {
            sessions[activeSessionIndex].end = nowTs;
          }

          const activeLogoffIndex = logoffSessions.findIndex(s => !s.end);
          if (activeLogoffIndex > -1) {
            logoffSessions[activeLogoffIndex].end = nowTs;
          }

          const { totalWorkMs } = calcTimeDetails(sessions);
          const startTime = sessions[0]?.start || nowTs;
          const endTime = sessions.at(-1)?.end || nowTs;

          const userRemarks = prompt("Enter completion remarks:", task.Remarks || "");
          if (userRemarks === null) return;

          await taskRef.update({
            Status: "Complete",
            taskStart: startTime,
            taskEnd: endTime,
            workSessions: sessions,
            logoffSessions: logoffSessions,
            TimeStarted: startTime.toDate().toLocaleString(),
            TimeEnd: endTime.toDate().toLocaleString(),
            TotalWorkHours: formatMs(totalWorkMs),
            Remarks: userRemarks || "-",
            isLogoff: false
          });

          alert("Task completed! üéâ");
          break;
      }

      // Reload tasks after action
      loadUserTasks();

    } catch (error) {
      console.error("Action failed:", error);
      alert("Action failed! Please try again.");
    }
  }

  function toggleView(viewType) {
    if (viewType === 'table') {
      document.getElementById('taskTableView').style.display = 'table';
      document.getElementById('kanbanView').style.display = 'none';
      document.getElementById('tableViewBtn').classList.add('active');
      document.getElementById('kanbanViewBtn').classList.remove('active');
    } else {
      document.getElementById('taskTableView').style.display = 'none';
      document.getElementById('kanbanView').style.display = 'block';
      document.getElementById('tableViewBtn').classList.remove('active');
      document.getElementById('kanbanViewBtn').classList.add('active');
    }
  }

  function showError(message) {
    taskBody.innerHTML = `<tr><td colspan="7" class="error">${message}</td></tr>`;
  }

  function showNoTasks() {
    taskBody.innerHTML = `
      <tr>
        <td colspan="7" class="no-tasks">
          <h3>No Active Tasks</h3>
          <p>You don't have any active tasks assigned to you yet.</p>
          <p><small>Contact your administrator to get assigned tasks.</small></p>
        </td>
      </tr>`;
    
    // Clear kanban view
    ['not-started', 'in-progress', 'pending'].forEach(status => {
      document.getElementById(`kanban-${status}`).innerHTML = 
        '<div class="no-tasks" style="padding: 20px; text-align: center; color: #95a5a6;">No tasks</div>';
    });
  }

  // Initialize the application
  window.onload = function() {
    console.log("üöÄ Initializing task manager...");
    loadUserTasks();
    setupColumnDragAndDrop();
    
    // Auto-refresh every 30 seconds
    setInterval(loadUserTasks, 30000);
  };
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Management System</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --info: #4895ef;
            --warning: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary) !important;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .stats-card {
            text-align: center;
            padding: 20px 15px;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .leave-type {
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sick-leave {
            background-color: rgba(76, 201, 240, 0.2);
            border-left: 4px solid var(--success);
        }
        
        .casual-leave {
            background-color: rgba(72, 149, 239, 0.2);
            border-left: 4px solid var(--info);
        }
        
        .earned-leave {
            background-color: rgba(247, 37, 133, 0.1);
            border-left: 4px solid var(--warning);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .table th {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-approved {
            background-color: #d1edff;
            color: #0c5460;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 15px 15px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 12px 25px;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background-color: transparent;
        }
        
        .calendar-day {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin: 2px;
            cursor: pointer;
        }
        
        .calendar-day.leave {
            background-color: rgba(247, 37, 133, 0.2);
            color: var(--warning);
            font-weight: 600;
        }
        
        .calendar-day:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .holiday {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            font-weight: 600;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        footer {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px 0;
            margin-top: 40px;
            border-radius: 15px 15px 0 0;
        }
        
        .toast {
            position: fixed;
            top: 90px;
            right: 20px;
            z-index: 10000;
        }
        
        @media (max-width: 768px) {
            .stats-number {
                font-size: 2rem;
            }
            
            .nav-tabs .nav-link {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-calendar-alt me-2"></i>Leave Management System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="attendance.html">
                            <i class="fas fa-user-clock me-1"></i> Attendance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="fas fa-umbrella-beach me-1"></i> Leave
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="holiday.html">
                            <i class="fas fa-calendar-day me-1"></i> Holiday
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i> <span id="currentUserName">Loading...</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Toast Notification -->
    <div id="toast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage">Success!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="text-white">Leave Management</h2>
                <p class="text-light">Apply and manage your leave requests</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#applyLeaveModal">
                    <i class="fas fa-plus me-2"></i> Apply Leave
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <i class="fas fa-umbrella-beach fa-2x text-primary mb-2"></i>
                        <h5 class="card-title">Total Leave Balance</h5>
                        <div class="stats-number text-primary" id="totalLeaveBalance">0</div>
                        <p class="card-text">Days Available</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h5 class="card-title">Approved Leaves</h5>
                        <div class="stats-number text-success" id="approvedLeaves">0</div>
                        <p class="card-text">This Year</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h5 class="card-title">Pending Requests</h5>
                        <div class="stats-number text-warning" id="pendingLeaves">0</div>
                        <p class="card-text">Awaiting Approval</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <i class="fas fa-calendar-alt fa-2x text-info mb-2"></i>
                        <h5 class="card-title">Upcoming Holidays</h5>
                        <div class="stats-number text-info" id="upcomingHolidays">0</div>
                        <p class="card-text">Next 30 Days</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leave Balance Breakdown -->
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-pie me-2"></i> Leave Balance Breakdown
                    </div>
                    <div class="card-body" id="leaveBalanceContainer">
                        <!-- Leave balances will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calendar-check me-2"></i> Quick Actions
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#applyLeaveModal">
                            <i class="fas fa-plus me-2"></i> Apply for Leave
                        </button>
                        <button class="btn btn-outline-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#bulkLeaveModal">
                            <i class="fas fa-users me-2"></i> Bulk Leave Request
                        </button>
                        <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#leaveCalendarModal">
                            <i class="fas fa-calendar me-2"></i> View Leave Calendar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header p-0">
                        <ul class="nav nav-tabs" id="leaveTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="my-leaves-tab" data-bs-toggle="tab" data-bs-target="#my-leaves" type="button">
                                    <i class="fas fa-list me-2"></i> My Leaves
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="team-leaves-tab" data-bs-toggle="tab" data-bs-target="#team-leaves" type="button">
                                    <i class="fas fa-users me-2"></i> Team Leaves
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="leave-register-tab" data-bs-toggle="tab" data-bs-target="#leave-register" type="button">
                                    <i class="fas fa-clipboard-list me-2"></i> Leave Register
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button">
                                    <i class="fas fa-chart-bar me-2"></i> Reports
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="tab-content" id="leaveTabsContent">
                        <!-- My Leaves Tab -->
                        <div class="tab-pane fade show active" id="my-leaves" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Leave Type</th>
                                            <th>From Date</th>
                                            <th>To Date</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                            <th>Applied On</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myLeavesTableBody">
                                        <!-- My leaves will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Team Leaves Tab -->
                        <div class="tab-pane fade" id="team-leaves" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Leave Type</th>
                                            <th>From Date</th>
                                            <th>To Date</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teamLeavesTableBody">
                                        <!-- Team leaves will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Leave Register Tab -->
                        <div class="tab-pane fade" id="leave-register" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <select class="form-select" id="employeeFilter">
                                        <option value="all">All Employees</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="leaveTypeFilter">
                                        <option value="all">All Leave Types</option>
                                        <option value="sick">Sick Leave</option>
                                        <option value="casual">Casual Leave</option>
                                        <option value="earned">Earned Leave</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="statusFilter">
                                        <option value="all">All Status</option>
                                        <option value="approved">Approved</option>
                                        <option value="pending">Pending</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Employee ID</th>
                                            <th>Employee Name</th>
                                            <th>Leave Type</th>
                                            <th>From Date</th>
                                            <th>To Date</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                            <th>Approved By</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leaveRegisterTableBody">
                                        <!-- Leave register will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Reports Tab -->
                        <div class="tab-pane fade" id="reports" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-chart-bar me-2"></i> Leave Utilization Trend
                                        </div>
                                        <div class="card-body">
                                            <canvas id="leaveTrendChart" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-chart-pie me-2"></i> Leave Type Distribution
                                        </div>
                                        <div class="card-body">
                                            <canvas id="leaveTypeChart" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-download me-2"></i> Export Reports
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <div class="d-grid">
                                                        <button class="btn btn-outline-primary">
                                                            <i class="fas fa-file-pdf me-2"></i> Export as PDF
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <div class="d-grid">
                                                        <button class="btn btn-outline-success">
                                                            <i class="fas fa-file-excel me-2"></i> Export as Excel
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <div class="d-grid">
                                                        <button class="btn btn-outline-info">
                                                            <i class="fas fa-print me-2"></i> Print Report
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Apply Leave Modal -->
    <div class="modal fade" id="applyLeaveModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-white"><i class="fas fa-plus me-2"></i> Apply for Leave</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="applyLeaveForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Leave Type</label>
                                <select class="form-select" id="leaveTypeSelect" required>
                                    <option value="" selected disabled>Select Leave Type</option>
                                    <option value="sick">Sick Leave</option>
                                    <option value="casual">Casual Leave</option>
                                    <option value="earned">Earned Leave</option>
                                    <option value="maternity">Maternity Leave</option>
                                    <option value="paternity">Paternity Leave</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Available Balance</label>
                                <input type="text" class="form-control" id="availableBalance" value="Loading..." disabled>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="fromDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="toDate" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Duration</label>
                                <input type="text" class="form-control" id="duration" value="0 Days" disabled>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Reporting Manager</label>
                                <input type="text" class="form-control" id="reportingManager" value="Loading..." disabled>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason for Leave</label>
                            <textarea class="form-control" id="reason" rows="4" placeholder="Please provide a reason for your leave" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contact Number During Leave</label>
                            <input type="text" class="form-control" id="contactNumber" placeholder="Enter your contact number" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Upload Supporting Document (Optional)</label>
                            <input type="file" class="form-control" id="supportingDoc">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitLeaveBtn">Submit Leave Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Leave Modal -->
    <div class="modal fade" id="editLeaveModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-white"><i class="fas fa-edit me-2"></i> Edit Leave Request</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editLeaveForm">
                        <input type="hidden" id="editLeaveId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Leave Type</label>
                                <select class="form-select" id="editLeaveTypeSelect" required>
                                    <option value="" selected disabled>Select Leave Type</option>
                                    <option value="sick">Sick Leave</option>
                                    <option value="casual">Casual Leave</option>
                                    <option value="earned">Earned Leave</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Available Balance</label>
                                <input type="text" class="form-control" id="editAvailableBalance" value="Loading..." disabled>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="editFromDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="editToDate" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Duration</label>
                                <input type="text" class="form-control" id="editDuration" value="0 Days" disabled>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Reporting Manager</label>
                                <input type="text" class="form-control" id="editReportingManager" value="Loading..." disabled>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason for Leave</label>
                            <textarea class="form-control" id="editReason" rows="4" placeholder="Please provide a reason for your leave" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contact Number During Leave</label>
                            <input type="text" class="form-control" id="editContactNumber" placeholder="Enter your contact number" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateLeaveBtn">Update Leave Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Leave Modal -->
    <div class="modal fade" id="bulkLeaveModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-white"><i class="fas fa-users me-2"></i> Bulk Leave Request</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkLeaveForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Leave Type</label>
                                <select class="form-select" id="bulkLeaveTypeSelect" required>
                                    <option value="" selected disabled>Select Leave Type</option>
                                    <option value="festival">Festival Holiday</option>
                                    <option value="event">Company Event</option>
                                    <option value="training">Team Training</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Department</label>
                                <select class="form-select" id="bulkDepartmentSelect">
                                    <option value="all" selected>All Departments</option>
                                    <option value="development">Development</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="sales">Sales</option>
                                    <option value="hr">HR</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="bulkFromDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="bulkToDate" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Employees</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllEmployees">
                                <label class="form-check-label" for="selectAllEmployees">Select All Employees</label>
                            </div>
                            <div class="mt-2" id="employeesCheckboxContainer">
                                <!-- Employees checkboxes will be loaded here -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason for Bulk Leave</label>
                            <textarea class="form-control" id="bulkReason" rows="4" placeholder="Please provide a reason for the bulk leave" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitBulkLeaveBtn">Submit Bulk Leave Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Calendar Modal -->
    <div class="modal fade" id="leaveCalendarModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-white"><i class="fas fa-calendar me-2"></i> Leave Calendar</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 id="calendarMonth">October 2025</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" id="prevMonthBtn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="nextMonthBtn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered text-center" id="leaveCalendar">
                            <!-- Calendar will be generated here -->
                        </table>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-primary me-2" style="width: 20px; height: 20px; border-radius: 4px;"></div>
                            <span>Today</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="holiday me-2" style="width: 20px; height: 20px; border-radius: 4px;"></div>
                            <span>Holiday</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="leave me-2" style="width: 20px; height: 20px; border-radius: 4px;"></div>
                            <span>Leave</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Leave Management System</h5>
                    <p>Streamlining leave requests and approvals for your organization.</p>
                </div>
                <div class="col-md-6 text-end">
                    <p>&copy; 2025 Your Company. All rights reserved.</p>
                    <div>
                        <a href="#" class="text-decoration-none me-3">Privacy Policy</a>
                        <a href="#" class="text-decoration-none">Terms of Service</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYhLNuJKj2ucwGimfddTfpTb32Y0c-bXg",
            authDomain: "mytask-96a79.firebaseapp.com",
            databaseURL: "https://mytask-96a79-default-rtdb.firebaseio.com",
            projectId: "mytask-96a79",
            storageBucket: "mytask-96a79.firebasestorage.app",
            messagingSenderId: "963509757773",
            appId: "1:963509757773:web:d9c81a108f5873702eb904",
            measurementId: "G-L9C1LTCZRN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let userData = null;
        let userRole = null;
        let currentLeaveId = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toastMessage.textContent = message;
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Initialize the application
        async function initializeApp() {
            // Get user from session storage
            const username = sessionStorage.getItem("username");
            if (!username) {
                showToast('Please login first', 'error');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            document.getElementById('currentUserName').textContent = username;

            // Find user in Firestore
            try {
                const userQuery = await db.collection("users")
                    .where("username", "==", username)
                    .get();

                if (userQuery.empty) {
                    showToast('User not found in system', 'error');
                    return;
                }

                userData = userQuery.docs[0].data();
                currentUser = userQuery.docs[0].id;
                userRole = userData.role || 'User';

                // Load user data
                await loadUserData();
                
                // Load leaves data
                await loadMyLeaves();
                await loadTeamLeaves();
                await loadLeaveRegister();
                
                // Initialize charts
                initializeCharts();
                
                // Initialize calendar
                initializeCalendar();

            } catch (error) {
                console.error("Error initializing app:", error);
                showToast('Error loading user data: ' + error.message, 'error');
            }
        }

        // Load user data including leave balances
        async function loadUserData() {
            try {
                // Set user info in the form
                document.getElementById('reportingManager').value = userData.manager || 'Not assigned';
                document.getElementById('editReportingManager').value = userData.manager || 'Not assigned';
                
                // Load leave balances
                const leaveBalanceQuery = await db.collection("leaveBalances")
                    .where("userId", "==", currentUser)
                    .get();

                if (!leaveBalanceQuery.empty) {
                    const leaveBalances = leaveBalanceQuery.docs[0].data();
                    updateLeaveBalancesUI(leaveBalances);
                } else {
                    // Create default leave balances if not exists
                    const defaultBalances = {
                        userId: currentUser,
                        username: userData.username,
                        sick: 12,
                        casual: 10,
                        earned: 15,
                        maternity: 180,
                        paternity: 15
                    };
                    
                    await db.collection("leaveBalances").add(defaultBalances);
                    updateLeaveBalancesUI(defaultBalances);
                }

                // Load leave statistics
                await updateLeaveStatistics();

            } catch (error) {
                console.error("Error loading user data:", error);
                showToast('Error loading user data', 'error');
            }
        }

        // Update leave balances in UI
        function updateLeaveBalancesUI(balances) {
            // Update stats cards
            const totalBalance = balances.sick + balances.casual + balances.earned;
            document.getElementById('totalLeaveBalance').textContent = totalBalance;
            
            // Update leave balance breakdown
            const balanceContainer = document.getElementById('leaveBalanceContainer');
            balanceContainer.innerHTML = `
                <div class="leave-type sick-leave">
                    <div>
                        <h6 class="mb-0">Sick Leave</h6>
                        <small>12 days per year</small>
                    </div>
                    <div class="text-end">
                        <h5 class="mb-0">${balances.sick}</h5>
                        <small>Days Available</small>
                    </div>
                </div>
                <div class="leave-type casual-leave">
                    <div>
                        <h6 class="mb-0">Casual Leave</h6>
                        <small>10 days per year</small>
                    </div>
                    <div class="text-end">
                        <h5 class="mb-0">${balances.casual}</h5>
                        <small>Days Available</small>
                    </div>
                </div>
                <div class="leave-type earned-leave">
                    <div>
                        <h6 class="mb-0">Earned Leave</h6>
                        <small>15 days per year</small>
                    </div>
                    <div class="text-end">
                        <h5 class="mb-0">${balances.earned}</h5>
                        <small>Days Available</small>
                    </div>
                </div>
            `;
        }

        // Update leave statistics
        async function updateLeaveStatistics() {
            try {
                // Count approved leaves
                const approvedQuery = await db.collection("leaves")
                    .where("userId", "==", currentUser)
                    .where("status", "==", "approved")
                    .get();
                
                document.getElementById('approvedLeaves').textContent = approvedQuery.size;
                
                // Count pending leaves
                const pendingQuery = await db.collection("leaves")
                    .where("userId", "==", currentUser)
                    .where("status", "==", "pending")
                    .get();
                
                document.getElementById('pendingLeaves').textContent = pendingQuery.size;
                
                // Count upcoming holidays (dummy data for now)
                document.getElementById('upcomingHolidays').textContent = "3";
                
            } catch (error) {
                console.error("Error updating statistics:", error);
            }
        }

        // Load my leaves
        async function loadMyLeaves() {
            try {
                const leavesQuery = await db.collection("leaves")
                    .where("userId", "==", currentUser)
                    .orderBy("appliedDate", "desc")
                    .get();

                const tbody = document.getElementById('myLeavesTableBody');
                tbody.innerHTML = '';

                if (leavesQuery.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No leave records found</td></tr>';
                    return;
                }

                leavesQuery.forEach(doc => {
                    const leave = doc.data();
                    const row = createMyLeaveRow(leave, doc.id);
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error("Error loading my leaves:", error);
                showToast('Error loading leave data', 'error');
            }
        }

        // Create row for my leaves table
        function createMyLeaveRow(leave, leaveId) {
            const row = document.createElement('tr');
            
            // Format dates
            const fromDate = new Date(leave.fromDate).toLocaleDateString('en-US');
            const toDate = new Date(leave.toDate).toLocaleDateString('en-US');
            const appliedDate = new Date(leave.appliedDate).toLocaleDateString('en-US');
            
            // Calculate duration
            const from = new Date(leave.fromDate);
            const to = new Date(leave.toDate);
            const duration = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;
            
            // Get status badge
            let statusBadge = '';
            if (leave.status === 'pending') {
                statusBadge = '<span class="status-pending">Pending</span>';
            } else if (leave.status === 'approved') {
                statusBadge = '<span class="status-approved">Approved</span>';
            } else {
                statusBadge = '<span class="status-rejected">Rejected</span>';
            }
            
            // Get leave type icon
            let typeIcon = '';
            if (leave.type === 'sick') {
                typeIcon = '<i class="fas fa-stethoscope text-success me-2"></i> Sick Leave';
            } else if (leave.type === 'casual') {
                typeIcon = '<i class="fas fa-umbrella-beach text-info me-2"></i> Casual Leave';
            } else {
                typeIcon = '<i class="fas fa-plane text-warning me-2"></i> Earned Leave';
            }
            
            // Action buttons - only show for pending leaves
            let actionButtons = '';
            if (leave.status === 'pending') {
                actionButtons = `
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editLeave('${leaveId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteLeave('${leaveId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            } else {
                actionButtons = `
                    <button class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i>
                    </button>
                `;
            }
            
            row.innerHTML = `
                <td>${typeIcon}</td>
                <td>${fromDate}</td>
                <td>${toDate}</td>
                <td>${duration} Days</td>
                <td>${statusBadge}</td>
                <td>${appliedDate}</td>
                <td>${actionButtons}</td>
            `;

            return row;
        }

        // Load team leaves (for managers)
        async function loadTeamLeaves() {
            try {
                // If user is not a manager, show empty state
                if (userRole !== 'manager' && userRole !== 'admin') {
                    const tbody = document.getElementById('teamLeavesTableBody');
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">You do not have permission to view team leaves</td></tr>';
                    return;
                }

                const leavesQuery = await db.collection("leaves")
                    .where("status", "==", "pending")
                    .orderBy("appliedDate", "desc")
                    .get();

                const tbody = document.getElementById('teamLeavesTableBody');
                tbody.innerHTML = '';

                if (leavesQuery.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No pending leave requests</td></tr>';
                    return;
                }

                leavesQuery.forEach(doc => {
                    const leave = doc.data();
                    const row = createTeamLeaveRow(leave, doc.id);
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error("Error loading team leaves:", error);
            }
        }

        // Create row for team leaves table
        function createTeamLeaveRow(leave, leaveId) {
            const row = document.createElement('tr');
            
            // Format dates
            const fromDate = new Date(leave.fromDate).toLocaleDateString('en-US');
            const toDate = new Date(leave.toDate).toLocaleDateString('en-US');
            
            // Calculate duration
            const from = new Date(leave.fromDate);
            const to = new Date(leave.toDate);
            const duration = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;
            
            // Get leave type
            let leaveType = '';
            if (leave.type === 'sick') {
                leaveType = 'Sick Leave';
            } else if (leave.type === 'casual') {
                leaveType = 'Casual Leave';
            } else {
                leaveType = 'Earned Leave';
            }
            
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <img src="https://i.pravatar.cc/40?img=1" class="rounded-circle me-2" alt="Avatar">
                        <div>${leave.username}</div>
                    </div>
                </td>
                <td>${leaveType}</td>
                <td>${fromDate}</td>
                <td>${toDate}</td>
                <td>${duration} Days</td>
                <td><span class="status-pending">Pending</span></td>
                <td>
                    <button class="btn btn-sm btn-success me-1" onclick="approveLeave('${leaveId}')">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="rejectLeave('${leaveId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;

            return row;
        }

        // Load leave register
        async function loadLeaveRegister() {
            try {
                let leavesQuery;
                
                if (userRole === 'admin' || userRole === 'manager') {
                    // Admins and managers can see all leaves
                    leavesQuery = await db.collection("leaves")
                        .orderBy("appliedDate", "desc")
                        .get();
                } else {
                    // Regular users can only see their own leaves
                    leavesQuery = await db.collection("leaves")
                        .where("userId", "==", currentUser)
                        .orderBy("appliedDate", "desc")
                        .get();
                }

                const tbody = document.getElementById('leaveRegisterTableBody');
                tbody.innerHTML = '';

                if (leavesQuery.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No leave records found</td></tr>';
                    return;
                }

                // Update employee filter if user is admin/manager
                if (userRole === 'admin' || userRole === 'manager') {
                    const employeeFilter = document.getElementById('employeeFilter');
                    employeeFilter.innerHTML = '<option value="all">All Employees</option>';
                    
                    const employees = new Set();
                    leavesQuery.forEach(doc => {
                        const leave = doc.data();
                        employees.add(leave.username);
                    });
                    
                    employees.forEach(employee => {
                        employeeFilter.innerHTML += `<option value="${employee}">${employee}</option>`;
                    });
                }

                leavesQuery.forEach(doc => {
                    const leave = doc.data();
                    const row = createLeaveRegisterRow(leave);
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error("Error loading leave register:", error);
            }
        }

        // Create row for leave register table
        function createLeaveRegisterRow(leave) {
            const row = document.createElement('tr');
            
            // Format dates
            const fromDate = new Date(leave.fromDate).toLocaleDateString('en-US');
            const toDate = new Date(leave.toDate).toLocaleDateString('en-US');
            
            // Calculate duration
            const from = new Date(leave.fromDate);
            const to = new Date(leave.toDate);
            const duration = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;
            
            // Get status badge
            let statusBadge = '';
            if (leave.status === 'pending') {
                statusBadge = '<span class="status-pending">Pending</span>';
            } else if (leave.status === 'approved') {
                statusBadge = '<span class="status-approved">Approved</span>';
            } else {
                statusBadge = '<span class="status-rejected">Rejected</span>';
            }
            
            // Get leave type
            let leaveType = '';
            if (leave.type === 'sick') {
                leaveType = 'Sick Leave';
            } else if (leave.type === 'casual') {
                leaveType = 'Casual Leave';
            } else {
                leaveType = 'Earned Leave';
            }
            
            row.innerHTML = `
                <td>${leave.empId || 'N/A'}</td>
                <td>${leave.username}</td>
                <td>${leaveType}</td>
                <td>${fromDate}</td>
                <td>${toDate}</td>
                <td>${duration} Days</td>
                <td>${statusBadge}</td>
                <td>${leave.approvedBy || '-'}</td>
            `;

            return row;
        }

        // Apply for leave
        document.getElementById('submitLeaveBtn').addEventListener('click', async function() {
            const form = document.getElementById('applyLeaveForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const leaveType = document.getElementById('leaveTypeSelect').value;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const reason = document.getElementById('reason').value;
            const contactNumber = document.getElementById('contactNumber').value;

            // Calculate duration
            const from = new Date(fromDate);
            const to = new Date(toDate);
            const duration = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;

            try {
                // Create leave record
                const leaveData = {
                    userId: currentUser,
                    username: userData.username,
                    empId: userData.empId,
                    type: leaveType,
                    fromDate: fromDate,
                    toDate: toDate,
                    duration: duration,
                    reason: reason,
                    contactNumber: contactNumber,
                    status: 'pending',
                    appliedDate: new Date().toISOString(),
                    manager: userData.manager || 'Not assigned'
                };

                await db.collection("leaves").add(leaveData);
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('applyLeaveModal')).hide();
                form.reset();
                
                // Show success message
                showToast('Leave application submitted successfully!');
                
                // Reload data
                await loadMyLeaves();
                await updateLeaveStatistics();

            } catch (error) {
                console.error("Error applying for leave:", error);
                showToast('Error submitting leave application', 'error');
            }
        });

        // Edit leave
        async function editLeave(leaveId) {
            try {
                const leaveDoc = await db.collection("leaves").doc(leaveId).get();
                if (!leaveDoc.exists) {
                    showToast('Leave request not found', 'error');
                    return;
                }

                const leave = leaveDoc.data();
                currentLeaveId = leaveId;

                // Populate edit form
                document.getElementById('editLeaveId').value = leaveId;
                document.getElementById('editLeaveTypeSelect').value = leave.type;
                document.getElementById('editFromDate').value = leave.fromDate;
                document.getElementById('editToDate').value = leave.toDate;
                document.getElementById('editDuration').value = leave.duration + ' Days';
                document.getElementById('editReason').value = leave.reason;
                document.getElementById('editContactNumber').value = leave.contactNumber;

                // Load available balance for the selected leave type
                const balanceQuery = await db.collection("leaveBalances")
                    .where("userId", "==", currentUser)
                    .get();

                if (!balanceQuery.empty) {
                    const balances = balanceQuery.docs[0].data();
                    let availableBalance = 0;
                    
                    if (leave.type === 'sick') availableBalance = balances.sick;
                    else if (leave.type === 'casual') availableBalance = balances.casual;
                    else if (leave.type === 'earned') availableBalance = balances.earned;
                    
                    document.getElementById('editAvailableBalance').value = availableBalance + ' Days';
                }

                // Show edit modal
                const editModal = new bootstrap.Modal(document.getElementById('editLeaveModal'));
                editModal.show();

            } catch (error) {
                console.error("Error loading leave for edit:", error);
                showToast('Error loading leave details', 'error');
            }
        }

        // Update leave
        document.getElementById('updateLeaveBtn').addEventListener('click', async function() {
            const form = document.getElementById('editLeaveForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const leaveType = document.getElementById('editLeaveTypeSelect').value;
            const fromDate = document.getElementById('editFromDate').value;
            const toDate = document.getElementById('editToDate').value;
            const reason = document.getElementById('editReason').value;
            const contactNumber = document.getElementById('editContactNumber').value;

            // Calculate duration
            const from = new Date(fromDate);
            const to = new Date(toDate);
            const duration = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;

            try {
                // Update leave record
                const updateData = {
                    type: leaveType,
                    fromDate: fromDate,
                    toDate: toDate,
                    duration: duration,
                    reason: reason,
                    contactNumber: contactNumber,
                    lastUpdated: new Date().toISOString()
                };

                await db.collection("leaves").doc(currentLeaveId).update(updateData);
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('editLeaveModal')).hide();
                
                // Show success message
                showToast('Leave request updated successfully!');
                
                // Reload data
                await loadMyLeaves();

            } catch (error) {
                console.error("Error updating leave:", error);
                showToast('Error updating leave request', 'error');
            }
        });

        // Delete leave
        async function deleteLeave(leaveId) {
            if (!confirm('Are you sure you want to delete this leave request?')) {
                return;
            }

            try {
                await db.collection("leaves").doc(leaveId).delete();
                showToast('Leave request deleted successfully!');
                await loadMyLeaves();
                await updateLeaveStatistics();
            } catch (error) {
                console.error("Error deleting leave:", error);
                showToast('Error deleting leave request', 'error');
            }
        }

        // Approve leave (for managers)
        async function approveLeave(leaveId) {
            try {
                await db.collection("leaves").doc(leaveId).update({
                    status: 'approved',
                    approvedBy: userData.username,
                    approvedDate: new Date().toISOString()
                });
                
                showToast('Leave request approved!');
                await loadTeamLeaves();
                await loadLeaveRegister();
            } catch (error) {
                console.error("Error approving leave:", error);
                showToast('Error approving leave request', 'error');
            }
        }

        // Reject leave (for managers)
        async function rejectLeave(leaveId) {
            try {
                await db.collection("leaves").doc(leaveId).update({
                    status: 'rejected',
                    approvedBy: userData.username,
                    approvedDate: new Date().toISOString()
                });
                
                showToast('Leave request rejected!');
                await loadTeamLeaves();
                await loadLeaveRegister();
            } catch (error) {
                console.error("Error rejecting leave:", error);
                showToast('Error rejecting leave request', 'error');
            }
        }

        // Initialize charts
        function initializeCharts() {
            // Leave Trend Chart
            const trendCtx = document.getElementById('leaveTrendChart').getContext('2d');
            const trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'],
                    datasets: [{
                        label: 'Leaves Taken',
                        data: [2, 3, 1, 4, 2, 3, 2, 1, 3, 2],
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Leaves'
                            }
                        }
                    }
                }
            });

            // Leave Type Chart
            const typeCtx = document.getElementById('leaveTypeChart').getContext('2d');
            const typeChart = new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Sick Leave', 'Casual Leave', 'Earned Leave'],
                    datasets: [{
                        data: [40, 35, 25],
                        backgroundColor: [
                            '#4cc9f0',
                            '#4895ef',
                            '#f72585'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Initialize calendar
        function initializeCalendar() {
            updateCalendar();
            
            // Add event listeners for calendar navigation
            document.getElementById('prevMonthBtn').addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                updateCalendar();
            });
            
            document.getElementById('nextMonthBtn').addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                updateCalendar();
            });
        }

        // Update calendar display
        function updateCalendar() {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            
            document.getElementById('calendarMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Generate calendar (simplified version)
            const calendar = document.getElementById('leaveCalendar');
            calendar.innerHTML = `
                <thead>
                    <tr>
                        <th>Sun</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>6</td>
                        <td>7</td>
                        <td>8</td>
                        <td>9</td>
                        <td>10</td>
                        <td>11</td>
                    </tr>
                    <tr>
                        <td>12</td>
                        <td>13</td>
                        <td>14</td>
                        <td>15</td>
                        <td class="holiday">16</td>
                        <td>17</td>
                        <td>18</td>
                    </tr>
                    <tr>
                        <td>19</td>
                        <td>20</td>
                        <td class="leave">21</td>
                        <td class="leave">22</td>
                        <td class="leave">23</td>
                        <td>24</td>
                        <td>25</td>
                    </tr>
                    <tr>
                        <td>26</td>
                        <td>27</td>
                        <td>28</td>
                        <td>29</td>
                        <td>30</td>
                        <td>31</td>
                        <td></td>
                    </tr>
                </tbody>
            `;
        }

        // Logout function
        function logout() {
            sessionStorage.removeItem("username");
            window.location.href = "index.html";
        }

        // Calculate duration when dates change
        document.getElementById('fromDate').addEventListener('change', calculateDuration);
        document.getElementById('toDate').addEventListener('change', calculateDuration);
        document.getElementById('editFromDate').addEventListener('change', calculateEditDuration);
        document.getElementById('editToDate').addEventListener('change', calculateEditDuration);

        function calculateDuration() {
            const fromDate = new Date(document.getElementById('fromDate').value);
            const toDate = new Date(document.getElementById('toDate').value);
            
            if (fromDate && toDate && fromDate <= toDate) {
                const diffTime = Math.abs(toDate - fromDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('duration').value = diffDays + ' Days';
            }
        }

        function calculateEditDuration() {
            const fromDate = new Date(document.getElementById('editFromDate').value);
            const toDate = new Date(document.getElementById('editToDate').value);
            
            if (fromDate && toDate && fromDate <= toDate) {
                const diffTime = Math.abs(toDate - fromDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('editDuration').value = diffDays + ' Days';
            }
        }

        // Update available balance when leave type changes
        document.getElementById('leaveTypeSelect').addEventListener('change', updateAvailableBalance);
        document.getElementById('editLeaveTypeSelect').addEventListener('change', updateEditAvailableBalance);

        async function updateAvailableBalance() {
            const leaveType = document.getElementById('leaveTypeSelect').value;
            if (!leaveType) return;

            try {
                const balanceQuery = await db.collection("leaveBalances")
                    .where("userId", "==", currentUser)
                    .get();

                if (!balanceQuery.empty) {
                    const balances = balanceQuery.docs[0].data();
                    let availableBalance = 0;
                    
                    if (leaveType === 'sick') availableBalance = balances.sick;
                    else if (leaveType === 'casual') availableBalance = balances.casual;
                    else if (leaveType === 'earned') availableBalance = balances.earned;
                    else if (leaveType === 'maternity') availableBalance = balances.maternity;
                    else if (leaveType === 'paternity') availableBalance = balances.paternity;
                    
                    document.getElementById('availableBalance').value = availableBalance + ' Days';
                }
            } catch (error) {
                console.error("Error loading balance:", error);
            }
        }

        async function updateEditAvailableBalance() {
            const leaveType = document.getElementById('editLeaveTypeSelect').value;
            if (!leaveType) return;

            try {
                const balanceQuery = await db.collection("leaveBalances")
                    .where("userId", "==", currentUser)
                    .get();

                if (!balanceQuery.empty) {
                    const balances = balanceQuery.docs[0].data();
                    let availableBalance = 0;
                    
                    if (leaveType === 'sick') availableBalance = balances.sick;
                    else if (leaveType === 'casual') availableBalance = balances.casual;
                    else if (leaveType === 'earned') availableBalance = balances.earned;
                    
                    document.getElementById('editAvailableBalance').value = availableBalance + ' Days';
                }
            } catch (error) {
                console.error("Error loading balance:", error);
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
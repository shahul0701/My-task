<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hours Management - Leave Management System</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --info: #4895ef;
            --warning: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary) !important;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .stats-card {
            text-align: center;
            padding: 20px 15px;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .table th {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            font-weight: 600;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .status-present {
            background-color: #d1edff;
            color: #0c5460;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-absent {
            background-color: #f8d7da;
            color: #721c24;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-leave {
            background-color: #fff3cd;
            color: #856404;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-holiday {
            background-color: #d4edda;
            color: #155724;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .attendance-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 10px;
        }
        
        .badge-present {
            background-color: #28a745;
            color: white;
        }
        
        .badge-absent {
            background-color: #dc3545;
            color: white;
        }
        
        .badge-leave {
            background-color: #ffc107;
            color: #212529;
        }
        
        .badge-holiday {
            background-color: #17a2b8;
            color: white;
        }
        
        .working-hours {
            font-weight: 600;
            color: var(--primary);
        }
        
        .overtime {
            color: #28a745;
            font-weight: 600;
        }
        
        .undertime {
            color: #dc3545;
            font-weight: 600;
        }
        
        .admin-actions {
            display: flex;
            gap: 5px;
        }
        
        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        .filter-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .attendance-summary {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .summary-item {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            flex: 1;
            min-width: 120px;
        }
        
        .summary-label {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .summary-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .current-month-display {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-clock me-2"></i>Hours Management
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="attendance.html">
                            <i class="fas fa-user-clock me-1"></i> Attendance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="leave.html">
                            <i class="fas fa-umbrella-beach me-1"></i> Leave
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="holiday.html">
                            <i class="fas fa-calendar-day me-1"></i> Holiday
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="fas fa-clock me-1"></i> Hours
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i> <span id="currentUserName">Loading...</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Toast Notification -->
    <div id="toast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage">Success!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-4">
        <!-- Debug Info Panel -->
        <div class="debug-info" id="debugInfo">
            Debug: Loading...
        </div>

        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="text-white">Hours Management</h2>
                <p class="text-light">Track and manage employee working hours</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#markAttendanceModal" id="markAttendanceBtn">
                    <i class="fas fa-check-circle me-2"></i> Mark Hours
                </button>
                <button class="btn btn-light ms-2" data-bs-toggle="modal" data-bs-target="#bulkAttendanceModal" id="bulkAttendanceBtn" style="display: none;">
                    <i class="fas fa-users me-2"></i> Bulk Update
                </button>
            </div>
        </div>

        <!-- Current Month Display -->
        <div class="current-month-display" id="currentMonthDisplay">
            Loading current month...
        </div>

        <!-- Stats Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <i class="fas fa-user-check fa-2x text-success mb-2"></i>
                        <h5 class="card-title">Present Today</h5>
                        <div class="stats-number text-success" id="presentToday">0</div>
                        <p class="card-text">Employees</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <i class="fas fa-user-times fa-2x text-danger mb-2"></i>
                        <h5 class="card-title">Absent Today</h5>
                        <div class="stats-number text-danger" id="absentToday">0</div>
                        <p class="card-text">Employees</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <i class="fas fa-umbrella-beach fa-2x text-warning mb-2"></i>
                        <h5 class="card-title">On Leave</h5>
                        <div class="stats-number text-warning" id="onLeaveToday">0</div>
                        <p class="card-text">Employees</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <i class="fas fa-calendar-alt fa-2x text-info mb-2"></i>
                        <h5 class="card-title">Attendance Rate</h5>
                        <div class="stats-number text-info" id="attendanceRate">0%</div>
                        <p class="card-text">This Month</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Summary -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="filter-section">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label class="form-label">Select Month</label>
                            <input type="month" class="form-control" id="monthFilter">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Select Employee</label>
                            <select class="form-select" id="employeeFilter">
                                <option value="all">All Employees</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Status Filter</label>
                            <select class="form-select" id="statusFilter">
                                <option value="all">All Status</option>
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                                <option value="leave">On Leave</option>
                                <option value="holiday">Holiday</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadAttendanceData()">
                                <i class="fas fa-filter me-2"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="attendance-summary mt-3" id="attendanceSummary">
                        <!-- Summary will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header p-0">
                        <ul class="nav nav-tabs" id="attendanceTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="my-attendance-tab" data-bs-toggle="tab" data-bs-target="#my-attendance" type="button">
                                    <i class="fas fa-user me-2"></i> My Hours
                                </button>
                            </li>
                            <li class="nav-item" role="presentation" id="teamAttendanceTab" style="display: none;">
                                <button class="nav-link" id="team-attendance-tab" data-bs-toggle="tab" data-bs-target="#team-attendance" type="button">
                                    <i class="fas fa-users me-2"></i> Team Hours
                                </button>
                            </li>
                            <li class="nav-item" role="presentation" id="allAttendanceTab" style="display: none;">
                                <button class="nav-link" id="all-attendance-tab" data-bs-toggle="tab" data-bs-target="#all-attendance" type="button">
                                    <i class="fas fa-tasks me-2"></i> All Hours (Admin)
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="tab-content" id="attendanceTabsContent">
                        <!-- My Hours Tab -->
                        <div class="tab-pane fade show active" id="my-attendance" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Day</th>
                                            <th>Check In</th>
                                            <th>Check Out</th>
                                            <th>Working Hours</th>
                                            <th>Break Time</th>
                                            <th>Net Hours</th>
                                            <th>Status</th>
                                            <th>Remarks</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myAttendanceTableBody">
                                        <tr>
                                            <td colspan="10" class="text-center py-4">Loading hours data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Team Hours Tab -->
                        <div class="tab-pane fade" id="team-attendance" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Date</th>
                                            <th>Check In</th>
                                            <th>Check Out</th>
                                            <th>Working Hours</th>
                                            <th>Break Time</th>
                                            <th>Net Hours</th>
                                            <th>Status</th>
                                            <th>Remarks</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teamAttendanceTableBody">
                                        <tr>
                                            <td colspan="10" class="text-center py-4">No team hours data available</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- All Hours Tab (Admin Only) -->
                        <div class="tab-pane fade" id="all-attendance" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Date</th>
                                            <th>Check In</th>
                                            <th>Check Out</th>
                                            <th>Working Hours</th>
                                            <th>Break Time</th>
                                            <th>Net Hours</th>
                                            <th>Status</th>
                                            <th>Remarks</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allAttendanceTableBody">
                                        <tr>
                                            <td colspan="10" class="text-center py-4">No hours data available</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mark Hours Modal -->
    <div class="modal fade" id="markAttendanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i> Mark Hours</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="markAttendanceForm">
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="attendanceDate" value="" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Check In Time</label>
                                <input type="time" class="form-control" id="checkInTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Check Out Time</label>
                                <input type="time" class="form-control" id="checkOutTime">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Break Start</label>
                                <input type="time" class="form-control" id="breakStartTime">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Break End</label>
                                <input type="time" class="form-control" id="breakEndTime">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="attendanceStatus" required>
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                                <option value="leave">On Leave</option>
                                <option value="holiday">Holiday</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Remarks (Optional)</label>
                            <textarea class="form-control" id="attendanceRemarks" rows="3" placeholder="Any remarks or notes"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitAttendanceBtn">Mark Hours</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Hours Modal -->
    <div class="modal fade" id="bulkAttendanceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-users me-2"></i> Bulk Hours Update</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkAttendanceForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Select Employees</label>
                                <select class="form-select" id="bulkEmployees" multiple required>
                                    <option value="">Loading employees...</option>
                                </select>
                                <small class="form-text text-muted">Hold Ctrl to select multiple employees</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="bulkAttendanceDate" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="bulkAttendanceStatus" required>
                                    <option value="present">Present</option>
                                    <option value="absent">Absent</option>
                                    <option value="leave">On Leave</option>
                                    <option value="holiday">Holiday</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Remarks</label>
                                <input type="text" class="form-control" id="bulkRemarks" placeholder="Remarks for all selected employees">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitBulkAttendanceBtn">Update Bulk Hours</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Hours Modal -->
    <div class="modal fade" id="editAttendanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i> Edit Hours</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAttendanceForm">
                        <input type="hidden" id="editAttendanceId">
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="editAttendanceDate" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Check In Time</label>
                                <input type="time" class="form-control" id="editCheckInTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Check Out Time</label>
                                <input type="time" class="form-control" id="editCheckOutTime">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Break Start</label>
                                <input type="time" class="form-control" id="editBreakStartTime">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Break End</label>
                                <input type="time" class="form-control" id="editBreakEndTime">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editAttendanceStatus" required>
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                                <option value="leave">On Leave</option>
                                <option value="holiday">Holiday</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Remarks</label>
                            <textarea class="form-control" id="editAttendanceRemarks" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateAttendanceBtn">Update Hours</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Leave Management System</h5>
                    <p>Streamlining leave requests and approvals for your organization.</p>
                </div>
                <div class="col-md-6 text-end">
                    <p>&copy; 2025 Your Company. All rights reserved.</p>
                    <div>
                        <a href="#" class="text-decoration-none me-3">Privacy Policy</a>
                        <a href="#" class="text-decoration-none">Terms of Service</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYhLNuJKj2ucwGimfddTfpTb32Y0c-bXg",
            authDomain: "mytask-96a79.firebaseapp.com",
            databaseURL: "https://mytask-96a79-default-rtdb.firebaseio.com",
            projectId: "mytask-96a79",
            storageBucket: "mytask-96a79.firebasestorage.app",
            messagingSenderId: "963509757773",
            appId: "1:963509757773:web:d9c81a108f5873702eb904",
            measurementId: "G-L9C1LTCZRN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let userData = null;
        let userRole = null;
        let allUsers = [];
        let attendanceData = [];

        // Get current month and year
        function getCurrentMonthYear() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        // Format month for display
        function formatMonthDisplay(monthYear) {
            const [year, month] = monthYear.split('-');
            const date = new Date(year, month - 1);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        }

        // Update current month display
        function updateCurrentMonthDisplay() {
            const currentMonth = getCurrentMonthYear();
            const displayText = formatMonthDisplay(currentMonth);
            document.getElementById('currentMonthDisplay').textContent = `Viewing Hours for ${displayText}`;
            
            // Set the month filter to current month
            document.getElementById('monthFilter').value = currentMonth;
        }

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toastMessage.textContent = message;
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Update debug info
        function updateDebugInfo(message) {
            document.getElementById('debugInfo').textContent = 'Debug: ' + message;
            console.log('DEBUG:', message);
        }

        // Initialize the application
        async function initializeApp() {
            updateDebugInfo('Starting initialization...');
            
            // Update current month display
            updateCurrentMonthDisplay();
            
            // Get user from session storage
            const username = sessionStorage.getItem("username");
            if (!username) {
                showToast('Please login first', 'error');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            document.getElementById('currentUserName').textContent = username;

            // Find user in Firestore
            try {
                updateDebugInfo('Searching for user in Firestore...');
                const userQuery = await db.collection("users")
                    .where("username", "==", username)
                    .get();

                if (userQuery.empty) {
                    updateDebugInfo('User not found in Firestore');
                    showToast('User not found in system', 'error');
                    return;
                }

                userData = userQuery.docs[0].data();
                currentUser = userQuery.docs[0].id;
                userRole = userData.role || 'employee';

                updateDebugInfo(`User loaded: ${userData.username}, Role: ${userRole}, ID: ${currentUser}`);

                // Show admin features if admin
                if (userRole === 'Admin' || userRole === 'Sub Admin') {
                    document.getElementById('bulkAttendanceBtn').style.display = 'inline-block';
                    document.getElementById('teamAttendanceTab').style.display = 'block';
                    document.getElementById('allAttendanceTab').style.display = 'block';
                }

                // Set today's date in modal
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('attendanceDate').value = today;
                document.getElementById('bulkAttendanceDate').value = today;

                // Load initial data
                await loadAllUsers();
                await loadAttendanceData();
                
                updateDebugInfo('App initialized successfully');

            } catch (error) {
                updateDebugInfo('Error: ' + error.message);
                console.error("Error initializing app:", error);
                showToast('Error loading application: ' + error.message, 'error');
            }
        }

        // Load all users for filters and bulk operations
        async function loadAllUsers() {
            try {
                const usersQuery = await db.collection("users").get();
                allUsers = [];
                usersQuery.forEach(doc => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });

                // Populate employee filter dropdown
                const employeeFilter = document.getElementById('employeeFilter');
                employeeFilter.innerHTML = '<option value="all">All Employees</option>';
                
                allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.username} (${user.empId || 'N/A'})`;
                    employeeFilter.appendChild(option);
                });

                // Populate bulk employees dropdown
                const bulkEmployees = document.getElementById('bulkEmployees');
                bulkEmployees.innerHTML = '';
                
                allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.username} (${user.empId || 'N/A'})`;
                    bulkEmployees.appendChild(option);
                });

            } catch (error) {
                console.error("Error loading users:", error);
            }
        }

        // Load attendance data based on filters
        async function loadAttendanceData() {
            try {
                updateDebugInfo('Loading hours data...');
                
                const monthFilter = document.getElementById('monthFilter').value || getCurrentMonthYear();
                const employeeFilter = document.getElementById('employeeFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;

                // Calculate date range for the selected month
                const [year, month] = monthFilter.split('-');
                const startDate = `${year}-${month}-01`;
                const endDate = `${year}-${month}-${new Date(year, month, 0).getDate()}`;

                // Update current month display
                document.getElementById('currentMonthDisplay').textContent = `Viewing Hours for ${formatMonthDisplay(monthFilter)}`;

                let attendanceQuery;
                
                if (employeeFilter === 'all' && (userRole === 'Admin' || userRole === 'Sub Admin')) {
                    // Admin viewing all attendance
                    attendanceQuery = await db.collection("attendance")
                        .where("date", ">=", startDate)
                        .where("date", "<=", endDate)
                        .get();
                } else {
                    // User viewing their own attendance or admin viewing specific user
                    const userId = employeeFilter === 'all' ? currentUser : employeeFilter;
                    attendanceQuery = await db.collection("attendance")
                        .where("userId", "==", userId)
                        .where("date", ">=", startDate)
                        .where("date", "<=", endDate)
                        .get();
                }

                attendanceData = [];
                attendanceQuery.forEach(doc => {
                    attendanceData.push({ id: doc.id, ...doc.data() });
                });

                // Filter by status if needed
                if (statusFilter !== 'all') {
                    attendanceData = attendanceData.filter(record => record.status === statusFilter);
                }

                updateDebugInfo(`Loaded ${attendanceData.length} hours records`);

                // Update UI
                updateAttendanceTables();
                updateAttendanceStats();
                updateSummaryCards();

            } catch (error) {
                updateDebugInfo('Error loading hours data: ' + error.message);
                console.error("Error loading hours data:", error);
                showToast('Error loading hours data', 'error');
            }
        }

        // Update attendance tables
        function updateAttendanceTables() {
            updateMyAttendanceTable();
            updateTeamAttendanceTable();
            updateAllAttendanceTable();
        }

        // Update my attendance table
        function updateMyAttendanceTable() {
            const tbody = document.getElementById('myAttendanceTableBody');
            tbody.innerHTML = '';

            const myAttendance = attendanceData.filter(record => record.userId === currentUser);

            if (myAttendance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4">No hours records found for the selected period</td></tr>';
                return;
            }

            // Sort by date descending
            myAttendance.sort((a, b) => new Date(b.date) - new Date(a.date));

            myAttendance.forEach(record => {
                const row = createAttendanceRow(record, 'my');                tbody.appendChild(row);
            });
        }

        // Update team attendance table
        function updateTeamAttendanceTable() {
            const tbody = document.getElementById('teamAttendanceTableBody');
            tbody.innerHTML = '';

            if (userRole !== 'Admin' && userRole !== 'Sub Admin') {
                return;
            }

            // Get team members (for now, show all users except current user)
            const teamAttendance = attendanceData.filter(record => record.userId !== currentUser);

            if (teamAttendance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4">No team hours records found for the selected period</td></tr>';
                return;
            }

            // Sort by date descending
            teamAttendance.sort((a, b) => new Date(b.date) - new Date(a.date));

            teamAttendance.forEach(record => {
                const row = createAttendanceRow(record, 'team');
                tbody.appendChild(row);
            });
        }

        // Update all attendance table (admin only)
        function updateAllAttendanceTable() {
            const tbody = document.getElementById('allAttendanceTableBody');
            tbody.innerHTML = '';

            if (userRole !== 'Admin' && userRole !== 'Sub Admin') {
                return;
            }

            if (attendanceData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4">No hours records found for the selected period</td></tr>';
                return;
            }

            // Sort by date descending
            attendanceData.sort((a, b) => new Date(b.date) - new Date(a.date));

            attendanceData.forEach(record => {
                const row = createAttendanceRow(record, 'all');
                tbody.appendChild(row);
            });
        }

        // Create attendance table row
        function createAttendanceRow(record, tableType) {
            const row = document.createElement('tr');
            
            // Format date and day
            const dateObj = new Date(record.date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
            
            // Calculate working hours
            let workingHours = 'N/A';
            let netHours = 'N/A';
            let breakTime = 'N/A';
            
            if (record.checkIn && record.checkOut) {
                const checkInTime = new Date(`${record.date}T${record.checkIn}`);
                const checkOutTime = new Date(`${record.date}T${record.checkOut}`);
                
                // Calculate total working hours in hours
                const totalMs = checkOutTime - checkInTime;
                const totalHours = totalMs / (1000 * 60 * 60);
                
                // Calculate break time if available
                let breakMs = 0;
                if (record.breakStart && record.breakEnd) {
                    const breakStartTime = new Date(`${record.date}T${record.breakStart}`);
                    const breakEndTime = new Date(`${record.date}T${record.breakEnd}`);
                    breakMs = breakEndTime - breakStartTime;
                }
                
                const breakHours = breakMs / (1000 * 60 * 60);
                const netHoursValue = totalHours - breakHours;
                
                // Format times
                workingHours = totalHours.toFixed(2) + 'h';
                breakTime = breakHours.toFixed(2) + 'h';
                netHours = netHoursValue.toFixed(2) + 'h';
                
                // Add overtime/undertime indicators
                if (netHoursValue > 8) {
                    netHours = `<span class="overtime">${netHours} (+${(netHoursValue - 8).toFixed(2)}h)</span>`;
                } else if (netHoursValue < 8 && record.status === 'present') {
                    netHours = `<span class="undertime">${netHours} (-${(8 - netHoursValue).toFixed(2)}h)</span>`;
                } else {
                    netHours = `<span class="working-hours">${netHours}</span>`;
                }
            }

            // Get employee name
            let employeeName = record.username || 'Unknown';
            if (tableType !== 'my') {
                const user = allUsers.find(u => u.id === record.userId);
                employeeName = user ? `${user.username} (${user.empId || 'N/A'})` : 'Unknown';
            }

            // Create status badge
            let statusBadge = '';
            switch (record.status) {
                case 'present':
                    statusBadge = `<span class="status-present">Present</span>`;
                    break;
                case 'absent':
                    statusBadge = `<span class="status-absent">Absent</span>`;
                    break;
                case 'leave':
                    statusBadge = `<span class="status-leave">On Leave</span>`;
                    break;
                case 'holiday':
                    statusBadge = `<span class="status-holiday">Holiday</span>`;
                    break;
                default:
                    statusBadge = `<span class="badge bg-secondary">${record.status}</span>`;
            }

            // Create row HTML based on table type
            if (tableType === 'my') {
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${dayName}</td>
                    <td>${record.checkIn || '-'}</td>
                    <td>${record.checkOut || '-'}</td>
                    <td>${workingHours}</td>
                    <td>${breakTime}</td>
                    <td>${netHours}</td>
                    <td>${statusBadge}</td>
                    <td>${record.remarks || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editAttendance('${record.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAttendance('${record.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            } else {
                row.innerHTML = `
                    <td>${employeeName}</td>
                    <td>${formattedDate}</td>
                    <td>${record.checkIn || '-'}</td>
                    <td>${record.checkOut || '-'}</td>
                    <td>${workingHours}</td>
                    <td>${breakTime}</td>
                    <td>${netHours}</td>
                    <td>${statusBadge}</td>
                    <td>${record.remarks || '-'}</td>
                    <td>
                        <div class="admin-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="editAttendance('${record.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAttendance('${record.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
            }

            return row;
        }

        // Update attendance statistics
        function updateAttendanceStats() {
            const today = new Date().toISOString().split('T')[0];
            
            // Get today's attendance
            const todayAttendance = attendanceData.filter(record => record.date === today);
            
            // Count by status
            const presentToday = todayAttendance.filter(record => record.status === 'present').length;
            const absentToday = todayAttendance.filter(record => record.status === 'absent').length;
            const onLeaveToday = todayAttendance.filter(record => record.status === 'leave').length;
            
            // Calculate attendance rate for the month
            const totalWorkDays = calculateTotalWorkDays();
            const presentCount = attendanceData.filter(record => 
                record.userId === currentUser && record.status === 'present'
            ).length;
            
            const attendanceRate = totalWorkDays > 0 ? 
                Math.round((presentCount / totalWorkDays) * 100) : 0;
            
            // Update DOM
            document.getElementById('presentToday').textContent = presentToday;
            document.getElementById('absentToday').textContent = absentToday;
            document.getElementById('onLeaveToday').textContent = onLeaveToday;
            document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
        }

        // Calculate total work days in the current month
        function calculateTotalWorkDays() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let workDays = 0;
            for (let day = firstDay; day <= lastDay; day.setDate(day.getDate() + 1)) {
                // Count only weekdays (Monday to Friday)
                if (day.getDay() !== 0 && day.getDay() !== 6) {
                    workDays++;
                }
            }
            
            return workDays;
        }

        // Update summary cards
        function updateSummaryCards() {
            const summaryContainer = document.getElementById('attendanceSummary');
            
            // Calculate summary data
            const totalRecords = attendanceData.length;
            const presentCount = attendanceData.filter(record => record.status === 'present').length;
            const absentCount = attendanceData.filter(record => record.status === 'absent').length;
            const leaveCount = attendanceData.filter(record => record.status === 'leave').length;
            const holidayCount = attendanceData.filter(record => record.status === 'holiday').length;
            
            // Calculate average working hours for present days
            const presentRecords = attendanceData.filter(record => 
                record.status === 'present' && record.checkIn && record.checkOut
            );
            
            let totalNetHours = 0;
            presentRecords.forEach(record => {
                if (record.checkIn && record.checkOut) {
                    const checkInTime = new Date(`${record.date}T${record.checkIn}`);
                    const checkOutTime = new Date(`${record.date}T${record.checkOut}`);
                    const totalMs = checkOutTime - checkInTime;
                    
                    let breakMs = 0;
                    if (record.breakStart && record.breakEnd) {
                        const breakStartTime = new Date(`${record.date}T${record.breakStart}`);
                        const breakEndTime = new Date(`${record.date}T${record.breakEnd}`);
                        breakMs = breakEndTime - breakStartTime;
                    }
                    
                    const netHours = (totalMs - breakMs) / (1000 * 60 * 60);
                    totalNetHours += netHours;
                }
            });
            
            const avgWorkingHours = presentRecords.length > 0 ? 
                (totalNetHours / presentRecords.length).toFixed(2) + 'h' : '0h';
            
            summaryContainer.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">Total Records</div>
                    <div class="summary-value">${totalRecords}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Present Days</div>
                    <div class="summary-value">${presentCount}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Absent Days</div>
                    <div class="summary-value">${absentCount}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Leave Days</div>
                    <div class="summary-value">${leaveCount}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Holidays</div>
                    <div class="summary-value">${holidayCount}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Avg Hours</div>
                    <div class="summary-value">${avgWorkingHours}</div>
                </div>
            `;
        }

        // Mark attendance function
        document.getElementById('submitAttendanceBtn').addEventListener('click', async function() {
            try {
                const form = document.getElementById('markAttendanceForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const attendanceData = {
                    userId: currentUser,
                    username: userData.username,
                    date: document.getElementById('attendanceDate').value,
                    checkIn: document.getElementById('checkInTime').value,
                    checkOut: document.getElementById('checkOutTime').value || null,
                    breakStart: document.getElementById('breakStartTime').value || null,
                    breakEnd: document.getElementById('breakEndTime').value || null,
                    status: document.getElementById('attendanceStatus').value,
                    remarks: document.getElementById('attendanceRemarks').value || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Check if attendance already exists for this date and user
                const existingQuery = await db.collection("attendance")
                    .where("userId", "==", currentUser)
                    .where("date", "==", attendanceData.date)
                    .get();

                if (!existingQuery.empty) {
                    showToast('Hours already marked for this date', 'warning');
                    return;
                }

                await db.collection("attendance").add(attendanceData);
                
                showToast('Hours marked successfully!');
                $('#markAttendanceModal').modal('hide');
                form.reset();
                
                // Reload data
                await loadAttendanceData();

            } catch (error) {
                console.error("Error marking hours:", error);
                showToast('Error marking hours: ' + error.message, 'error');
            }
        });

        // Bulk attendance function
        document.getElementById('submitBulkAttendanceBtn').addEventListener('click', async function() {
            try {
                const form = document.getElementById('bulkAttendanceForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const selectedEmployees = Array.from(document.getElementById('bulkEmployees').selectedOptions)
                    .map(option => option.value);

                if (selectedEmployees.length === 0) {
                    showToast('Please select at least one employee', 'warning');
                    return;
                }

                const bulkData = {
                    date: document.getElementById('bulkAttendanceDate').value,
                    status: document.getElementById('bulkAttendanceStatus').value,
                    remarks: document.getElementById('bulkRemarks').value || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                let successCount = 0;
                let errorCount = 0;

                // Process each selected employee
                for (const employeeId of selectedEmployees) {
                    try {
                        const user = allUsers.find(u => u.id === employeeId);
                        if (!user) continue;

                        // Check if attendance already exists
                        const existingQuery = await db.collection("attendance")
                            .where("userId", "==", employeeId)
                            .where("date", "==", bulkData.date)
                            .get();

                        if (!existingQuery.empty) {
                            errorCount++;
                            continue;
                        }

                        // Add attendance record
                        await db.collection("attendance").add({
                            ...bulkData,
                            userId: employeeId,
                            username: user.username
                        });

                        successCount++;

                    } catch (error) {
                        console.error(`Error processing employee ${employeeId}:`, error);
                        errorCount++;
                    }
                }

                showToast(`Bulk update completed: ${successCount} successful, ${errorCount} failed`);
                $('#bulkAttendanceModal').modal('hide');
                form.reset();
                
                // Reload data
                await loadAttendanceData();

            } catch (error) {
                console.error("Error in bulk hours update:", error);
                showToast('Error in bulk hours update: ' + error.message, 'error');
            }
        });

        // Edit attendance function
        async function editAttendance(attendanceId) {
            try {
                const attendanceDoc = await db.collection("attendance").doc(attendanceId).get();
                if (!attendanceDoc.exists) {
                    showToast('Hours record not found', 'error');
                    return;
                }

                const record = attendanceDoc.data();

                // Populate edit form
                document.getElementById('editAttendanceId').value = attendanceId;
                document.getElementById('editAttendanceDate').value = record.date;
                document.getElementById('editCheckInTime').value = record.checkIn || '';
                document.getElementById('editCheckOutTime').value = record.checkOut || '';
                document.getElementById('editBreakStartTime').value = record.breakStart || '';
                document.getElementById('editBreakEndTime').value = record.breakEnd || '';
                document.getElementById('editAttendanceStatus').value = record.status;
                document.getElementById('editAttendanceRemarks').value = record.remarks || '';

                // Show edit modal
                $('#editAttendanceModal').modal('show');

            } catch (error) {
                console.error("Error loading hours for edit:", error);
                showToast('Error loading hours record', 'error');
            }
        }

        // Update attendance function
        document.getElementById('updateAttendanceBtn').addEventListener('click', async function() {
            try {
                const form = document.getElementById('editAttendanceForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const attendanceId = document.getElementById('editAttendanceId').value;
                const updateData = {
                    date: document.getElementById('editAttendanceDate').value,
                    checkIn: document.getElementById('editCheckInTime').value,
                    checkOut: document.getElementById('editCheckOutTime').value || null,
                    breakStart: document.getElementById('editBreakStartTime').value || null,
                    breakEnd: document.getElementById('editBreakEndTime').value || null,
                    status: document.getElementById('editAttendanceStatus').value,
                    remarks: document.getElementById('editAttendanceRemarks').value || '',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection("attendance").doc(attendanceId).update(updateData);
                
                showToast('Hours updated successfully!');
                $('#editAttendanceModal').modal('hide');
                
                // Reload data
                await loadAttendanceData();

            } catch (error) {
                console.error("Error updating hours:", error);
                showToast('Error updating hours: ' + error.message, 'error');
            }
        });

        // Delete attendance function
        async function deleteAttendance(attendanceId) {
            if (!confirm('Are you sure you want to delete this hours record?')) {
                return;
            }

            try {
                await db.collection("attendance").doc(attendanceId).delete();
                showToast('Hours record deleted successfully!');
                
                // Reload data
                await loadAttendanceData();

            } catch (error) {
                console.error("Error deleting hours:", error);
                showToast('Error deleting hours record', 'error');
            }
        }

        // Logout function
        function logout() {
            sessionStorage.removeItem("username");
            showToast('Logged out successfully');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }

        // Auto-fill current time for check-in
        document.getElementById('markAttendanceBtn').addEventListener('click', function() {
            const now = new Date();
            const currentTime = now.toTimeString().split(' ')[0].substring(0, 5);
            
            // Set current time for check-in
            document.getElementById('checkInTime').value = currentTime;
            
            // Set check-out time to 9 hours later (standard work day)
            const checkOutTime = new Date(now.getTime() + 9 * 60 * 60 * 1000);
            const checkOutTimeStr = checkOutTime.toTimeString().split(' ')[0].substring(0, 5);
            document.getElementById('checkOutTime').value = checkOutTimeStr;
            
            // Set break time (1 hour lunch break)
            const breakStartTime = new Date(now.getTime() + 4 * 60 * 60 * 1000);
            const breakStartStr = breakStartTime.toTimeString().split(' ')[0].substring(0, 5);
            document.getElementById('breakStartTime').value = breakStartStr;
            
            const breakEndTime = new Date(now.getTime() + 5 * 60 * 60 * 1000);
            const breakEndStr = breakEndTime.toTimeString().split(' ')[0].substring(0, 5);
            document.getElementById('breakEndTime').value = breakEndStr;
        });

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
    </script>
</body>
</html>
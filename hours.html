<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hours Management - Attendance System</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #2c3e50;
    }

    /* Topbar */
    .topbar {
      height: 70px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 100;
    }

    .topbar .left {
      display: flex;
      align-items: center;
      gap: 25px;
    }

    .topbar .left a {
      color: #2c3e50;
      font-weight: 600;
      text-decoration: none;
      font-size: 16px;
      padding: 10px 20px;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      transition: all 0.3s ease;
    }

    .topbar .left a:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    #dateTime {
      font-weight: 600;
      font-size: 16px;
      color: #2c3e50;
    }

    .profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .profile img {
      border-radius: 50%;
      width: 45px;
      height: 45px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .profile-name {
      font-weight: 600;
      color: #2c3e50;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      width: 250px;
      height: calc(100vh - 70px);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      padding: 20px 0;
      z-index: 99;
      overflow-y: auto;
    }

    .sidebar-toggle {
      position: fixed;
      top: 80px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 101;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      margin-bottom: 5px;
    }

    .sidebar a {
      display: block;
      padding: 15px 25px;
      color: #2c3e50;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: rgba(102, 126, 234, 0.1);
      border-left-color: #667eea;
      color: #667eea;
    }

    .admin-only {
      display: none;
      background: rgba(255, 193, 7, 0.1);
      border-left: 4px solid #ffc107;
    }

    .admin-only.visible {
      display: block;
    }

    /* Main Content */
    .main-content {
      margin: 90px 30px 30px 280px;
      padding: 30px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      min-height: calc(100vh - 120px);
      transition: margin-left 0.3s ease;
    }

    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: #2c3e50;
    }

    .page-subtitle {
      color: #7f8c8d;
      margin-top: 5px;
    }

    .current-month-display {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      min-width: 250px;
      text-align: center;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      border-left: 5px solid #667eea;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #7f8c8d;
      font-weight: 600;
    }

    /* Filter Section */
    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #2c3e50;
    }

    .filter-select, .filter-input {
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .filter-select:focus, .filter-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .filter-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: white;
      border-radius: 15px 15px 0 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      margin-bottom: 0;
      overflow-x: auto;
    }

    .tab {
      padding: 15px 25px;
      background: none;
      border: none;
      font-weight: 600;
      color: #7f8c8d;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      white-space: nowrap;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
      background: white;
      padding: 0;
      border-radius: 0 0 15px 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .tab-content.active {
      display: block;
    }

    /* Table Styles */
    .table-container {
      overflow-x: auto;
      border-radius: 0 0 15px 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      min-width: 800px;
    }

    table th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-weight: 600;
      padding: 15px 12px;
      text-align: left;
      position: sticky;
      top: 0;
    }

    table td {
      padding: 12px;
      border-bottom: 1px solid #f1f3f4;
    }

    table tbody tr:hover {
      background: #f8f9ff;
    }

    .status-present {
      background: #d4edda;
      color: #155724;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-absent {
      background: #f8d7da;
      color: #721c24;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-leave {
      background: #fff3cd;
      color: #856404;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-holiday {
      background: #cce7ff;
      color: #004085;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .overtime {
      color: #28a745;
      font-weight: 600;
    }

    .undertime {
      color: #dc3545;
      font-weight: 600;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .btn-edit, .btn-delete {
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .btn-edit {
      background: #17a2b8;
      color: white;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
    }

    .btn-edit:hover, .btn-delete:hover {
      transform: translateY(-1px);
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 90px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      max-width: 300px;
      transform: translateX(150%);
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success { background: #27ae60; }
    .toast.error { background: #e74c3c; }
    .toast.warning { background: #f39c12; }
    .toast.info { background: #3498db; }

    /* Loading States */
    .loading {
      color: #6c757d;
      font-style: italic;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    /* Debug Info */
    .debug-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-family: monospace;
      font-size: 12px;
      border-left: 4px solid #dc3545;
    }

    /* User-specific styles */
    .user-view .admin-only-element {
      display: none !important;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 768px) {
      .sidebar-toggle {
        display: block;
      }

      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.visible {
        transform: translateX(0);
      }

      .main-content {
        margin: 90px 15px 15px 15px;
        padding: 20px;
      }

      .filter-grid {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: column;
      }

      .tab {
        border-bottom: none;
        border-left: 3px solid transparent;
        text-align: left;
      }

      .tab.active {
        border-left-color: #667eea;
        border-bottom: none;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .topbar {
        padding: 0 15px;
      }

      .topbar .left {
        gap: 10px;
      }

      .topbar .left a {
        font-size: 14px;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="left">
      <a href="#" id="homeButton">🏠 Home</a>
    </div>
    <div id="dateTime">Loading...</div>
    <div class="profile">
      <img src="https://i.pravatar.cc/45" alt="User" />
      <span class="profile-name" id="profileName">User</span>
    </div>
  </div>

  <!-- Sidebar Toggle -->
  <button class="sidebar-toggle" id="sidebarToggle">☰</button>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <ul>
      <li><a href="Leave.html">📋 Leave</a></li>
      <li><a href="Holiday.html">🎄 Holiday</a></li>
      <li><a href="Attendance.html">⏱️ Attendance Tracker</a></li>
      <li><a href="Hours.html" class="active">🕒 Hours</a></li>
      <li><a href="Reports.html">📊 Reports</a></li>
      <!-- Admin Only Menu -->
      <li class="admin-only" id="adminMenu">
        <a href="AllData.html">🔍 Detailed View</a>
      </li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="main-content" id="mainContent">
    <!-- Debug Info -->
    <div class="debug-info" id="debugInfo">
      Initializing application...
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title" id="pageTitle">Hours Management</h1>
        <p class="page-subtitle" id="pageSubtitle">Track and manage employee working hours</p>
      </div>
      <div class="current-month-display" id="currentMonthDisplay">
        Loading current month...
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card admin-only-element">
        <div class="stat-icon">👥</div>
        <div class="stat-number" id="totalEmployees">0</div>
        <div class="stat-label">Total Employees</div>
      </div>
      <div class="stat-card admin-only-element">
        <div class="stat-icon">✅</div>
        <div class="stat-number" id="presentToday">0</div>
        <div class="stat-label">Present Today</div>
      </div>
      <div class="stat-card admin-only-element">
        <div class="stat-icon">❌</div>
        <div class="stat-number" id="absentToday">0</div>
        <div class="stat-label">Absent Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">📊</div>
        <div class="stat-number" id="attendanceRate">0%</div>
        <div class="stat-label" id="attendanceLabel">Attendance Rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">⏱️</div>
        <div class="stat-number" id="totalHours">0h</div>
        <div class="stat-label" id="hoursLabel">Total Hours</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">📅</div>
        <div class="stat-number" id="workDays">0</div>
        <div class="stat-label" id="daysLabel">Work Days</div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-grid">
        <div class="filter-group">
          <label class="filter-label">Select Month</label>
          <input type="month" class="filter-input" id="monthFilter">
        </div>
        <div class="filter-group admin-only-element">
          <label class="filter-label">Select Employee</label>
          <select class="filter-select" id="employeeFilter">
            <option value="all">All Employees</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Status Filter</label>
          <select class="filter-select" id="statusFilter">
            <option value="all">All Status</option>
            <option value="present">Present</option>
            <option value="absent">Absent</option>
            <option value="leave">On Leave</option>
            <option value="holiday">Holiday</option>
          </select>
        </div>
        <div class="filter-group">
          <button class="filter-btn" onclick="loadHoursData()">
            <span>🔍 Apply Filters</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('myHours')">
          <span id="myHoursTabText">My Hours</span>
        </button>
        <button class="tab admin-only-element" onclick="switchTab('teamHours')" id="teamTab">
          <span>Team Hours</span>
        </button>
        <button class="tab admin-only-element" onclick="switchTab('allHours')" id="allTab">
          <span>All Hours (Admin)</span>
        </button>
      </div>

      <!-- My Hours Tab -->
      <div class="tab-content active" id="myHours">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Day</th>
                <th>Check In</th>
                <th>Check Out</th>
                <th>Working Hours</th>
                <th>Break Time</th>
                <th>Net Hours</th>
                <th>Status</th>
                <th>Remarks</th>
              </tr>
            </thead>
            <tbody id="myHoursTableBody">
              <tr>
                <td colspan="9" class="no-data">
                  <div>Loading your hours data...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Team Hours Tab -->
      <div class="tab-content admin-only-element" id="teamHours">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Employee</th>
                <th>Date</th>
                <th>Check In</th>
                <th>Check Out</th>
                <th>Working Hours</th>
                <th>Break Time</th>
                <th>Net Hours</th>
                <th>Status</th>
                <th>Remarks</th>
              </tr>
            </thead>
            <tbody id="teamHoursTableBody">
              <tr>
                <td colspan="9" class="no-data">
                  <div>No team hours data available</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- All Hours Tab -->
      <div class="tab-content admin-only-element" id="allHours">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Employee</th>
                <th>Date</th>
                <th>Check In</th>
                <th>Check Out</th>
                <th>Working Hours</th>
                <th>Break Time</th>
                <th>Net Hours</th>
                <th>Status</th>
                <th>Remarks</th>
              </tr>
            </thead>
            <tbody id="allHoursTableBody">
              <tr>
                <td colspan="9" class="no-data">
                  <div>No hours data available</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDYhLNuJKj2ucwGimfddTfpTb32Y0c-bXg",
      authDomain: "mytask-96a79.firebaseapp.com",
      databaseURL: "https://mytask-96a79-default-rtdb.firebaseio.com",
      projectId: "mytask-96a79",
      storageBucket: "mytask-96a79.firebasestorage.app",
      messagingSenderId: "963509757773",
      appId: "1:963509757773:web:d9c81a108f5873702eb904",
      measurementId: "G-L9C1LTCZRN"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let currentUser = null;
    let userData = null;
    let userRole = null;
    let allUsers = [];
    let hoursData = [];
    let isAdmin = false;

    // Update debug info
    function updateDebugInfo(message) {
      const debugInfo = document.getElementById('debugInfo');
      const timestamp = new Date().toLocaleTimeString();
      debugInfo.innerHTML = `<strong>Debug (${timestamp}):</strong> ${message}`;
      console.log('DEBUG:', message);
    }

    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast';
      toast.classList.add(type, 'show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Update date time
    function updateDateTime() {
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };
      document.getElementById('dateTime').textContent = now.toLocaleDateString('en-US', options);
    }

    // Get current month and year
    function getCurrentMonthYear() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      return `${year}-${month}`;
    }

    // Format month for display
    function formatMonthDisplay(monthYear) {
      const [year, month] = monthYear.split('-');
      const date = new Date(year, month - 1);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
    }

    // Update current month display
    function updateCurrentMonthDisplay() {
      const currentMonth = getCurrentMonthYear();
      const displayText = formatMonthDisplay(currentMonth);
      document.getElementById('currentMonthDisplay').textContent = `Viewing: ${displayText}`;
      
      // Set the month filter to current month
      document.getElementById('monthFilter').value = currentMonth;
    }

    // Home button click handler
    function handleHomeClick() {
      if (isAdmin) {
        window.location.href = 'Home.html';
      } else {
        window.location.href = 'UserDashboard.html';
      }
    }

    // Switch tabs
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName).classList.add('active');
      
      // Add active class to clicked tab
      event.target.classList.add('active');
    }

    // Initialize the application
    async function initializeApp() {
      updateDebugInfo('Starting application initialization...');
      updateDateTime();
      setInterval(updateDateTime, 1000);
      updateCurrentMonthDisplay();

      // Get user from session storage
      const username = sessionStorage.getItem("username");
      if (!username) {
        updateDebugInfo('No user found in session storage');
        showToast('Please login first', 'error');
        setTimeout(() => window.location.href = 'index.html', 2000);
        return;
      }

      document.getElementById('profileName').textContent = username;

      // Set up home button click handler
      document.getElementById('homeButton').addEventListener('click', handleHomeClick);

      // Find user in Firestore
      try {
        updateDebugInfo('Searching for user in Firestore...');
        const userQuery = await db.collection("users")
          .where("username", "==", username)
          .get();

        if (userQuery.empty) {
          updateDebugInfo('User not found in Firestore');
          showToast('User not found in system', 'error');
          return;
        }

        userData = userQuery.docs[0].data();
        currentUser = userQuery.docs[0].id;
        userRole = userData.role || 'employee';
        isAdmin = (userRole === 'Admin' || userRole === 'admin');

        updateDebugInfo(`User loaded: ${userData.username}, Role: ${userRole}, isAdmin: ${isAdmin}`);

        // Update UI based on user role
        updateUIForUserRole();

        // Load all users
        await loadAllUsers();
        
        // Load initial hours data
        await loadHoursData();

        updateDebugInfo('Application initialized successfully');

      } catch (error) {
        updateDebugInfo('Error: ' + error.message);
        console.error("Error initializing app:", error);
        showToast('Error loading application: ' + error.message, 'error');
      }
    }

    // Update UI based on user role
    function updateUIForUserRole() {
      if (isAdmin) {
        // Admin view
        document.getElementById('adminMenu').classList.add('visible');
        document.getElementById('pageTitle').textContent = 'Hours Management';
        document.getElementById('pageSubtitle').textContent = 'Track and manage employee working hours';
        document.getElementById('myHoursTabText').textContent = 'My Hours';
        document.getElementById('attendanceLabel').textContent = 'Team Attendance';
        document.getElementById('hoursLabel').textContent = 'Team Hours';
        document.getElementById('daysLabel').textContent = 'Work Days';
        
        // Show admin elements
        document.querySelectorAll('.admin-only-element').forEach(el => {
          el.style.display = 'block';
        });
      } else {
        // Regular user view
        document.getElementById('pageTitle').textContent = 'My Hours';
        document.getElementById('pageSubtitle').textContent = 'Track your working hours and attendance';
        document.getElementById('myHoursTabText').textContent = 'My Attendance';
        document.getElementById('attendanceLabel').textContent = 'My Attendance';
        document.getElementById('hoursLabel').textContent = 'My Total Hours';
        document.getElementById('daysLabel').textContent = 'Days Worked';
        
        // Hide admin elements
        document.querySelectorAll('.admin-only-element').forEach(el => {
          el.style.display = 'none';
        });
        
        // Add user-view class to main content for CSS targeting
        document.getElementById('mainContent').classList.add('user-view');
      }
    }

    // Load all users for filters
    async function loadAllUsers() {
      try {
        updateDebugInfo('Loading users from Firestore...');
        
        if (isAdmin) {
          const usersQuery = await db.collection("users").get();
          allUsers = [];
          usersQuery.forEach(doc => {
            allUsers.push({ id: doc.id, ...doc.data() });
          });

          // Update total employees count
          document.getElementById('totalEmployees').textContent = allUsers.length;

          // Populate employee filter dropdown
          const employeeFilter = document.getElementById('employeeFilter');
          employeeFilter.innerHTML = '<option value="all">All Employees</option>';
          
          allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.username} (${user.empId || 'N/A'})`;
            employeeFilter.appendChild(option);
          });
        } else {
          // For regular users, only load their own data
          allUsers = [{
            id: currentUser,
            username: userData.username,
            empId: userData.empId,
            role: userData.role
          }];
        }

        updateDebugInfo(`Loaded ${allUsers.length} users`);

      } catch (error) {
        updateDebugInfo('Error loading users: ' + error.message);
        console.error("Error loading users:", error);
      }
    }

    // Load hours data based on filters - UPDATED TO AVOID COMPOSITE INDEX ISSUES
    async function loadHoursData() {
      try {
        updateDebugInfo('Loading hours data...');
        
        const monthFilter = document.getElementById('monthFilter').value || getCurrentMonthYear();
        const employeeFilter = isAdmin ? document.getElementById('employeeFilter').value : currentUser;
        const statusFilter = document.getElementById('statusFilter').value;

        // Calculate date range for the selected month
        const [year, month] = monthFilter.split('-');
        const startDate = `${year}-${month}-01`;
        const endDate = `${year}-${month}-${new Date(year, month, 0).getDate()}`;

        // Update current month display
        document.getElementById('currentMonthDisplay').textContent = `Viewing: ${formatMonthDisplay(monthFilter)}`;

        let hoursQuery;
        
        if (isAdmin && employeeFilter === 'all') {
          // Admin viewing all hours - load all records and filter by date client-side
          updateDebugInfo('Loading all hours data (admin view)');
          hoursQuery = await db.collection("attendance").get();
          hoursData = [];
          hoursQuery.forEach(doc => {
            const record = { id: doc.id, ...doc.data() };
            if (record.date >= startDate && record.date <= endDate) {
              hoursData.push(record);
            }
          });
        } else {
          // User viewing their own hours or admin viewing specific user
          const userId = isAdmin ? employeeFilter : currentUser;
          updateDebugInfo(`Loading hours for user: ${userId}`);
          hoursQuery = await db.collection("attendance")
            .where("userId", "==", userId)
            .get();
          hoursData = [];
          hoursQuery.forEach(doc => {
            const record = { id: doc.id, ...doc.data() };
            if (record.date >= startDate && record.date <= endDate) {
              hoursData.push(record);
            }
          });
        }

        // Filter by status if needed
        if (statusFilter !== 'all') {
          hoursData = hoursData.filter(record => record.status === statusFilter);
        }

        updateDebugInfo(`Loaded ${hoursData.length} hours records after filtering`);

        // Update statistics
        updateStatistics();
        
        // Update tables
        updateHoursTables();

        showToast(`Loaded ${hoursData.length} hours records`, 'success');

      } catch (error) {
        updateDebugInfo('Error loading hours data: ' + error.message);
        console.error("Error loading hours data:", error);
        showToast('Error loading hours data: ' + error.message, 'error');
      }
    }

    // Update statistics
    function updateStatistics() {
      const today = new Date().toISOString().split('T')[0];
      
      if (isAdmin) {
        // Admin statistics
        // Get today's attendance
        const todayAttendance = hoursData.filter(record => record.date === today);
        
        // Count present today (has login time)
        const presentToday = todayAttendance.filter(record => record.loginTime).length;
        
        // Count absent today (no attendance record or no login time)
        const totalEmployees = allUsers.length;
        const absentToday = totalEmployees - presentToday;
        
        // Calculate total hours for all employees
        let totalHours = 0;
        hoursData.forEach(record => {
          if (record.loginTime && record.logoutTime) {
            const loginTime = parseTimeString(record.loginTime, record.date);
            const logoutTime = parseTimeString(record.logoutTime, record.date);
            if (loginTime && logoutTime) {
              const totalMs = logoutTime - loginTime;
              totalHours += totalMs / (1000 * 60 * 60);
            }
          }
        });

        // Calculate work days in month
        const workDays = calculateWorkDaysInMonth();

        // Update DOM
        document.getElementById('presentToday').textContent = presentToday;
        document.getElementById('absentToday').textContent = absentToday;
        document.getElementById('totalHours').textContent = totalHours.toFixed(1) + 'h';
        document.getElementById('workDays').textContent = workDays;
        document.getElementById('attendanceRate').textContent = totalEmployees > 0 ? 
          Math.round((presentToday / totalEmployees) * 100) + '%' : '0%';
      } else {
        // User statistics
        const userRecords = hoursData.filter(record => record.userId === currentUser);
        const presentDays = userRecords.filter(record => record.loginTime).length;
        const workDays = calculateWorkDaysInMonth();
        const attendanceRate = workDays > 0 ? Math.round((presentDays / workDays) * 100) : 0;

        // Calculate total hours
        let totalHours = 0;
        userRecords.forEach(record => {
          if (record.loginTime && record.logoutTime) {
            const loginTime = parseTimeString(record.loginTime, record.date);
            const logoutTime = parseTimeString(record.logoutTime, record.date);
            if (loginTime && logoutTime) {
              const totalMs = logoutTime - loginTime;
              totalHours += totalMs / (1000 * 60 * 60);
            }
          }
        });

        // Update DOM
        document.getElementById('attendanceRate').textContent = attendanceRate + '%';
        document.getElementById('totalHours').textContent = totalHours.toFixed(1) + 'h';
        document.getElementById('workDays').textContent = presentDays;
      }
    }

    // Calculate work days in current month
    function calculateWorkDaysInMonth() {
      const monthFilter = document.getElementById('monthFilter').value || getCurrentMonthYear();
      const [year, month] = monthFilter.split('-');
      const firstDay = new Date(year, month - 1, 1);
      const lastDay = new Date(year, month, 0);
      
      let workDays = 0;
      for (let day = new Date(firstDay); day <= lastDay; day.setDate(day.getDate() + 1)) {
        // Count only weekdays (Monday to Friday)
        if (day.getDay() !== 0 && day.getDay() !== 6) {
          workDays++;
        }
      }
      
      return workDays;
    }

    // Update hours tables
    function updateHoursTables() {
      updateMyHoursTable();
      if (isAdmin) {
        updateTeamHoursTable();
        updateAllHoursTable();
      }
    }

    // Update my hours table
    function updateMyHoursTable() {
      const tbody = document.getElementById('myHoursTableBody');
      tbody.innerHTML = '';

      const myHours = hoursData.filter(record => record.userId === currentUser);

      if (myHours.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="no-data">
              <div>No hours records found for the selected period</div>
            </td>
          </tr>
        `;
        return;
      }

      // Sort by date descending
      myHours.sort((a, b) => new Date(b.date) - new Date(a.date));

      myHours.forEach(record => {
        const row = createHoursRow(record, 'my');
        tbody.appendChild(row);
      });
    }

    // Update team hours table
    function updateTeamHoursTable() {
      const tbody = document.getElementById('teamHoursTableBody');
      tbody.innerHTML = '';

      // Get team members (all users except current user)
      const teamHours = hoursData.filter(record => record.userId !== currentUser);

      if (teamHours.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="no-data">
              <div>No team hours records found for the selected period</div>
            </td>
          </tr>
        `;
        return;
      }

      // Sort by date descending
      teamHours.sort((a, b) => new Date(b.date) - new Date(a.date));

      teamHours.forEach(record => {
        const row = createHoursRow(record, 'team');
        tbody.appendChild(row);
      });
    }

    // Update all hours table
    function updateAllHoursTable() {
      const tbody = document.getElementById('allHoursTableBody');
      tbody.innerHTML = '';

      if (hoursData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="no-data">
              <div>No hours records found for the selected period</div>
            </td>
          </tr>
        `;
        return;
      }

      // Sort by date descending
      hoursData.sort((a, b) => new Date(b.date) - new Date(a.date));

      hoursData.forEach(record => {
        const row = createHoursRow(record, 'all');
        tbody.appendChild(row);
      });
    }

    // Create hours table row
    function createHoursRow(record, tableType) {
      const row = document.createElement('tr');
      
      // Format date and day
      const dateObj = new Date(record.date + 'T00:00:00');
      const formattedDate = dateObj.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
      const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
      
      // Calculate working hours
      let workingHours = '-';
      let netHours = '-';
      let breakTime = '-';
      let status = 'present';
      
      if (record.loginTime && record.logoutTime) {
        try {
          const loginTime = parseTimeString(record.loginTime, record.date);
          const logoutTime = parseTimeString(record.logoutTime, record.date);
          
          if (loginTime && logoutTime) {
            const totalMs = logoutTime - loginTime;
            const totalHours = totalMs / (1000 * 60 * 60);
            
            // Calculate break time
            let breakMs = 0;
            if (record.breaks && Array.isArray(record.breaks)) {
              record.breaks.forEach(breakRecord => {
                if (breakRecord.breakOut && breakRecord.breakIn) {
                  const breakOut = parseTimeString(breakRecord.breakOut, record.date);
                  const breakIn = parseTimeString(breakRecord.breakIn, record.date);
                  if (breakOut && breakIn) {
                    breakMs += (breakIn - breakOut);
                  }
                }
              });
            }
            
            const breakHours = breakMs / (1000 * 60 * 60);
            const netHoursValue = totalHours - breakHours;
            
            workingHours = totalHours.toFixed(2) + 'h';
            breakTime = breakHours > 0 ? breakHours.toFixed(2) + 'h' : '-';
            netHours = netHoursValue.toFixed(2) + 'h';
            
            // Add overtime/undertime indicators
            if (netHoursValue > 8) {
              netHours = `<span class="overtime">${netHours} (+${(netHoursValue - 8).toFixed(2)}h)</span>`;
            } else if (netHoursValue < 8 && netHoursValue > 0) {
              netHours = `<span class="undertime">${netHours} (-${(8 - netHoursValue).toFixed(2)}h)</span>`;
            }
          }
        } catch (error) {
          console.error('Error calculating hours:', error);
        }
      } else if (record.loginTime && !record.logoutTime) {
        status = 'working';
        workingHours = 'In Progress';
      } else {
        status = record.status || 'absent';
      }

      // Get employee name
      let employeeName = record.username || 'Unknown';
      if (tableType !== 'my') {
        const user = allUsers.find(u => u.id === record.userId);
        employeeName = user ? `${user.username} (${user.empId || 'N/A'})` : 'Unknown';
      }

      // Create status badge
      let statusBadge = '';
      switch (status) {
        case 'present':
          statusBadge = `<span class="status-present">Present</span>`;
          break;
        case 'working':
          statusBadge = `<span class="status-present">Working</span>`;
          break;
        case 'absent':
          statusBadge = `<span class="status-absent">Absent</span>`;
          break;
        case 'leave':
          statusBadge = `<span class="status-leave">On Leave</span>`;
          break;
        case 'holiday':
          statusBadge = `<span class="status-holiday">Holiday</span>`;
          break;
        default:
          statusBadge = `<span class="status-absent">${status}</span>`;
      }

      // Create row HTML based on table type
      if (tableType === 'my') {
        row.innerHTML = `
          <td>${formattedDate}</td>
          <td>${dayName}</td>
          <td>${record.loginTime || '-'}</td>
          <td>${record.logoutTime || '-'}</td>
          <td>${workingHours}</td>
          <td>${breakTime}</td>
          <td>${netHours}</td>
          <td>${statusBadge}</td>
          <td>${record.remarks || '-'}</td>
        `;
      } else {
        row.innerHTML = `
          <td>${employeeName}</td>
          <td>${formattedDate}</td>
          <td>${record.loginTime || '-'}</td>
          <td>${record.logoutTime || '-'}</td>
          <td>${workingHours}</td>
          <td>${breakTime}</td>
          <td>${netHours}</td>
          <td>${statusBadge}</td>
          <td>${record.remarks || '-'}</td>
        `;
      }

      return row;
    }

    // Helper function to parse time strings
    function parseTimeString(timeStr, baseDate) {
      if (!timeStr) return null;
      
      try {
        // Handle both "HH:MM" and "HH:MM AM/PM" formats
        let timePart = timeStr;
        let period = '';
        
        if (timeStr.includes(' ')) {
          [timePart, period] = timeStr.split(' ');
        }
        
        const [hours, minutes] = timePart.split(':').map(Number);
        
        const date = new Date(baseDate);
        let hours24 = hours;
        
        // Convert to 24-hour format if period is specified
        if (period === 'PM' && hours24 !== 12) {
          hours24 += 12;
        } else if (period === 'AM' && hours24 === 12) {
          hours24 = 0;
        }
        
        date.setHours(hours24, minutes, 0, 0);
        return date;
      } catch (error) {
        console.error("Error parsing time string:", timeStr, error);
        return null;
      }
    }

    // Sidebar functionality for mobile
    document.getElementById('sidebarToggle').addEventListener('click', function() {
      document.getElementById('sidebar').classList.toggle('visible');
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.getElementById('sidebarToggle');
      
      if (window.innerWidth <= 768 && 
          sidebar.classList.contains('visible') && 
          !sidebar.contains(e.target) && 
          !toggle.contains(e.target)) {
        sidebar.classList.remove('visible');
      }
    });

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>